!function(e){var t;e.localStorage;try{var s=new Date;try{localStorage.setItem(s,s)}catch(i){if(22===i.code)throw"localstorage define error"}var n=localStorage.getItem(s)==s;if(localStorage.removeItem(s),!n)throw"localstorage define error";if("FUNCTION"!=(typeof localStorage.clear).toUpperCase())throw"localstorage define error";t=localStorage}catch(i){var o=function(){return null};t={getItem:o,setItem:o,removeItem:o,clear:o}}"function"==typeof define&&define.amd&&define("zenjs/util/local_storage",[],function(){return t}),e.YZLocalStorage=t}(window),define("wap/trade/new_order/error",["require"],function(e){function t(e,t){this.name="MyError",this.type=e,this.data=t||{},this.stack=(new Error).stack}return t.prototype=new Error,t}),window.Utils=window.Utils||{},$.extend(window.Utils,{validMobile:function(e){return e=""+e,/^((\+86)|(86))?(1)\d{10}$/.test(e)},validPhone:function(e){return e=""+e,/^0[0-9\-]{10,13}$/.test(e)},validNumber:function(e){return/^\d+$/.test(e)},validEmail:function(e){return/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i.test(e)},validPostalCode:function(e){return e=""+e,/^\d{6}$/.test(e)}}),define("wap/components/util/valid",function(){}),define("wap/trade/new_order/models/address",["require","zenjs/util/local_storage","../error","wap/components/util/valid"],function(e){var t=e("zenjs/util/local_storage"),s=e("../error");return e("wap/components/util/valid"),Backbone.Model.extend({defaults:{is_address_valid:!1,is_complete_sync:!0,is_has_address:!1,express_type:"",address:{},extra:{user_name:"",user_time:"",user_tel:""}},initialize:function(e,t){t=t||{};var s=t.isSelfFetch,i=t.isAddressRequired,n="";i&&"undefined"!=typeof s&&(n=s?"self-fetch":"express"),this.set("express_type",n);var o=t.currentAddress||{},a=t.defaultAddress||{};if(o&&o.user_name&&(this.set("is_address_valid",!0),this.set("is_has_address",!0)),"self-fetch"==n){var r={user_name:o.user_name,user_time:o.user_time,user_tel:o.user_tel};this.set("extra",r),delete o.user_name,delete o.user_time,delete o.user_tel}this.set({address:o,defaultAddress:a})},toJSON:function(){var e=_.clone(this.attributes);return e.address=$.extend({},e.address,e.extra),e},isValid:function(){var e=this.get("is_address_valid"),i=this.get("is_complete_sync"),n=this.get("is_has_address"),o=this.get("express_type"),a=this.get("extra");if(!n)throw motify.log("还没有填写地址信息哟"),new s("address",{type:"no_address"});if(!i)throw motify.log("地址提交中，请稍后再试"),new s("address",{type:"address_syncing"});if(!e)throw motify.log("请填写有效的收货地址哟"),new s("address",{type:"invalid_address"});if("self-fetch"==o){var r=a.user_name,d=a.user_tel,c=a.user_time;if(!r)throw motify.log("请填写您的姓名！"),new s("address",{type:"name"});if(!Utils.validPhone(d)&&!Utils.validMobile(d))throw motify.log("请填写正确的提货联系方式"),new s("address",{type:"phone"});if(!c)throw motify.log("请填写提货时间"),new s("address",{type:"datetime"});t.setItem("last_selffetch_user_info",JSON.stringify({user_tel:d,user_name:r}))}}})}),define("wap/trade/new_order/models/goods_list",["require","../error"],function(e){var t=e("../error");return Backbone.Model.extend({defaults:{shop_name:"",store_name:"",item_pay:0,postage:0,decrease:0,postage_info:[],msg:"",delivery_desc:[]},initialize:function(e,t){var s=t.paymentData||{},i=t.all_postage_info||{};this.set({shop_name:t.shop_name||"",store_name:t.store_name||"",item_pay:s.item_pay||0,decrease:s.decrease||0,postage:s.postage||0,delivery_desc:i.delivery_desc||[],postage_info:i.postage_items||[],msg:t.msg||"",msg_type:t.msg_type||""});var n=t.charge_price_change_result||{},o=0;n.new_pay&&(o=n.new_pay-n.origin_pay),this.set("operation_price",o);var a=new Backbone.Collection(t.items);this.set("items",a),this.msgLenLimit=250},isValid:function(){var e=this.get("msg");if(e.length>this.msgLenLimit)throw motify.log("留言字数不能超过 "+this.msgLenLimit+" 个字"),new t("goods_list",{type:"text"})},getGoodsNum:function(){var e=this.get("items");return e.length}})}),define("wap/trade/new_order/models/coupons",["require"],function(e){return Backbone.Model.extend({defaults:{coupons:[],current_coupon:{}},initialize:function(e,t){this.set({coupons:t.coupons||[],current_coupon:t.current_coupon||{},is_forbid_coupon:t.is_forbid_coupon||0})}})}),define("wap/trade/new_order/models/point",["require"],function(e){return Backbone.Model.extend({defaults:{points:0},initialize:function(e,t){this.set("points",t.points)}})}),define("wap/trade/new_order/models/ecard",["require"],function(e){return Backbone.Model.extend({defaults:{isUseEcard:!1,availableMoney:0,value:0},initialize:function(e,t){this.order_price=0,this.set({availableMoney:t.availableMoney||0,isUseEcard:t.isUseEcard||!1,value:t.value||0})},refreshEcardData:function(e){var t=this.get("availableMoney");this.order_price=e,e>t?(this.set("isUseEcard",!1),this.set("value",0)):0>=e?(this.set("isUseEcard",!1),this.set("value",0)):(this.set("isUseEcard",!0),this.set("value",e))}})}),define("wap/trade/new_order/models/send_message",["require"],function(e){return Backbone.Model.extend({defaults:{sms_switch:1},initialize:function(e,t){this.set("sms_switch",t.sms_switch)}})}),define("wap/trade/new_order/models/invalid_goods_list",["require"],function(e){return Backbone.Model.extend({defaults:{items:null},initialize:function(e,t){var s=new Backbone.Collection(t.items||[]);this.set("items",s)},getBriefData:function(){var e=this.get("items").toJSON(),t={};return t=_.map(e,function(e){return{goods_id:e.goods_id,sku_id:e.sku_id,kdt_id:e.kdt_id}})}})}),define("wap/trade/new_order/models/pay_total",["require"],function(e){return Backbone.Model.extend({defaults:{payWays:[],innerPayWays:{}},initialize:function(e,t){this.set("payWays",t.payWays),this.set("innerPayWays",t.innerPayWays)}})}),define("wap/trade/new_order/models/order",["require","./address","./goods_list","./coupons","./point","./ecard","./send_message","./invalid_goods_list","./pay_total","../error"],function(e){var t=e("./address"),s=e("./goods_list"),i=e("./coupons"),n=e("./point"),o=e("./ecard"),a=e("./send_message"),r=e("./invalid_goods_list"),d=e("./pay_total"),c=e("../error");return Backbone.Model.extend({defaults:{forbid_pay:!1,msg_data:{show_msg:"",pay_msg:""}},initialize:function(e,c){c=c||{};var l=new t({},c.address);this.set("address",l);var h=new s({},c.goods_list);this.set("goods_list",h);var p=new i({},c.coupons);this.set("coupon",p);var u=new n({},c.point);this.set("point",u);var m=new o({},c.ecard);this.set("ecard",m);var f=new a({},c.send_message);this.set("send_message",f);var g=new r({},c.invalid_goods_list);this.set("invalid_goods_list",g);var w=new d({},c.pay_total);this.set("pay_total",w)},resetShowData:function(){var e={},t=this.get("is_points"),s=this.get("goods_list"),i=s.get("item_pay"),n=s.get("postage");t?(e.total=n,e.pointPrice=s.get("pointPrice"),e.goodsPrice=0):(e.total=i+n,e.goodsPrice=i),e.postage=n,e.operationPrice=s.get("operation_price")||0,e.decrease=s.get("decrease")||0;var o=e.total-e.decrease,a=this.get("coupon"),r=a.get("current_coupon")||{},d=r.value||0;e.couponDecrease=d>o?o:d;var c=this.get("ecard"),l=c.get("isUseEcard"),h=l?c.get("value"):0;e.ecard={isUseEcard:l,ecardValue:h},this.showData=e,this.finalPrice=+e.total+e.operationPrice-e.couponDecrease-e.decrease-(h||0)},getShowData:function(){return this.showData||this.resetShowData(),this.showData},getFinalPrice:function(){return this.finalPrice},getFinalPriceWithoutEcard:function(){var e=this.get("ecard"),t=e.get("isUseEcard"),s=t?e.get("value"):0;return parseInt(this.finalPrice,10)+parseInt(s||0,10)},getOrderData:function(){var e={book_key:this.get("book_key"),bill_cart:this.get("bill_cart"),bill_data:this.get("bill_data")},t=this.get("address");e.address=t.toJSON();var s=this.get("goods_list");e.buyer_msg=s.get("msg");var i=this.get("coupon"),n=i.get("current_coupon")||{};e.coupon=n;var o=this.get("send_message");e.sms_switch=+o.get("sms_switch");var a=this.get("invalid_goods_list");return e.invalid_goods_list=a.getBriefData(),e},getPayData:function(){var e={},t=this.get("ecard"),s=t.get("isUseEcard");return e.isUseEcard=+s,e},isValidOrderData:function(){var e=this.get("address"),t=(e.isValid(),this.get("goods_list"));t.isValid();this.isValid()},isValid:function(){var e=this.get("forbid_pay"),t=this.get("msg_data");if(e)throw new c("pay_total",{msg:t.pay_msg})}})}),define("wap/trade/new_order/queue",[],function(){function e(){this.isFinished=!1,this.isQueueWalking=!1,this.offset=-1}var t=[],s=null;e.prototype={run:function(e,t){return this.offset=e||0,this.start=e,this.next(t),this},stop:function(){this.isFinished=!0},next:function(){if(!this.isFinished){var e=this;e.offset++;var s=t[e.offset];if(!s)return e.offset=-1,void(e.finished=!0);var i=s.view.queueWalk.apply(s.view,arguments);i.done(function(t){e.next(t)})}}};var i={add:function(e,s,i){i||(i=t.length-1),t.push({type:e,view:s})},trigger:function(i,n){var o=0,a=-1;if(i)for(var r in t)if(t[r].type===i){o=+r;break}s&&!s.isFinished&&(a=s.offset),-1!=a&&o>=a||(a=o,s&&s.stop(),s=null,s=new e,s.run(a,n))}};return i}),define("wap/components/address/model/address",["require","wap/components/util/valid","backbone","jquery"],function(e){e("wap/components/util/valid");var t=["&","<",">",'"',"'"],s=new RegExp(t.join("|")),i=e("backbone"),n=e("jquery");return i.Model.extend({url:"/v2/buyer/address/item.json",defaults:{tel:"",province:"",postal_code:"",county:"",city:"",area_code:"",address_detail:"",user_name:""},validate:function(e){var t=window.Utils;if(!e.user_name)return{msg:"请填写名字",name:"user_name"};if(e.user_name&&e.user_name.length>15)return{msg:"名字过长，请重新输入",name:"user_name"};if(!e.tel)return{msg:"请填写联系电话",name:"tel"};if(!t.validMobile(e.tel)&&!t.validPhone(e.tel))return{msg:"请填写正确的<br />手机号码或电话号码",name:"tel"};if(!e.address_detail)return{msg:"请填写详细地址",name:"address_detail"};if(""!==e.postal_code&&!t.validPostalCode(e.postal_code))return{msg:"邮政编码格式不正确",name:"postal_code"};var i;for(var n in e)if(i=e[n],s.test(i))return{msg:"请填写正确的内容",name:n}},update:function(e,t){return n._ajax({url:this.url,type:t||"POST",dataType:"JSON",data:e})}})}),define("wap/components/address/collection/express_address_collection",["require","wap/components/address/model/address","backbone"],function(e){var t=e("wap/components/address/model/address"),s=e("backbone");return s.Collection.extend({model:t,url:"/v2/buyer/address/list.json?kdt_id="+window._global.kdt_id,parse:function(e){var t=(e||{}).data||[];return this.total=parseInt(t.length,10),t}})}),window.Utils=window.Utils||{},$.extend(window.Utils,{makeRandomString:function(e){var t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";e=e||10;for(var i=0;e>i;i++)t+=s.charAt(Math.floor(Math.random()*s.length));return t}}),define("wap/components/util/number",function(){}),define("text!wap/components/address/templates/addressForm.html",[],function(){return'<%\n    var isNewAddress = typeof data.id === \'undefined\';\n%>\n<form class="js-address-fm address-ui address-fm">\n    <h4 class="address-fm-title">\n        <%= isNewAddress ? \'新增收货地址\' : \'编辑收货地址\' %>\n    </h4>\n    <div class="js-address-cancel cancel-img"></div>\n    <div class="block form" style="margin:0;">\n        <% if(typeof data.id !== \'undefined\') { %>\n            <input type="hidden" name="id" value="<%=data.id %>" />\n        <% } %>\n        <div class="block-item no-top-border">\n            <label>收货人</label>\n            <input type="text" name="user_name" value="<%=data.user_name %>" placeholder="名字" />\n        </div>\n        <div class="block-item">\n            <label>联系电话</label>\n            <input type="tel" name="tel" value="<%=data.tel %>" placeholder="手机或固定电话" />\n        </div>\n        <div class="block-item">\n            <label>选择地区</label>\n            <div class="js-area-select area-layout">\n                <span>\n                    <select class="js-province address-province">\n                    </select>\n                </span>\n                <span>\n                    <select class="js-city address-city">\n                    </select>\n                </span>\n                <span>\n                    <select class="js-county address-county">\n                    </select>\n                </span>\n            </div>\n        </div>\n        <div class="block-item">\n            <label>详细地址</label>\n            <input type="text" name="address_detail" value="<%=data.address_detail %>" placeholder="街道门牌，无需重复地区信息" />\n        </div>\n        <div class="block-item">\n            <label>邮政编码</label>\n            <input type="tel" maxlength="6" name="postal_code" value="<%=data.postal_code %>" placeholder="邮政编码(选填)" />\n        </div>\n    </div>\n    <div class="action-container">\n        <a class="js-address-save btn btn-block btn-green">保存</a>\n        <% if (!isNewAddress && !cannotDelete) { %>\n            <a class="js-address-delete btn btn-block btn-white">删除收货地址</a>\n        <% } %>\n    </div>\n</form>\n'}),define("zenjs/util/_",[],function(){var e={},t={},s=Array.prototype,i=Object.prototype,n=(Function.prototype,i.toString),o=s.slice,a=s.forEach,r=Object.keys,d=e.each=e.forEach=function(s,i,n){if(null!=s)if(a&&s.forEach===a)s.forEach(i,n);else if(s.length===+s.length){for(var o=0,r=s.length;r>o;o++)if(i.call(n,s[o],o,s)===t)return}else for(var d=e.keys(s),o=0,r=d.length;r>o;o++)if(i.call(n,s[d[o]],d[o],s)===t)return};return e.keys=r||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var s=[];for(var i in t)e.has(t,i)&&s.push(i);return s},e.extend=function(e){return d(o.call(arguments,1),function(t){if(t)for(var s in t)e[s]=t[s]}),e},d(["Arguments","Function","String","Number","Date","RegExp"],function(t){e["is"+t]=function(e){return n.call(e)=="[object "+t+"]"}}),e}),define("zenjs/regions/cache",["require","bower_components/ajax/ajax","jquery","../util/_","../util/local_storage"],function(e){function t(){v.preloaded={provinceList:!0,provinceCityList:!0}}function s(){i(_,function(e){v[_[e]]||(v[_[e]]={})})}function i(e,t){m.each(m.keys(e),t)}function n(e){return e.charAt(0).toUpperCase()+e.slice(1)}function o(e,t){var s=new u.Deferred;return u._ajax({url:e,dataType:"jsonp",data:t}).then(function(e){0===e.code?s.resolve(e.data):s.reject(e.msg)}).fail(function(){s.reject("fail")}),s.promise()}function a(e){if(void 0!=e){e+="";var t=e.length;return"00"==e.slice(-2)?a(e.slice(0,t-2)):e}}function r(e,t){if(void 0!=e){e+="";var s=t-e.length;if(s>0)for(;s--;)e+="0";return e}}function d(e,t){i(e,function(s){t[s]=e[s]})}function c(e,t){var s;return t=m.extend({},t),y&&y._beforeStr==e?y:(s=m.isString(e)?-1!=e.indexOf("r")?C.cacheAll(t):-1!=e.indexOf("c")?C.cacheProvinceCityList(t):C.cacheProvinceList(t):C.cacheProvinceList(t),y=s,y._beforeStr=e,s)}function l(e,t){var s,n=new u.Deferred;if(t=m.extend({},t),0>e)return[];if(void 0===e)return s=[],i(v.province_list,function(e){s.push({id:e,name:v.province_list[e]})}),n.resolve(s),n.promise();var c,l=a(e),h=[];if(e=r(e,6),c=_[Math.floor(l.length/2)],void 0===c)n.resolve(h);else if(i(v[c],function(e){e.slice(0,l.length)==l&&h.push({id:e,name:v[c][e]})}),0===h.length){var p=w.list;if(void 0!==b[e])return b[e];b[e]=n.promise(),o(p,{region_id:e,display_short_name:t["short"]||0}).then(function(e){d(e,v[c]),i(e,function(t){h.push({id:t,name:e[t]})}),n.resolve(h)}).always(function(){delete b[e]})}else n.resolve(h);return n.promise()}function h(e,t){return t=m.extend({},t),y?y.then(function(){return l(e,t)}):l(e,t)}function p(e){var t;for(var s in v)t||(t=v[s][e]);return t}e("bower_components/ajax/ajax");var u=e("jquery"),m=e("../util/_"),f=e("../util/local_storage"),g=window._global.url.www+"/common/region",w={cityList:"/cityList.jsonp",countyList:"/countyList.jsonp",provinceList:"/provinceList.jsonp",provinceCityList:"/provinceCityList.jsonp",list:"/list.jsonp",all:"/all.jsonp"},_=["province_list","city_list","county_list"],v={province_list:{110000:"北京市",120000:"天津市",130000:"河北省",140000:"山西省",150000:"内蒙古自治区",210000:"辽宁省",220000:"吉林省",230000:"黑龙江省",310000:"上海市",320000:"江苏省",330000:"浙江省",340000:"安徽省",350000:"福建省",360000:"江西省",370000:"山东省",410000:"河南省",420000:"湖北省",430000:"湖南省",440000:"广东省",450000:"广西壮族自治区",460000:"海南省",500000:"重庆市",510000:"四川省",520000:"贵州省",530000:"云南省",540000:"西藏自治区",610000:"陕西省",620000:"甘肃省",630000:"青海省",640000:"宁夏回族自治区",650000:"新疆维吾尔自治区",710000:"台湾省",810000:"香港特别行政区",820000:"澳门特别行政区"},city_list:{110100:"北京市",110200:"县",120100:"天津市",120200:"县",130100:"石家庄市",130200:"唐山市",130300:"秦皇岛市",130400:"邯郸市",130500:"邢台市",130600:"保定市",130700:"张家口市",130800:"承德市",130900:"沧州市",131000:"廊坊市",131100:"衡水市",140100:"太原市",140200:"大同市",140300:"阳泉市",140400:"长治市",140500:"晋城市",140600:"朔州市",140700:"晋中市",140800:"运城市",140900:"忻州市",141000:"临汾市",141100:"吕梁市",150100:"呼和浩特市",150200:"包头市",150300:"乌海市",150400:"赤峰市",150500:"通辽市",150600:"鄂尔多斯市",150700:"呼伦贝尔市",150800:"巴彦淖尔市",150900:"乌兰察布市",152200:"兴安盟",152500:"锡林郭勒盟",152900:"阿拉善盟",210100:"沈阳市",210200:"大连市",210300:"鞍山市",210400:"抚顺市",210500:"本溪市",210600:"丹东市",210700:"锦州市",210800:"营口市",210900:"阜新市",211000:"辽阳市",211100:"盘锦市",211200:"铁岭市",211300:"朝阳市",211400:"葫芦岛市",220100:"长春市",220200:"吉林市",220300:"四平市",220400:"辽源市",220500:"通化市",220600:"白山市",220700:"松原市",220800:"白城市",222400:"延边朝鲜族自治州",230100:"哈尔滨市",230200:"齐齐哈尔市",230300:"鸡西市",230400:"鹤岗市",230500:"双鸭山市",230600:"大庆市",230700:"伊春市",230800:"佳木斯市",230900:"七台河市",231000:"牡丹江市",231100:"黑河市",231200:"绥化市",232700:"大兴安岭地区",310100:"上海市",310200:"县",320100:"南京市",320200:"无锡市",320300:"徐州市",320400:"常州市",320500:"苏州市",320600:"南通市",320700:"连云港市",320800:"淮安市",320900:"盐城市",321000:"扬州市",321100:"镇江市",321200:"泰州市",321300:"宿迁市",330100:"杭州市",330200:"宁波市",330300:"温州市",330400:"嘉兴市",330500:"湖州市",330600:"绍兴市",330700:"金华市",330800:"衢州市",330900:"舟山市",331000:"台州市",331100:"丽水市",340100:"合肥市",340200:"芜湖市",340300:"蚌埠市",340400:"淮南市",340500:"马鞍山市",340600:"淮北市",340700:"铜陵市",340800:"安庆市",341000:"黄山市",341100:"滁州市",341200:"阜阳市",341300:"宿州市",341500:"六安市",341600:"亳州市",341700:"池州市",341800:"宣城市",350100:"福州市",350200:"厦门市",350300:"莆田市",350400:"三明市",350500:"泉州市",350600:"漳州市",350700:"南平市",350800:"龙岩市",350900:"宁德市",360100:"南昌市",360200:"景德镇市",360300:"萍乡市",360400:"九江市",360500:"新余市",360600:"鹰潭市",360700:"赣州市",360800:"吉安市",360900:"宜春市",361000:"抚州市",361100:"上饶市",370100:"济南市",370200:"青岛市",370300:"淄博市",370400:"枣庄市",370500:"东营市",370600:"烟台市",370700:"潍坊市",370800:"济宁市",370900:"泰安市",371000:"威海市",371100:"日照市",371200:"莱芜市",371300:"临沂市",371400:"德州市",371500:"聊城市",371600:"滨州市",371700:"菏泽市",410100:"郑州市",410200:"开封市",410300:"洛阳市",410400:"平顶山市",410500:"安阳市",410600:"鹤壁市",410700:"新乡市",410800:"焦作市",410900:"濮阳市",411000:"许昌市",411100:"漯河市",411200:"三门峡市",411300:"南阳市",411400:"商丘市",411500:"信阳市",411600:"周口市",411700:"驻马店市",419000:"省直辖县级行政区划",420100:"武汉市",420200:"黄石市",420300:"十堰市",420500:"宜昌市",420600:"襄阳市",420700:"鄂州市",420800:"荆门市",420900:"孝感市",421000:"荆州市",421100:"黄冈市",421200:"咸宁市",421300:"随州市",422800:"恩施土家族苗族自治州",429000:"省直辖县级行政区划",430100:"长沙市",430200:"株洲市",430300:"湘潭市",430400:"衡阳市",430500:"邵阳市",430600:"岳阳市",430700:"常德市",430800:"张家界市",430900:"益阳市",431000:"郴州市",431100:"永州市",431200:"怀化市",431300:"娄底市",433100:"湘西土家族苗族自治州",440100:"广州市",440200:"韶关市",440300:"深圳市",440400:"珠海市",440500:"汕头市",440600:"佛山市",440700:"江门市",440800:"湛江市",440900:"茂名市",441200:"肇庆市",441300:"惠州市",441400:"梅州市",441500:"汕尾市",441600:"河源市",441700:"阳江市",441800:"清远市",441900:"东莞市",442000:"中山市",445100:"潮州市",445200:"揭阳市",445300:"云浮市",449900:"东沙群岛",450100:"南宁市",450200:"柳州市",450300:"桂林市",450400:"梧州市",450500:"北海市",450600:"防城港市",450700:"钦州市",450800:"贵港市",450900:"玉林市",451000:"百色市",451100:"贺州市",451200:"河池市",451300:"来宾市",451400:"崇左市",460100:"海口市",460200:"三亚市",460300:"三沙市",469000:"省直辖县级行政区划",500100:"重庆市",500200:"县",510100:"成都市",510300:"自贡市",510400:"攀枝花市",510500:"泸州市",510600:"德阳市",510700:"绵阳市",510800:"广元市",510900:"遂宁市",511000:"内江市",511100:"乐山市",511300:"南充市",511400:"眉山市",511500:"宜宾市",511600:"广安市",511700:"达州市",511800:"雅安市",511900:"巴中市",512000:"资阳市",513200:"阿坝藏族羌族自治州",513300:"甘孜藏族自治州",513400:"凉山彝族自治州",520100:"贵阳市",520200:"六盘水市",520300:"遵义市",520400:"安顺市",520500:"毕节市",520600:"铜仁市",522300:"黔西南布依族苗族自治州",522600:"黔东南苗族侗族自治州",522700:"黔南布依族苗族自治州",530100:"昆明市",530300:"曲靖市",530400:"玉溪市",530500:"保山市",530600:"昭通市",530700:"丽江市",530800:"普洱市",530900:"临沧市",532300:"楚雄彝族自治州",532500:"红河哈尼族彝族自治州",532600:"文山壮族苗族自治州",532800:"西双版纳傣族自治州",532900:"大理白族自治州",533100:"德宏傣族景颇族自治州",533300:"怒江傈僳族自治州",533400:"迪庆藏族自治州",540100:"拉萨市",542100:"昌都地区",542200:"山南地区",542300:"日喀则地区",542400:"那曲地区",542500:"阿里地区",542600:"林芝地区",610100:"西安市",610200:"铜川市",610300:"宝鸡市",610400:"咸阳市",610500:"渭南市",610600:"延安市",610700:"汉中市",610800:"榆林市",610900:"安康市",611000:"商洛市",620100:"兰州市",620200:"嘉峪关市",620300:"金昌市",620400:"白银市",620500:"天水市",620600:"武威市",620700:"张掖市",620800:"平凉市",620900:"酒泉市",621000:"庆阳市",621100:"定西市",621200:"陇南市",622900:"临夏回族自治州",623000:"甘南藏族自治州",630100:"西宁市",630200:"海东市",632200:"海北藏族自治州",632300:"黄南藏族自治州",632500:"海南藏族自治州",632600:"果洛藏族自治州",632700:"玉树藏族自治州",632800:"海西蒙古族藏族自治州",640100:"银川市",640200:"石嘴山市",640300:"吴忠市",640400:"固原市",640500:"中卫市",650100:"乌鲁木齐市",650200:"克拉玛依市",652100:"吐鲁番地区",652200:"哈密地区",652300:"昌吉回族自治州",652700:"博尔塔拉蒙古自治州",652800:"巴音郭楞蒙古自治州",652900:"阿克苏地区",653000:"克孜勒苏柯尔克孜自治州",653100:"喀什地区",653200:"和田地区",654000:"伊犁哈萨克自治州",654200:"塔城地区",654300:"阿勒泰地区",659000:"自治区直辖县级行政区划",710100:"台北市",710200:"高雄市",710300:"台南市",710400:"台中市",710500:"金门县",710600:"南投县",710700:"基隆市",710800:"新竹市",710900:"嘉义市",711100:"新北市",711200:"宜兰县",711300:"新竹县",711400:"桃园县",711500:"苗栗县",711700:"彰化县",711900:"嘉义县",712100:"云林县",712400:"屏东县",712500:"台东县",712600:"花莲县",712700:"澎湖县",712800:"连江县",810100:"香港岛",810200:"九龙",810300:"新界",820100:"澳门半岛",820200:"离岛"}};t(),s(),setTimeout(function(){var e=f.getItem("address_data");e&&(v=JSON.parse(e),t(),s())},0);var y,C={},b={};return i(w,function(e){w[e]=g+w[e],-1!=["provinceList","provinceCityList","all"].indexOf(e)&&(C["cache"+n(e)]=function(t){return v.preloaded[e]?u.Deferred().resolve(v):(t=m.extend({},t),o(w[e],{display_short_name:t["short"]||0}).then(function(t){return m.extend(v,"provinceList"==e?{province_list:t}:t),u.Deferred().resolve(v)}))})}),{preload:c,loadList:h,getNameById:p}}),define("zenjs/regions/selector",["require","../util/_","./cache","jquery"],function(e){var t=e("../util/_"),s=e("./cache"),i=e("jquery"),n=function(e){t.extend(this,e),this.selects=["province","city","county"],this.selectsDefault={province:e.province_text||"选择省份",city:e.city_text||"选择城市",county:e.county_text||"选择地区"},this.init(),this.lastPromise=new i.Deferred};return n.prototype={init:function(){var e=this;this.selects.forEach(function(t){e[t]&&e[t].html(e.createDefault(e.selectsDefault[t]))}),s.preload("p",{"short":this["short"]}),this.selectPromise=this.resetSelect("province"),this.province.on("change",function(){var t=i(this).val();e.onProvinceChange&&e.onProvinceChange(t),e.lastPromise=e.resetSelect("city",t,{loading:!0}).then(function(){e.city.trigger("change",{auto:!0})})}),this.city.on("change",function(){var t=i(this).val();e.lastPromise=e.resetSelect("county",t,{loading:!0}).then(function(){e.county.trigger("change",{auto:!0})})}),this.ip2address&&setTimeout(function(){e.hasCalledSelectFun||e.getIp2AddressData()},0)},createDefault:function(e){return'<option value="-1">'+e+"</option>"},createOption:function(e,t){return"<option value="+t+">"+e+"</option>"},resetSelect:function(e,t,i){var n=this[e],o=this;return n?(-1==t&&n.html(o.createDefault(o.selectsDefault[e])),i=i||{},i.loading&&n.attr("disabled",!0).html(o.createDefault("加载中...")),s.loadList(t,{"short":this["short"]}).then(function(t){var s="";("province"==e||0==t.length)&&(s=o.createDefault(o.selectsDefault[e])),t.forEach(function(e){s+=o.createOption(e.name,e.id)}),n.removeAttr("disabled").html(s)})):void 0},select:function(e){if(null!=e&&/\d{6}/.test(e)){e+="",this.hasCalledSelectFun=!0;var t=this,s=this.selectOption;this.selectPromise.then(function(){var i=e.slice(0,2)+"0000";return s(t.province,i),t.resetSelect("city",i)}).then(function(){var i=e.slice(0,4)+"00";return s(t.city,i),"00"==e.slice(2,4)&&(i=t.city.find("option:selected").val()),t.resetSelect("county",i)}).then(function(){s(t.county,e)})}},selectOption:function(e,t){var s=!1;e.find("option").each(function(){s=s||i(this).val()==t});var n=i(e.find("option")[0]).val()||"-1";e.val(s?t:n)},getNames:function(){var e=this,t={};return this.selects.forEach(function(s){t[s]=e[s].find("option:selected").text()}),t},getValues:function(){var e=this,t={};return this.selects.forEach(function(s){t[s]=e[s].find("option:selected").val()}),t},getLastPromise:function(){return this.lastPromise},getIp2AddressData:function(){var e=this;i._ajax({url:window._global.url.www+"/common/region/addressByIp.jsonp",dataType:"jsonp"}).then(function(t){if(!e.hasCalledSelectFun&&t&&0==t.code&&t.data){var s=e.getValues();if(!s||6!=(s.province_id+"").length){var i=t.data;i.county_id?e.select(i.county_id):i.city_id?e.select(i.city_id):i.province_id&&e.select(i.province_id)}}})}},n}),define("wap/components/address/views/logistics_address_edit",["require","wap/components/util/number","wap/components/address/model/address","text!wap/components/address/templates/addressForm.html","zenjs/regions/selector","backbone","underscore","jquery"],function(e){e("wap/components/util/number");var t=e("wap/components/address/model/address"),s=e("text!wap/components/address/templates/addressForm.html"),i=e("zenjs/regions/selector"),n=e("backbone"),o=e("underscore"),a=e("jquery"),r=window.motify,d=function(){};return n.View.extend({template:o.template(s),initialize:function(e){this.ajaxType=e.type,this.model=e.model?e.model:new t,this.doNotSavetoServer=e.doNotSavetoServer,this.cannotDelete=e.cannotDelete,this.onCancelAddAddress=o(function(t){e.onHide(),(e.onCancelAddAddress||d)(t)}).bind(this),this.onFinishEditAddress=o(function(t,s){s=s||{},e.onHide(),(e.onFinishEditAddress||d)(t,{address_model:s.model,autoPopup:this.autoPopup})}).bind(this),this.autoPopup=e.autoPopup===!0,this.listenTo(this.model,"invalid",this.error)},events:{"click .js-address-cancel":"onCancelAddress","click .js-address-save":"onSaveClicked","click .js-address-delete":"onDeleteClicked","focus input":"onInputKeyUp",'blur input[name="tel"]':"onCheckPhoneFormat"},render:function(){return this.$el.html(this.template({data:this.model.toJSON(),cannotDelete:this.cannotDelete})),this.areaElement={province:this.$(".js-province"),city:this.$(".js-city"),county:this.$(".js-county"),ip2address:!0},this.areaBrainView=new i(this.areaElement),this.areaBrainView.select(this.model.get("area_code")),"ios"==window._global.mobile_system&&this.$("select").on("touchend",function(e){e.stopPropagation()}),this},onSaveClicked:function(){var e=function(e,t,s){r.log("请选择 "+t),e.addClass("c-red"),e.one("click",function(t){e.removeClass("c-red")}),s.address_token=window._global.address_token,s.ua=navigator.userAgent,s.countyhtml=(this.areaElement.county.html()||"").slice(0,550),s.selectedData=this.areaBrainView.getNames(),a._ajax({url:"/v2/trade/common/log.json",type:"POST",dataType:"json",data:a.extend({},s,{error_type:"area_sel"})})};return function(){var t=this,s=a("[name=id]",this.$el),i=this.model.attributes;if(this.$("input").blur(),o.each(i,function(e,s){t.model.set(s,a.trim(a("[name="+s+"]",t.$el).val())||"")}),this.model.set("id",s.length>0?s.val():""),this.model.isValid()){var n=this.areaBrainView.getValues(),d=this.areaBrainView.getNames(),c=a.extend({},this.model.toJSON(),n);if(-1==n.province||"选择省份"==n.province)return void e.call(this,this.areaElement.province,"省份",c);if(-1==n.city||"选择城市"==n.city)return void e.call(this,this.areaElement.city,"城市",c);if(-1==n.county||"选择地区"==n.county)return void e.call(this,this.areaElement.county,"区县",c);if(this.model.set("area_code",n.county),this.model.set(d),this.doNotSavetoServer)return void this.onFinishEditAddress(!1,{model:this.model});this.model.update(i,this.ajaxType).done(function(e){var s=JSON.parse(e);0==s.code?(s.data.id!==!0&&1!==s.data.id&&t.model.set("id",s.data.id),t.onFinishEditAddress(!1,{model:t.model}),r.log(s.msg)):r.log(s.msg||"更新收货地址失败")}).fail(function(){r.log("更新收货地址失败")})}else{var l=this.model.validationError;this.addErrorColor(a("[name="+l.name+"]",this.$el))}}}(),onCancelAddress:function(){confirm("确定要放弃此次编辑嘛？")&&this.onCancelAddAddress({autoPopup:this.autoPopup})},onDeleteClicked:function(e){if(e.stopPropagation(),confirm("确定要删除这个收货地址么？")){var t=a("[name=id]",this.$el).val();this.model.destroy({processData:!0,data:{id:t},wait:!0,success:o(function(e,t,s){return t=t||{},this.onFinishEditAddress(!0),!0}).bind(this),error:function(){r.log("删除失败。。。")}})}},onCheckPhoneFormat:function(e){var t=a(e.target).val(),s=t.indexOf("-")>-1?t.split("-").join(""):t;a(e.target).val(s)},onInputKeyUp:function(e){this.clearErrorColor(a(e.target))},clearErrorColor:function(e){e.css({color:"black"})},addErrorColor:function(e){e.css({color:"red"})},error:function(e,t){if("area_code"==t.name)return void this.areaBrainView.isValid();r.log(t.msg);var s=this.$el.find('input[name="'+t.name+'"]');s.addClass("c-red").one("click input",function(e){s.removeClass("c-red")})}})}),define("zenjs/backbone/base_view",["require","backbone","../core/trigger_method"],function(e){var t=e("backbone"),s=e("../core/trigger_method");return t.View.extend({clean:function(){return this.stopListening(),this},triggerMethod:s})}),define("bower_components/zenlist/list",["require","exports","module","zenjs/backbone/base_view"],function(e,t,s){var i=function(){},n=e("zenjs/backbone/base_view");s.exports=n.extend({initialize:function(e){return this.options=e=e||{},this.items=[],this.itemView=e.itemView,this.itemOptions=e.itemOptions||{},this.collection=e.collection,this.onAfterListChange=e.onAfterListChange||i,this.onAfterListLoad=e.onAfterListLoad||i,this.onAfterListDisplay=e.onAfterListDisplay||i,this.onListEmpty=e.onListEmpty||e.onEmptyList||this._onListEmpty,this.onItemClick=e.onItemClick||i,this.onViewItemAdded=e.onViewItemAdded||i,this.displaySize=e.displaySize||-1,this.emptyHTML=e.emptyHTML||"",this.emptyText=e.emptyText||"列表为空",this},render:function(e){return this.displaySize=-1==(e||{}).displaySize?-1:this.displaySize,this.clean(),this._setupListeners(),this.addAll(),this.onAfterListDisplay({list:this.collection}),this},fetchRender:function(e){return this.collection.fetch({data:e,success:_(function(e,t){this.render(),this.onAfterListLoad(this.collection,t),this.onFetchSuccess&&this.onFetchSuccess()}).bind(this),error:_.bind(function(){this.onAfterListLoad(this.collection,response)},this)}),this},_setupListeners:function(){this.collection&&(this.stopListening(this.collection),this.listenTo(this.collection,"add",this.addItem,this),this.listenTo(this.collection,"reset sort",this.render,this),this.listenTo(this.collection,"remove",this.onItemRemoved,this))},addItemListeners:function(e){var t=this;this.listenTo(e,"all",function(){var t="item:"+arguments[0],s=_.toArray(arguments);s.splice(0,1),s.unshift(t,e),this.trigger.apply(this,s),"item:click"==t&&this.onItemClick()}),this.listenTo(e.model,"change",function(){t.onAfterListChange({list:this.collection})})},addAll:function(){0===this.collection.length?this.fetching||this.triggerMethod("list:empty"):this.collection.each(function(e){this.addItem(e)},this)},removeAll:function(){for(var e=this.items.length-1;e>=0;e--)this.removeView(this.items[e]);
this.onAfterListChange({list:this.collection})},addItem:function(e,t,s){if(!(this.displaySize>=0&&this.items.length>=this.displaySize)){1==this.collection.length&&(this.listEl||this.$el).html("");var i=new this.itemView(_.extend({},this.options.itemOptions,{model:e,index:this.collection.indexOf(e)}));this.items.push(i),this.addItemListeners(i),i.render(),this.onViewItemAdded({list:this.items,viewItem:i,model:e});var n=(s||{}).at;return 0===n?(this.listEl||this.$el).prepend(i.el):(this.listEl||this.$el).append(i.el),i}},removeItem:function(e){var t=this.getViewByModel(e);t&&this.removeView(t)},removeView:function(e){var t;this.stopListening(e),e&&(this.stopListening(e.model),e.remove(),t=this.items.indexOf(e),this.items.splice(t,1)),0===this.collection.length&&(this.fetching||this.triggerMethod("list:empty"))},onItemRemoved:function(e){this.onAfterListChange({list:this.collection,action:"remove",model:e}),this.removeItem(e)},getViewByModel:function(e){return _.find(this.items,function(t,s){return t.model===e})},dispatchEventToAllViews:function(e,t){for(var s=this.items.length-1;s>=0;s--)this.items[s].trigger(e,t)},remove:function(){n.prototype.remove.call(this,arguments),this.removeAll(),this.collection.reset(),delete this.collection},clean:function(){n.prototype.clean.call(this,arguments),this.removeAll(),(this.listEl||this.$el).html(""),this.stopListening(this.collection)},_onListEmpty:function(){this.$el.html(this.emptyHTML||(this.emptyText?'<p style="text-align:center;line-height:60px;">'+this.emptyText+"</p>":""))}})}),define("text!wap/components/address/templates/addressItem.html",[],function(){return'<div>\n    <div class="icon-check"></div>\n    <p>\n        <% if (typeof data.distance !== \'undefined\' && data.distance !== -1) { %>\n            <span class="address-name" style="margin-right: 5px;"><%= data.name %></span>, \n            <span class="address-distance">约<%= data.distance > 1000 ? (data.distance / 1000).toFixed(2) + \'km\' : data.distance + \'m\' %></span>\n        <% } else if (typeof(data.name) !== \'undefined\') { %>\n            <span class="address-name" style="margin-right: 5px;"><%= data.name %></span>, \n            <span class="address-tel"><%= data.tel %></span>\n        <% } else if (typeof(data.user_name) !== \'undefined\') { %>\n            <span class="address-name" style="margin-right: 5px;"><%= data.user_name %></span>, \n            <span class="address-tel"><%= data.tel %></span>\n        <% } %>\n    </p>\n    <span class="address-str address-str-sf">收货地址：<%= data.province %><%= data.city %><%= data.county %><%= data.address_detail %></span>\n    <div class="address-opt <% if( data.address_type==\'express\'){ %> js-edit-address <% } %>">\n        <% if( data.address_type==\'express\'){ %>\n            <i class="icon-circle-info"></i>\n        <% } %>\n    </div>\n</div>\n'}),define("zenjs/util/number",[],function(){var e={makeRandomString:function(e){var t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";e=e||10;for(var i=0;e>i;i++)t+=s.charAt(Math.floor(Math.random()*s.length));return t}};return e}),define("bower_components/pop/pop",["require","zenjs/events","zenjs/util/number"],function(e){var t=function(){},s=e("zenjs/events"),i=e("zenjs/util/number");window.zenjs=window.zenjs||{};var n=s.extend({init:function(e){this._window=$(window);var s=i.makeRandomString();$("body").append('<div id="'+s+'"                 style="display:none; height: 100%;                 position: fixed; top: 0; left: 0; right: 0;                background-color: rgba(0, 0, 0, '+(e.transparent||".9")+');z-index:1000;opacity:0;transition: opacity ease 0.2s;"></div>'),this.nBg=$("#"+s),this.nBg.on("click",$.proxy(function(){this.isCanNotHide||this.hide()},this));var n=i.makeRandomString();$("body").append('<div id="'+n+'" class="'+(e.className||"")+'" style="overflow:hidden;visibility: hidden;"></div>'),this.nPopContainer=$("#"+n),this.nPopContainer.hide(),this.nPopContainer.css({opacity:0,position:"absolute","z-index":1e3}),e.contentViewClass&&(this.contentViewClass=e.contentViewClass,this.contentViewOptions=$.extend({el:this.nPopContainer},e.contentViewOptions||{}),this.contentView=new this.contentViewClass($.extend({onHide:$.proxy(this.hide,this)},this.contentViewOptions)),this.contentView.onHide=$.proxy(this.hide,this)),this.animationTime=e.animationTime||300,this.isCanNotHide=e.isCanNotHide,this.doNotRemoveOnHide=e.doNotRemoveOnHide||!1,this.onShow=e.onShow||t,this.onHide=e.onHide||t,this.onFinishHide=e.onFinishHide||t,this.html=e.html},render:function(e){return this.renderOptions=e||{},this.contentViewClass?this.contentView.render(this.renderOptions):this.html&&this.nPopContainer.html(this.html),this},show:function(){return this.nBg.show().css({opacity:"1","transition-property":"none"}),this.nPopContainer.show(),this.trigger("pop:show:before"),setTimeout($.proxy(function(){this.trigger("pop:show:after"),this.nPopContainer.show().css("visibility","visible"),this._doShow&&this._doShow(),this.onShow()},this),200),this},hide:function(e){e=e||{};var t=e.doNotRemove||this.doNotRemoveOnHide||!1;this._doHide&&this._doHide(),this.trigger("pop:hide:before"),setTimeout($.proxy(function(){this.nBg.css({opacity:0,"transition-property":"opacity"}),this.trigger("pop:hide:after"),setTimeout($.proxy(function(){this.nBg.hide(),this.nPopContainer.hide(),t||this.destroy()},this),200)},this),this.animationTime),this.onHide()},destroy:function(){return this.nPopContainer.remove(),this.nBg.remove(),this.contentView&&this.contentView.remove(),this}});return n}),define("bower_components/pop/pop_forbid_scroll",["require","./pop"],function(e){window.zenjs=window.zenjs||{};var t=e("./pop"),s=t.extend({init:function(e){this._super(e),this.on("pop:show:before",$.proxy(this.onBeforePopShow,this)),this.on("pop:show:after",$.proxy(this.onAfterPopShow,this)),this.on("pop:hide:after",$.proxy(this.onAfterPopHide,this))},onBeforePopShow:function(){this.top=this._window.scrollTop()},onAfterPopShow:function(){this._window.scrollTop(0),this.startShow()},onAfterPopHide:function(){var e,t=function(s){return e!==this._window.scrollTop()&&s>0?(this._window.scrollTop(e),void setTimeout($.proxy(t,this,s-1))):void setTimeout($.proxy(this.onFinishHide,this),50)};return function(){this.startHide(),e=this.top,this._window.scrollTop(e),$.proxy(t,this)(2),setTimeout($.proxy(function(){window.zenjs.popList.length<1&&$("html").css("position",this.htmlPosition)},this),200)}}(),startShow:function(){var e=window.zenjs.popList;if(e||(e=window.zenjs.popList=[]),0===e.length){var t=$("body"),s=$("html");this.htmlPosition=s.css("position"),s.css("position","relative"),this.bodyCss=(t.prop("style")||{}).cssText,this.htmlCss=(s.prop("style")||{}).cssText,$("body,html").css({overflow:"hidden",height:this._window.height()})}e.indexOf(this)<0&&e.push(this)},startHide:function(){var e=window.zenjs.popList,t=e.indexOf(this);t>-1&&e.splice(t,1),e.length<1&&($("html").attr("style",this.htmlCss||""),$("body").attr("style",this.bodyCss||""))}});return s}),define("bower_components/pop/popup",["require","./pop_forbid_scroll"],function(e){var t=e("./pop_forbid_scroll"),s=t.extend({init:function(e){this._super(e),this.onClickBg=e.onClickBg||function(){},this.onBeforePopupShow=e.onBeforePopupShow||function(){},this.onAfterPopupHide=e.onAfterPopupHide||function(){},this.nPopContainer.css(_.extend({left:0,right:0,bottom:0,background:"white"},e.containerCss||{})),this.nPopContainer.css("opacity","0"),this.nPopContainer.on("focus","input, textarea",function(e){var t=$(this),s=$(window),i=s.scrollTop(),n=t.offset().top;(0>n-i||n-i>100)&&setTimeout(function(){var e=n-70;s.scrollTop(e)},150)})},_doShow:function(){this.contentView&&this.contentView.height?this.height=this.contentView.height():this.contentView||(this.height=this.nPopContainer.height()),this.onBeforePopupShow(),$(".js-close").click($.proxy(function(e){this.hide()},this)),this.nPopContainer.addClass("popup"),this.nPopContainer.css({height:this.height+"px",transform:"translate3d(0,100%,0)","-webkit-transform":"translate3d(0,100%,0)"}),this.bodyPadding=$("body").css("padding"),$("body").css("padding","0px"),setTimeout($.proxy(function(){this.nPopContainer.css({transform:"translate3d(0,0,0)","-webkit-transform":"translate3d(0,0,0)","-webkit-transition":"all ease "+this.animationTime+"ms",transition:"all ease "+this.animationTime+"ms",opacity:1})},this)),setTimeout($.proxy(function(){this.contentView&&this.contentView.onAfterPopupShow&&this.contentView.onAfterPopupShow()},this),this.animationTime)},_doHide:function(e){this.nPopContainer.css({transform:"translate3d(0,100%,0)","-webkit-transform":"translate3d(0,100%,0)",opacity:0}),setTimeout($.proxy(function(){$("body").css("padding",this.bodyPadding),this.onAfterPopupHide()},this),this.animationTime)}});return s}),define("wap/components/address/views/logistics_address_list",["require","backbone","underscore","jquery","wap/components/address/model/address","wap/components/address/views/logistics_address_edit","bower_components/zenlist/list","text!wap/components/address/templates/addressItem.html","bower_components/pop/popup"],function(e){var t=e("backbone"),s=e("underscore"),i=e("jquery"),n=e("wap/components/address/model/address"),o=e("wap/components/address/views/logistics_address_edit"),a=e("bower_components/zenlist/list"),r=e("text!wap/components/address/templates/addressItem.html"),d=e("bower_components/pop/popup"),c=function(){},l=t.View.extend({initialize:function(e){this.addressType=e.addressType||"self-fetch",this.template=s.template(e.itemTemplateHtml||""),this.onItemClick=e.onItemClick||c,this.onAddressDelete=e.onAddressDelete||c,this.highLightItem=e.highLightItem||c},className:function(){var e="js-address-item block-item ";return e+(this.model.get("selected")||"")},id:function(){return"js-address-item-"+this.model.get("id")},events:{"click .js-edit-address":"onEditClicked",click:"onClick"},onClick:function(e){var t=i(e.target);t.hasClass("js-edit-address")||t.hasClass("icon_circle-info")||this.onItemClick({address:this.model.toJSON(),addressType:this.addressType})},onEditClicked:function(){var e=function(e){return e?void this.onAddressDelete(this.model.toJSON()):(this.render(),void this.highLightItem())};return function(t){t.preventDefault(),t.stopImmediatePropagation(),new d({contentViewClass:o,isCanNotHide:!0,contentViewOptions:{onFinishEditAddress:s(e).bind(this),model:this.model,type:"PUT"},containerCss:{bottom:0,left:0,right:0,background:"white"}}).render().show()}}(),render:function(){return this.$el.html(this.template({data:s.extend(this.model.toJSON(),{address_type:this.addressType})})),this}});return t.View.extend({initialize:function(e){this.template=s.template(e.templateHtml||""),this.autoPopup=e.autoPopup,this.selectedAddress=e.selectedAddress,this.positionData=e.positionData||{},this.cityData=e.cityData||{},this.emptyText=e.emptyText||"列表为空",this._doHide=function(){e.onHide()},this.onAddressChange=e.onAddressChange||c,this.onAddressDelete=e.onAddressDelete||c,this.onListChange=e.onListChange||c,this.onCancel=e.onCancel||c,e.collection.comparator=e.comparator||function(e,t){return t.id-e.id},this.listOpt={itemView:l,finishedHTML:" ",collection:e.collection,itemOptions:{addressType:e.addressType,itemTemplateHtml:r,onItemClick:s(this.onItemClick).bind(this),onAddressDelete:s(this._onAddressDelete).bind(this),highLightItem:s(this.highLight).bind(this)},onAfterListDisplay:s(this.onAfterListDisplay).bind(this),onAfterListChange:s(this.onAfterListChange).bind(this),emptyText:this.emptyText}},events:{"click .js-cancel":"onCancelClicked","click .js-add-address":"onAddAddressClicked"},onAfterListChange:function(e){this.onAfterListDisplay(e),this.onListChange()},onAfterListDisplay:function(){this.highLight(this.selectedAddress)},onItemClick:function(e){this.hide(),this.onAddressChange(e),this.selectedAddress=e.address},_onAddressDelete:function(e){this.onAddressDelete(e)},onCancelClicked:function(e){this.onCancel(),this.hide()},onAddAddressClicked:function(){var e=function(e,t){t&&(this.collection.add(t.address_model),this.selectedAddress=t.address_model,this.onAddressChange({address:t.address_model.toJSON()}),t.autoPopup?this.hide():this.render().show())},t=function(e){0===this.listOpt.collection.length?this.hide():this._doShow()};return function(i){new d({contentViewClass:o,isCanNotHide:!0,contentViewOptions:{onFinishEditAddress:s(e).bind(this),onCancelAddAddress:s(t).bind(this),type:"POST",autoPopup:(i||{}).autoPopup,model:i.selectedAddress?new n(i.selectedAddress):null,cannotDelete:i.cannotDelete},containerCss:{bottom:0,left:0,right:0,background:"white"}}).render().show()}}(),render:function(){return this.$el.html(this.template()),this.listOpt.el=this.$(".js-address-container"),this.addressListView=new a(this.listOpt),this.addressListView.render(),this},show:function(e){e=e||{},this._doShow(e.selectedAddress),0===this.listOpt.collection.length&&this.onAddAddressClicked(s.extend(e,{cannotDelete:!0,autoPopup:!0}))},highLight:function(e){var t=e||this.selectedAddress||{};this.$(".icon-check").removeClass("icon-checked"),this.$("#js-address-item-"+t.id).find(".icon-check").addClass("icon-checked")},_doShow:function(e){this.highLight(e),t.EventCenter.trigger("address_list:show")},hide:function(e){this._doHide(),t.EventCenter.trigger("address_list:hide")}})}),window.Utils=window.Utils||{},$.extend(window.Utils,{getRecentlyUsedAddress:function(){var e=null;if(window.localStorage){var t=$.trim(window.localStorage.getItem("recently_used_address"));if(-1!==t.indexOf("undefined")&&(window.localStorage.removeItem("recently_used_address"),t=""),t)try{e=$.parseJSON(t)}catch(s){}}return e},saveLastUsedAddress:function(e){if(!e||!e.user_name)return!1;var t=JSON.stringify(e);if(window.localStorage)try{window.localStorage.setItem("recently_used_address",t)}catch(s){}},deleteLastUsedAddress:function(){if(window.localStorage)try{window.localStorage.removeItem("recently_used_address")}catch(e){}},wx2KdtAddress:function(e){if(!e)return null;if(!e.userName&&e.user_name)return e;var t={user_name:e.userName,province:e.proviceFirstStageName,city:e.addressCitySecondStageName,county:e.addressCountiesThirdStageName,address_detail:e.addressDetailInfo,tel:e.telNumber,postal_code:e.addressPostalCode,is_weixin:!0};return t},kdt2WxAddress:function(e){if(!e)return null;if(!e.user_name&&e.userName)return e;var t={userName:e.user_name,proviceFirstStageName:e.province,addressCitySecondStageName:e.city,addressCountiesThirdStageName:e.county,addressDetailInfo:e.address_detail,telNumber:e.tel,addressPostalCode:e.postal_code};return t},getPureAddressData:function(e){if(!e||!e.userName)return!1;var t={userName:e.userName,proviceFirstStageName:e.proviceFirstStageName,addressCitySecondStageName:e.addressCitySecondStageName,addressCountiesThirdStageName:e.addressCountiesThirdStageName,addressDetailInfo:e.addressDetailInfo,telNumber:e.telNumber,addressPostalCode:e.addressPostalCode,area_code:e.nationalCode};return t},getPureKdtAddressData:function(e){return e&&e.userName?{user_name:e.userName,province:e.proviceFirstStageName||e.provinceName,city:e.addressCitySecondStageName||e.cityName,county:e.addressCountiesThirdStageName||e.countryName,address_detail:e.addressDetailInfo||e.detailInfo,tel:e.telNumber,postal_code:e.addressPostalCode||e.postalCode,area_code:e.nationalCode||e.nationalCode}:!1},flashAnimate:function(e){e.addClass("animated flashWarn"),window.setTimeout(function(){e.removeClass("flashWarn")},1e3)},getTpl:function(e){var t=$(e);return t?_.template(t.html()):void 0}}),define("wap/components/util/address",function(){}),define("text!wap/components/address/templates/expressAddressPanel.html",[],function(){return'<div class="block form no-user-select border-top-0 border-bottom-0">\n    <div class="js-edit-address js-order-address express-panel express-panel-edit" style="padding-left:0;">\n        <ul class="express-detail">\n            <li class="clearfix"><span class="name">\n                    收货人：\n                <% if (typeof(address.name) !== \'undefined\') { %>\n                    <%= address.name %>\n                <% } else if (typeof(address.user_name) !== \'undefined\') { %>\n                    <%= address.user_name %>\n                <% } %>\n            </span><span class="tel"><%= address.tel %></span></li>\n            <li class="address-detail">\n                    收货地址：\n                <%= address.province %><%= address.city %><%= address.county %><%= address.address_detail %>\n            </li>\n        </ul>\n    </div>\n</div>\n'}),define("text!wap/components/address/templates/noAddressPanel.html",[],function(){return'<div class="js-edit-address empty-address-tip no-user-select">\n	新增收货地址\n</div>\n'}),define("text!wap/components/address/templates/addressList.html",[],function(){return'<div class="js-scene-address-list">\n    <div class="address-ui address-list">\n        <h4 class="address-title">选择收货地址</h4>\n        <div class="cancel-img js-cancel"></div>\n\n        <div class="js-address-container address-container block block-list border-top-0"></div>\n        <div class=\'add-address js-add-address\'>\n            <span class="icon-add"></span>\n            <a class="" href="javascript:;">新增地址</a>\n            <span class="icon-arrow-right"></span>\n        </div>\n    </div>\n</div>'}),define("wap/components/address/views/logistics_express",["require","wap/components/address/model/address","wap/components/address/collection/express_address_collection","wap/components/address/views/logistics_address_edit","wap/components/address/views/logistics_address_list","wap/components/util/address","text!wap/components/address/templates/expressAddressPanel.html","text!wap/components/address/templates/noAddressPanel.html","text!wap/components/address/templates/addressList.html","bower_components/pop/popup","backbone","underscore","jquery"],function(e){var t=e("wap/components/address/model/address"),s=e("wap/components/address/collection/express_address_collection"),i=e("wap/components/address/views/logistics_address_edit"),n=e("wap/components/address/views/logistics_address_list"),o=(e("wap/components/util/address"),e("text!wap/components/address/templates/expressAddressPanel.html")),a=e("text!wap/components/address/templates/noAddressPanel.html"),r=e("text!wap/components/address/templates/addressList.html"),d=e("bower_components/pop/popup"),c=e("backbone"),l=e("underscore"),h=e("jquery"),p=window.Utils,u=window.motify,m=function(){};return c.View.extend({initialize:function(e){e=e||{},this.expressOptions=e.expressOptions||{},a=this.expressOptions.noAddressPanelTpl||a,o=this.expressOptions.addressPanelTpl||o,this.notAutoPopAddress=this.expressOptions.notAutoPopAddress,this.saveAddressToServer=this.expressOptions.saveAddressToServer,this.saveAddressUrl=this.expressOptions.saveAddressUrl,this.notAutoPopAddress=this.expressOptions.notAutoPopAddress,this.isForbidDeletedAddressSubmit=this.expressOptions.isForbidDeletedAddressSubmit||!1,this.allow_self_fetch=e.allow_self_fetch,this.address=e.currentAddress||window._global.expressAddress,this.areaModel=e.areaModel,this.onAddressChanged=e.onAddressChanged||m,this.onChangeAddressClick=e.onChangeAddressClick||m,this.not_saveToSever=e.not_saveToSever,this.order_state=window._global.order_state,this.template=l.template(o),this.showErrorTips=e.showErrorTips||m,this.hideErrorTips=e.hideErrorTips||m;var t=l.toArray(window._global.address_list);if(this.hasAddress())this.doNotSaveToServerNextTime=!0;else{var i={};i=l.find(t,function(e){return 1==e.is_default}),i||this.expressOptions.notUseLocalStorage?i||(i=l.first(t)||{}):i=p.getRecentlyUsedAddress()||{},this.address=i}this.addressCollection=new s(t||[]),0==t.length&&this.addressCollection.fetch()},events:{"click .js-edit-address":"onEditExpressClicked"},onEditExpressClicked:function(e){if(!(this.order_state>=3)){if(this.onChangeAddressClick("express",e),window._global.no_user_login)return void(this.addressEditView=new d({contentViewClass:i,isCanNotHide:!0,contentViewOptions:{onFinishEditAddress:l(this.onFinishEditAddress).bind(this),model:this.address?new t(this.address):null,doNotSavetoServer:!0,cannotDelete:!0,areaModel:this.areaModel},containerCss:{bottom:0,left:0,right:0,background:"white"}}).render().show());this.addressListView=new d({contentViewClass:n,isCanNotHide:!0,contentViewOptions:{templateHtml:r,collection:this.addressCollection,addressType:"express",onAddressChange:l(this.onAddressChange).bind(this),onAddressDelete:l(this.onAddressDelete).bind(this),autoPopup:(e||{}).autoPopup,selectedAddress:this.address,areaModel:this.areaModel},containerCss:{bottom:0,left:0,right:0,background:"white"}}).render().show(),this.addressListView.contentView.show(l.extend({selectedAddress:this.address},e))}},onAddressDelete:function(e){this.isForbidDeletedAddressSubmit&&this.address&&this.address.id==e.id&&(this.address=null,this.notAutoPopAddress=!0,this.render(),p.deleteLastUsedAddress(),c.EventCenter.trigger("address:delete"))},onFinishEditAddress:function(e,t){this.address=t.address_model.toJSON(),this.saveAddressToLocal(this.address),this.render()},saveAddressToLocal:function(e){p.saveLastUsedAddress(e)},renderAddressPanel:function(e){e=e||{};var t=e.from,s=e.not_saveToSever;if(c.EventCenter.trigger("address:beforeChange"),this.hasAddress())this.$el.html(this.template({address:this.address})),s||this.not_saveToSever?c.EventCenter.trigger("address:change"):this.saveAddressToServer&&this.doSaveAddressToServer(this.address);else{var i=l.template(a);if(this.$el.html(i()),"self-fetch"===t)return;this.notAutoPopAddress||this.allow_self_fetch||this.onEditExpressClicked({autoPopup:!0})}},onAddressChange:function(e){this.address=e.address,this.renderAddressPanel(),this.saveAddressToLocal(this.address)},hasAddress:function(){return!!this.address&&!!this.address.user_name},getAddress:function(){return this.address},render:function(e){return this.show(e),this},show:function(e){e=e||{},e.order_state&&(this.order_state=e.order_state),this.$el.removeClass("hide"),this.renderAddressPanel({from:e.from,not_saveToSever:e.not_saveToSever}),this.order_state>=3&&this.$(".js-edit-address").removeClass("express-panel-edit").removeClass("js-edit-address")},doSaveAddressToServer:function(e){var t=this;return t.cannotDeliver=!1,t.hideErrorTips(),c.EventCenter.trigger("address:beforeExpressSend"),this.doNotSaveToServerNextTime?(this.doNotSaveToServerNextTime=!1,c.EventCenter.trigger("address:has"),void this.onAddressChanged({logisticsWay:"express",isResetPriceData:!1})):(t.sendingToServer=!0,void h._ajax({url:t.saveAddressUrl,type:"POST",dataType:"json",timeout:15e3,data:l.extend({is_weixin:!1},e,{order_no:window._global.order_no,kdt_id:window._global.kdt_id}),success:function(s){var i=s.code,n=s.data;0===i?(t.$el.html(t.template({address:e})),c.EventCenter.trigger("address:change"),t.onAddressChanged({logisticsWay:"express",isResetPriceData:!0,data:n})):10600===i?(t.$el.html(t.template({address:e})),t.showErrorTips("很抱歉，该地区暂不支持配送。"),t.cannotDeliver=!0):u.log(s.msg)},error:function(e,t,s){u.log("更新收货地址失败")},complete:function(){t.sendingToServer=!1}}))}})}),define("wap/trade/new_order/components/address/logistics_express_kdt",["require","wap/components/address/views/logistics_express"],function(e){var t=e("wap/components/address/views/logistics_express");return t.extend({doSaveAddressToServer:function(e){var t=this;t.cannotDeliver=!1,t.hideErrorTips();var s=_.extend({is_weixin:!1},e),i={address:{express_type:"express",address:s},book_key:window._global.book_key,bill_cart:window._global.bill_cart,bill_data:window._global.bill_data};return Backbone.EventCenter.trigger("address:beforeExpressSend"),t.address=e,this.doNotSaveToServerNextTime?(this.doNotSaveToServerNextTime=!1,Backbone.EventCenter.trigger("address:has"),void this.onAddressChanged({logisticsWay:"express",address:e,isResetPriceData:!1})):(t.sendingToServer=!0,void $._ajax({url:"/v2/trade/bill/show.json",type:"POST",dataType:"json",timeout:15e3,data:i,success:function(s){var i=+s.code,n=s.data;0===i?(t.$el.html(t.template({address:e})),Backbone.EventCenter.trigger("address:change",[n]),t.onAddressChanged({logisticsWay:"express",address:e,isResetPriceData:!0,data:n})):10600===i?(t.$el.html(t.template({address:e})),t.showErrorTips("很抱歉，该地区暂不支持配送。"),t.cannotDeliver=!0):101900001===i?(motify.log("订单信息已更新，页面刷新中~"),window.location.reload()):motify.log(s.msg)},error:function(e,t,s){motify.log("更新收货地址失败")},complete:function(){t.sendingToServer=!1,Backbone.EventCenter.trigger("address:sync:complete")}}))}})}),define("wap/trade/new_order/components/address/logistics_express_wx",["./logistics_express_kdt","wap/components/util/address"],function(e,t){return e.extend({onEditExpressClicked:function(e){!window.wxReady||window._global.order_state>=3||(this.onChangeAddressClick("express",e),window.wxReady(_(function(){wxBridge.openAddress&&wxBridge.openAddress(_(function(e){var t=e.err_msg||e.errMsg;if("edit_address:ok"==t||"openAddress:ok"===t){var s=Utils.getPureKdtAddressData(e);s?(s.is_weixin=!0,this.address=s,this.doSaveAddressToServer(this.address,"express"),this.saveAddressToLocal(this.address)):motify.log("地址数据错误")}}).bind(this),_(function(e){var t=e.err_msg||e.errMsg,s=e.err_desc||"";if("openAddress:fail"!=t){if("access_control:not_allow"===t||"editAddress:fail_auth_error"===t)return this.trigger("wx-address:error",{error_data:e,request_data:window._global.address_token}),void motify.log(t);if("edit_address:fail"!==t||s){if("edit_address:cancel"===t)return;var i="err_msg:"+t+".";return s&&(i+="err_desc:"+s+"."),void motify.log("哎呀，系统出错了，请稍候再试试哟"+i)}}}).bind(this))}).bind(this)))}})}),define("bower_components/pop/pop_page",[],function(){var e=Backbone.View.extend({initialize:function(e){this.contentViewClass=e.contentViewClass,this.contentViewOptions=e.contentViewOptions,this.nPageContents=e.nPageContents},render:function(){return this.contentView=new this.contentViewClass(_.extend({onHide:_(this.hide).bind(this),el:this.$el},this.contentViewOptions)).render(),this},show:function(){return _.each(this.nPageContents,function(e){e.hide()}),this.$el.show(),window.scrollTo(0,0),window.location.hash="ShowMessage",this.hideIfHashDisappear(this),this},hide:function(){return this.$el.hide(),_.each(this.nPageContents,function(e){e.show()}),this.onHashChangeListener&&Backbone.$(window).off("hashchange",this.onHashChangeListener),this.checkHashInterval&&clearInterval(this.checkHashInterval),window.location.hash&&history.back(),this},destroy:function(){this.contentView&&this.contentView.remove()},hideIfHashDisappear:function(e){"onhashchange"in window?(this.onHashChangeListener=function(){window.location.hash||e.hide()},Backbone.$(window).on("hashchange",this.onHashChangeListener)):this.checkHashInterval=setInterval(function(){window.location.hash||e.hide()},500)}});return e}),define("wap/components/address/collection/selffetch_address_collection",["require","backbone","wap/components/address/model/address"],function(e){var t=e("backbone"),s=e("wap/components/address/model/address");return t.Collection.extend({model:s,url:"/v2/trade/selffetch/list.json",parse:function(e){var t=(e||{}).data||{};this.total=parseInt(t.total,10),this.cityName=t.cityName,this.cityCode=t.cityCode;var s=(t||{}).list||[];return this.total>=0||(this.total=s.length),s}})}),define("text!wap/components/datetime_picker/templates/datetime_picker_header.html",[],function(){return'<a href="javascript:void(0)" class="js-cancel-datetime">取消</a>\n<h3 class="center font-size-16">选择到店时间</h3>\n'}),define("wap/components/datetime_picker/views/datetime_picker_header",["require","underscore","backbone","text!wap/components/datetime_picker/templates/datetime_picker_header.html"],function(e){var t=e("underscore"),s=e("backbone"),i=e("text!wap/components/datetime_picker/templates/datetime_picker_header.html");return s.View.extend({className:"page-header",initialize:function(e){e=e||{},this.onHide=e.onHide},template:t.template(i),events:{"click .js-cancel-datetime":"onCancelBtnClick"},render:function(){return this.$el.html(this.template()),this},onCancelBtnClick:function(){this.onHide()}})}),define("text!wap/components/datetime_picker/templates/time_picker.html",[],function(){return'<% for (var i = 0; i < timePieces.length; i++) { %>\n<div class="time-picker js-time-picker">\n	<h3><%= timePieces[i].openTime %> - <%= timePieces[i].closeTime %></h3>\n	<ul class="time-picker-items">\n		<%= timePieces[i].fetchTimeItemsHtml %>\n	</ul>\n</div>\n<% } %>\n'}),define("wap/components/datetime_picker/views/time_picker",["require","underscore","backbone","text!wap/components/datetime_picker/templates/time_picker.html"],function(e){var t=e("underscore"),s=e("backbone"),i=window.motify,n=e("text!wap/components/datetime_picker/templates/time_picker.html"),o=function(){};return s.View.extend({className:"time-picker-container",template:t.template(n),initialize:function(e){e=e||{},this.open_time=e.open_time,this.close_time=e.close_time,this.isToday=e.isToday,this.currTime=e.currTimeStr,this.onTimeChange=e.onTimeChange||o,this.$el.on("click",t(this.onTimeClick).bind(this))},render:function(e){return"undefined"!=typeof e&&(this.open_time=e.open_time,this.close_time=e.close_time,this.isToday=e.isToday),this.currTime=this.currTime||this.getLatestBusinessTime(),this.$el.html(this.template({timePieces:this.getOpenCloseTimePieces()})),this},getOpenCloseTimePieces:function(){var e=[],t="12:00",s="18:00",i=this.open_time,n=this.close_time;return-1!==this.compareTime(i,n)?[]:-1!==this.compareTime(i,s)||-1!==this.compareTime(i,t)&&1!==this.compareTime(n,s)||-1===this.compareTime(i,t)&&1!==this.compareTime(n,t)?(e.push(this.createTimeItem(i,n)),e):-1===this.compareTime(i,t)&&1!==this.compareTime(n,s)?(e.push(this.createTimeItem(i,t)),e.push(this.createTimeItem(t,n)),e):-1!==this.compareTime(i,t)&&1===this.compareTime(n,s)?(e.push(this.createTimeItem(i,s)),e.push(this.createTimeItem(s,n)),e):(e.push(this.createTimeItem(i,t)),e.push(this.createTimeItem(t,s)),e.push(this.createTimeItem(s,n)),e)},createTimeItem:function(e,t){return{openTime:e,closeTime:t,fetchTimeItemsHtml:this.createFetchItems(e,t)}},computeTimePiecesCount:function(e,t){var s,i=e.split(":"),n=t.split(":"),o=+i[0],a=+i[1],r=+n[0],d=+n[1];s=o===r?d-a:d+(60-a)+60*(r-o-1);var c=parseInt(s/15,10);return s%15===0?c:c+1},createFetchItems:function(e,s){for(var i,n='<li><a href="javascript:void(0)" data-time="<%= fetchTimeStr %>" class="js-fetch-time <%= itemClassName %>"><%= fetchTimeStr %></a></li>',o=e.split(":"),a=s.split(":"),r=+o[0],d=+o[1],c=+a[0],l=+a[1],h=this.computeTimePiecesCount(e,s),p=[],u=r,m=d,f=0;h>f;f++){var g=this.createTimeStr(u)+":"+this.createTimeStr(m),w=this.compareTime(g,this.currTime),_=this.compareTime(g,this.getLatestBusinessTime());0===w?i="time-active":-1===_&&this.isToday&&(i="time-disable"),45>m?m=u===c&&m+15>l?l:m+15:u===c?m=l:(m=(m+15)%60,m=u+1===c&&m>l?l:m,u++);var v=this.createTimeStr(u)+":"+this.createTimeStr(m);p.push(t.template(n)({itemClassName:i,fetchTimeStr:g+"-"+v})),i=""}return p.join("")},createTimeStr:function(e){return 10>e?"0"+e:e},getLatestBusinessTime:function(){return this.getCloseTime(new Date)},getCloseTime:function(e){var t=e.getMinutes();return 0===t?e.getHours()+":00":15>=t?e.getHours()+":15":30>=t?e.getHours()+":30":45>=t?e.getHours()+":45":e.getHours()+1+":00"},getTimeStr:function(e){return e.getHours()+":"+e.getMinutes()},compareTime:function(e,t){if(e===t)return 0;var s=e.split(":"),i=t.split(":");return+s[0]<+i[0]||+s[0]===+i[0]&&+s[1]<+i[1]?-1:1},onTimeClick:function(e){var t=$(e.target);t.hasClass("time-disable")?i.log("当前日期不可选"):(this.$el.find(".js-fetch-time").removeClass("time-active"),t.addClass("time-active"),this.onTimeChange(t.data("time")))}})}),define("bower_components/pop/popout",["require","./pop_forbid_scroll"],function(e){var t=e("./pop_forbid_scroll"),s=t.extend({init:function(e){
e=e||{},this._super(e),this.css=$.extend({transition:"opacity ease "+this.animationTime+"ms",top:"50%",left:"50%","-webkit-transform":"translate3d(-50%, -50%, 0)",transform:"translateY(-50%, -50%, 0)"},e.css||{}),this.nPopContainer.css(this.css)},_doShow:function(){$(".js-popout-close").click($.proxy(function(e){this.hide()},this)),this.nPopContainer.css("opacity",1),this.nPopContainer.show()},_doHide:function(e){this.nPopContainer.css({opacity:0})}});return s}),define("bower_components/zenjs/util/date",[],function(){var e={getCurrentDay:function(e){e=e||new Date;var t=e.getMonth()+1;t=1===t.toString().length?"0"+t:t;var s=e.getDate();return s=1===s.toString().length?"0"+s:s,e.getFullYear()+"-"+t+"-"+s},getFullTime:function(e){function t(e){return 1===e.toString().length?"0"+e:e}e=e||new Date;var s=e.getMonth()+1;s=t(s);var i=e.getDate();i=t(i);var n=e.getHours();n=t(n);var o=e.getMinutes();o=t(o);var a=e.getSeconds();return a=t(a),e.getFullYear()+"-"+s+"-"+i+" "+n+":"+o+":"+a},getDateFromStr:function(e,t){return t=t||new Date,e.toString().replace(/^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})$/,function(e,s,i,n,o,a,r){return t.setFullYear(s),t.setMonth(parseInt(i)-1),t.setDate(parseInt(n)),t.setHours(parseInt(o)),t.setMinutes(parseInt(a)),t.setSeconds(parseInt(r)),e}),t}};return e}),define("text!wap/components/datetime_picker/templates/date_picker_header_item.html",[],function(){return'<li>\n    <a href="javascript:void(0)" data-date="<%= fullDateStr %>" class="js-date-header-item date-header-item <%= dateClassName %>">\n        <span class="date-desc"><%= dateDesc %></span>\n        <span class="date-str"><%= dateStr %></span>\n    </a>\n</li>'}),define("wap/components/datetime_picker/views/date_picker_header",["require","underscore","backbone","bower_components/zenjs/util/date","text!wap/components/datetime_picker/templates/date_picker_header_item.html"],function(e){var t=e("underscore"),s=e("backbone"),i=e("bower_components/zenjs/util/date"),n=["周日","周一","周二","周三","周四","周五","周六"],o=e("text!wap/components/datetime_picker/templates/date_picker_header_item.html"),a=window.motify,r=function(){};return s.View.extend({className:"date-picker-header clearfix",tagName:"ul",initialize:function(e){this.currSelectDate=new Date(e.currSelectDate),this.isDateCanSelect=e.isDateCanSelect,this.onDateChange=e.onDateChange||r,this.headerItemTpl=t.template(o)},events:{"click .js-more-date":"onMoreDateBtnClick","click .js-date-header-item":"onDateHeaderItemClick"},render:function(e){e=e||{},"undefined"!=typeof e.currSelectDate&&(this.currSelectDate=e.currSelectDate);for(var t,s,n,o=this.currSelectDate,a=0;4>a;a++)t=this.getDateDesc(o),this.isDateCanSelect(o)||(t+="(休息)",n="date-disable"),s=this.getDateStr(o),this.$el.append(this.headerItemTpl({dateDesc:t,dateStr:s,dateClassName:n,fullDateStr:i.getCurrentDay(o)})),n="",o.setDate(o.getDate()+1);return this.$el.append('<li class="more-date-li"><a href="javascript:void(0)" class="js-more-date more-date"><span>更多</span><span class="calendar-icon"></span></a></li>'),this},getDateStr:function(e){var t=e.getMonth()+1;t=1===t.toString().length?"0"+t:t;var s=e.getDate();return s=1===s.toString().length?"0"+s:s,t+"月"+s+"日"},getDateDesc:function(e){var t=new Date,s=new Date;s.setDate(s.getDate()+1);var o=new Date;o.setDate(o.getDate()+2);var a=i.getCurrentDay(e);return a===i.getCurrentDay(t)?"今天":a===i.getCurrentDay(s)?"明天":a===i.getCurrentDay(o)?"后天":n[e.getDay()]},onDateHeaderItemClick:function(e){var t=$(e.target);if(t.hasClass("js-date-header-item")||(t=t.parent()),t.hasClass("date-disable"))return void a.log("您选择的日期不在营业时间，请重新选择");var s=t.data("date");this.onDateChange(s)},onMoreDateBtnClick:function(){this.trigger("more-date")}})}),define("text!wap/components/datetime_picker/templates/date_picker_calendar.html",[],function(){return'<table class="date-picker-calendar">\n	<thead>\n		<tr class="calendar-header js-calendar-header">\n			<th class="js-calendar-prev calendar-prev <%= isPrevHide ? \'calendar-hide\' : \'\'%>"><</th>\n			<th colspan="5" class="calendar-header-title"><%= calendarHeaderTitle %></th>\n			<th class="js-calendar-next calendar-next <%= isNextHide ? \'calendar-hide\' : \'\'%>">></th>\n		</tr>\n		<tr class="calendar-weeks-title">\n			<th>一</th>\n			<th>二</th>\n			<th>三</th>\n			<th>四</th>\n			<th>五</th>\n			<th class="c-orange">六</th>\n			<th class="c-orange">日</th>\n		</tr>\n	</thead>\n	<tbody class="js-calendar-body calendar-body">\n		<%= calendarBodyHtml %>\n	</tbody>\n</table>'}),define("wap/components/datetime_picker/views/date_picker_calendar",["require","underscore","backbone","bower_components/zenjs/util/date","text!wap/components/datetime_picker/templates/date_picker_calendar.html"],function(e){var t=e("underscore"),s=e("backbone"),i=e("bower_components/zenjs/util/date"),n=window.motify,o=e("text!wap/components/datetime_picker/templates/date_picker_calendar.html"),a=function(){};return s.View.extend({className:"date-picker-calendar",initialize:function(e){this.minDate=e.minDate,this.maxDate=e.maxDate,this.currSelectDateStr=e.currSelectDate,this.currSelectDate=new Date(e.currSelectDate),this.isDateCanSelect=e.isDateCanSelect||a,this.onCalendarDateChange=e.onCalendarDateChange||a,this.calendarTpl=t.template(o),this.currShowYear=this.currSelectDate.getFullYear(),this.currShowMonth=this.currSelectDate.getMonth(),this.daysArray=[31,28,31,30,31,30,31,31,30,31,30,31]},events:{"click .js-calendar-item":"onCalendarItemClick","click .js-calendar-prev":"onCalendarPrevClick","click .js-calendar-next":"onCalendarNextClick"},render:function(e){e=e||{},this.currShowYear=e.year||this.currShowYear,this.currShowMonth=e.month||this.currShowMonth;var t,s=new Date(this.currShowYear,this.currShowMonth,1);this.minDate&&this.isSameMonth(this.minDate,s)&&(t=!0);var i;return this.maxDate&&this.isSameMonth(this.maxDate,s)&&(i=!0),this.$el.html(this.calendarTpl({calendarHeaderTitle:this.currShowYear+"年"+(this.currShowMonth+1)+"月",isPrevHide:t,isNextHide:i,calendarBodyHtml:this.getCalendarBodyHtml()})),this},isSameMonth:function(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()},isSameDay:function(e,t){return i.getCurrentDay(e)===i.getCurrentDay(t)},isToday:function(e){return this.isSameDay(e,new Date)},isLeapYear:function(e){return e%4===0&&e%100!==0||e%400===0},isSelectedDate:function(e){return!this.isDateCanSelect(e)||this.minDate&&-1===this.compareDate(e,this.minDate)||this.maxDate&&1===this.compareDate(e,this.maxDate)?!1:!0},compareDate:function(e,t){return i.getCurrentDay(e)===i.getCurrentDay(t)?0:e.getTime()<t.getTime()?-1:1},getCalendarBodyHtml:function(){this.daysArray[1]=this.isLeapYear(this.currShowYear)?29:28;var e,t=new Date(this.currSelectDateStr),s=new Date(this.currShowYear,this.currShowMonth,1),n=this.daysArray[this.currShowMonth],o=0===s.getDay()?6:s.getDay()-1,a=(n+o)%7===0?0:7-(n+o)%7,r=[];r.push("<tr>");for(var d=o;d-->0;)r.push("<td>&nbsp;</td>");for(var c="js-calendar-item",l=1;n>=l;l++)s=new Date(this.currShowYear,this.currShowMonth,l),e=i.getCurrentDay(s),this.isSameDay(t,s)&&this.isToday(s)?c+=" today curr":this.isToday(s)?c+=" today":this.isSameDay(t,s)?c+=" curr":this.isSelectedDate(s)||(c+=" disable"),r.push('<td class="'+c+'" data-date="'+e+'">'+l+"</td>"),c="js-calendar-item",(l+o)%7===0&&r.push("</tr><tr>");for(;a-->0;)r.push("<td>&nbsp;</td>");return r.push("</tr>"),r.join("")},onCalendarItemClick:function(e){var t=$(e.target),s=t.parent().parent();return t.hasClass("disable")?void n.log("您选择的日期不在营业时间，请重新选择"):(s.find(".js-calendar-item").removeClass("curr"),t.addClass("curr"),this.onCalendarDateChange(t.data("date")),void 0)},onCalendarNextClick:function(){11===this.currShowMonth?(this.currShowYear+=1,this.currShowMonth=0):this.currShowMonth+=1,this.render(this.currShowYear,this.currShowMonth)},onCalendarPrevClick:function(){0===this.currShowMonth?(this.currShowYear-=1,this.currShowMonth=11):this.currShowMonth-=1,this.render(this.currShowYear,this.currShowMonth)}})}),define("wap/components/datetime_picker/views/date_picker",["require","underscore","backbone","bower_components/pop/popout","wap/components/datetime_picker/views/date_picker_header","wap/components/datetime_picker/views/date_picker_calendar"],function(e){var t=e("underscore"),s=e("backbone"),i=e("bower_components/pop/popout"),n=e("wap/components/datetime_picker/views/date_picker_header"),o=e("wap/components/datetime_picker/views/date_picker_calendar"),a=function(){};return s.View.extend({className:"date-picker-container",initialize:function(e){e=e||{},this.currSelectDate=e.currSelectDate,this.minDate=e.minDate,this.maxDate=e.maxDate,this.dateCanSelect=e.dateCanSelect||a,this.onDateChange=e.onDateChange||a},render:function(e){return e=e||{},this.currSelectDate=e.currSelectDate||this.currSelectDate,this.datePickerHeader=new n({currSelectDate:this.currSelectDate,isDateCanSelect:t(this.isDateCanSelect).bind(this),onDateChange:t(this.onDateChange).bind(this)}),this.listenTo(this.datePickerHeader,"more-date",t(this.onMoreDateBtnClick).bind(this)),this.$el.html(this.datePickerHeader.render().el),this},isDateCanSelect:function(e){return this.dateCanSelect===a?!0:!!this.dateCanSelect(e)},onCalendarDateChange:function(e){this.onDateChange(e),this.calendarPopout.hide()},onMoreDateBtnClick:function(){this.calendarPopout=new i({contentViewClass:o,contentViewOptions:{minDate:this.minDate,maxDate:this.maxDate,currSelectDate:this.currSelectDate,isDateCanSelect:t(this.isDateCanSelect).bind(this),onCalendarDateChange:t(this.onCalendarDateChange).bind(this)},transparent:"0",css:{width:"315px",left:"auto",right:"0",top:"59px","-webkit-transform":"translate3d(0, 0, 0)",transform:"translateY(0, 0, 0)"}}).render().show()}})}),define("wap/components/datetime_picker/main",["require","underscore","backbone","wap/components/datetime_picker/views/datetime_picker_header","wap/components/datetime_picker/views/time_picker","wap/components/datetime_picker/views/date_picker","bower_components/zenjs/util/date"],function(e){var t=e("underscore"),s=e("backbone"),i=e("wap/components/datetime_picker/views/datetime_picker_header"),n=e("wap/components/datetime_picker/views/time_picker"),o=e("wap/components/datetime_picker/views/date_picker"),a=e("bower_components/zenjs/util/date"),r=["周日","周一","周二","周三","周四","周五","周六"],d=function(){};return s.View.extend({initialize:function(e){e=e||{},this.business_hours=e.business_hours||[],this.onHide=e.onHide||d,this.onDateTimeChange=e.onDateTimeChange||d,this.latestBusniessDay=this.getLatestBusinessDay(),this.currDateStr=e.currDateStr||a.getCurrentDay(this.latestBusniessDay),this.currTimeStr=e.currTimeStr},render:function(){return this.$el.html(""),this.renderHeader(),this.renderDatePicker(),this.renderTimePicker(),this},renderHeader:function(){this.dateTimePickerHeader=new i({onHide:t(this.onHide).bind(this)}),this.$el.append(this.dateTimePickerHeader.render().el)},renderDatePicker:function(){this.datePicker=new o({currSelectDate:this.currDateStr||a.getCurrentDay(new Date),minDate:new Date,dateCanSelect:t(this.getBusinessHours).bind(this),onDateChange:t(this.onDateChange).bind(this)}),this.$el.append(this.datePicker.render().el)},renderTimePicker:function(){this.timePicker=new n(t.extend(this.getBusinessHours(this.currDateStr),{onTimeChange:t(this.onTimeChange).bind(this),isToday:this.currDateStr===a.getCurrentDay(new Date),currTimeStr:this.currTimeStr})),this.$el.append(this.timePicker.render().el)},onTimeChange:function(e){this.currTimeStr=e.slice(0,5),this.onDateTimeChange(this.getSelectDatetime(e)),this.onHide()},onDateChange:function(e){this.currDateStr=e;var s=this.currDateStr===a.getCurrentDay(new Date),i=new Date(e),n=this.getBusinessHours(i);this.timePicker.render(t.extend(n,{isToday:s})),this.datePicker.render({currSelectDate:e})},getLatestBusinessDay:function(e){return e=e||new Date,this.getBusinessHours(e)?e:this.getLatestBusinessDay(new Date(e.setDate(e.getDate()+1)))},getBusinessHours:function(e){"string"==typeof e&&(e=new Date(e));for(var t,s=r[e.getDay()],i=this.business_hours.length,n=0;i>n;n++)if(t=this.business_hours[n],-1!==t.weekdays.indexOf(s))return{open_time:t.open_time,close_time:t.close_time};return!1},getSelectDatetime:function(e){return this.currDateStr+" "+e}})}),define("text!wap/components/address/templates/selffetchAddressListHeader.html",[],function(){return'<div class="page-header">\n	<a href="javascript:void(0)" class="js-cancel">取消</a>\n	<h3 class="center font-size-16 js-header-title">更换提货地址</h3>\n</div>\n<div class="address-header js-address-header">\n	<span>所在城市：</span>\n	<a href="javascript:void(0)" class="js-city-btn city-btn"><%= cityName ? cityName : \'全部\' %></a>\n	<a href="javascript:void(0)" class="js-search-btn search-btn">搜索</a>\n</div>\n'}),define("wap/components/address/views/logistics_selffetch_list_header",["require","underscore","backbone","text!wap/components/address/templates/selffetchAddressListHeader.html"],function(e){var t=e("underscore"),s=e("backbone"),i=e("text!wap/components/address/templates/selffetchAddressListHeader.html"),n=function(){};return s.View.extend({className:"address-list-header",initialize:function(e){e=e||{},this.cityName=e.cityName||"",this.onHide=e.onHide||n},events:{"click .js-city-btn":"onCityBtnClick","click .js-search-btn":"onSearchBtnClick","click .js-cancel":"onCancelBtnClick"},template:t.template(i),render:function(){return this.$el.html(this.template({cityName:this.cityName})),this},onCityBtnClick:function(){this.trigger("city:click")},onSearchBtnClick:function(){this.trigger("search:click")},onCancelBtnClick:function(){this.onHide()}})}),define("text!wap/components/address/templates/selffetchAddressList.html",[],function(){return'<div class="address-ui address-list">\n	<div class="js-address-container address-container block block-list">\n	</div>\n</div>\n'}),define("text!wap/components/address/templates/cityList.html",[],function(){return'<div class="city-list-container">\n    <div class="search-form" style="padding-right: 55px;background-color: #f8f8f8;">\n        <input class="js-search-input search-input" placeholder="输入城市名拼音查询" value="<%= searchVal %>">\n        <a href="javascript:void(0)" class="js-search-btn search-cancel">搜索</a>\n        <span class="search-icon"></span>\n        <span class="close-icon js-clear-search" <% if (!searchVal) { %>style="display: none;"><% } %></span>\n    </div>\n    <div class="curr-city-name js-curr-city-name" <%= locationCity.cityName ? \'\' : \'style="display:none;"\' %>>\n        <h3 class="c-gray-dark font-size-14">当前定位</h3>\n        <p>\n            <a href="javascript:void(0)" class="btn city-name-btn js-city-name" data-code="<%= locationCity.cityCode %>"><%= locationCity.cityName %></a>\n        </p>\n    </div>\n    <div class="block center js-location-position location-position" <%= locationCity.cityName ? \'style="display:none;"\' : \'\' %>>\n        <p>无法获取当前所在城市信息</p>\n        <a href="javascript:void(0)" class="c-orange js-location-btn">点击重新定位</a>\n    </div>\n    <% if (historyCity.length !== 0) { %>\n        <div class="history-city">\n            <h3 class="c-gray-dark font-size-14">最近访问城市</h3>\n            <ul class="history-city-list clearfix">\n                <% for (var i = 0; i < historyCity.length; i++) { %>\n                        <li><a href="javascript:void(0)" class="btn city-name-btn js-city-name" data-code="<%= historyCity[i].cityCode %>"><%= historyCity[i].cityName %></a></li>\n                <% } %>\n            </ul>\n        </div>\n    <% } %>\n    <div class="city-list js-city-list">\n        <% for (var k in cityMap) { %>\n            <% if (cityMap[k].length !== 0) { %>\n                <div class="city-items">\n                    <h3 class="c-gray-dark font-size-14"><%= k %></h3>\n                    <ul class="block block-list">\n                        <% for (var j = 0; j < cityMap[k].length; j++) { %>\n                            <li class="block-item c-gray js-city-name" data-code="<%= cityMap[k][j].cityCode %>"><%= cityMap[k][j].cityName %></li>\n                        <% } %>\n                    </ul>\n                </div>\n            <% } %>\n        <% } %>\n        <% if (isEmptyCityMap) { %>\n            <p class="font-size-14 c-gray-dark center js-empty-city-tip" style="padding: 10px 0">暂无所在搜索城市的自提点哟</p>\n        <% } %>\n    </div>\n</div>'}),define("wap/components/address/views/logistics_city_list",["require","underscore","backbone","zenjs/util/local_storage"],function(e){var t=e("underscore"),s=e("backbone"),i=window.motify,n=function(){},o=e("zenjs/util/local_storage");return s.View.extend({initialize:function(e){e=e||{},this.template=t.template(e.templateHtml||""),this.locationCity=e.locationCity||{},this.cityMap=e.cityMap||{},this.onCityChange=e.onCityChange||n,this.onLocationChange=e.onLocationChange||n},events:{"click .js-location-btn":"onLocationBtnClick","click .js-city-name":"onCityNameClick","keyup .js-search-input":"onSearchInputKeyup","click .js-clear-search":"onClearSearchClick","click .js-search-btn":"onSearchBtnClick"},render:function(e){e=e||{};var t=e.searchVal||"";this.historyCity=JSON.parse(o.getItem("selffetch_history_city"))||[];var s=this.filterCityByString(t);return this.$el.html(this.template({historyCity:this.historyCity,locationCity:this.locationCity,cityMap:s,isEmptyCityMap:this.isEmptyCityMap(s),searchVal:t})),this},isEmptyCityMap:function(e){var t=!0;for(var s in e)0!==e[s].length&&(t=!1);return t},filterCityByString:function(e){var t={};for(var s in this.cityMap){var i=this.cityMap[s];t[s]=[];for(var n=0;n<i.length;n++)-1!==i[n].cityName.indexOf(e)&&t[s].push(i[n])}return t},onLocationBtnClick:function(){"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(t(this.onGetLocationSuccess).bind(this),t(this.onGetLocationError).bind(this),{timeout:3e3})},onGetLocationSuccess:function(e){var t=this;$.ajax({url:"/v2/trade/selffetch/city.json",data:{lat:e.coords.latitude,lng:e.coords.longitude},type:"GET",dataType:"json",timeout:2e3}).done(function(s){var i=s.data||{};t.locationCity={cityName:i.cityName,cityCode:i.cityCode,lat:e.coords.latitude,lng:e.coords.longitude},t.$el.find(".js-location-position").hide(),t.$el.find(".js-city-name").html(i.cityName).data("code",i.cityCode),t.$el.find(".js-curr-city-name").show()}).fail(function(e){i.log(e||"网络错误")})},onGetLocationError:function(){i.log("无法获取当前城市信息")},onCityNameClick:function(e){var t=$(e.target),s={cityName:t.text(),cityCode:t.data("code")};this.onCityChange(s);for(var i=this.historyCity,n=!1,a=0;a<i.length;a++)i[a].cityName===s.cityName&&(n=!0);n||(i.push(s),o.setItem("selffetch_history_city",JSON.stringify(i))),this.hide()},onSearchInputKeyup:function(e){var t=$(e.target),s=$.trim(t.val());0!==s.length?this.$(".js-clear-search").show():this.$(".js-clear-search").hide()},onSearchBtnClick:function(){var e=$.trim(this.$(".js-search-input").val());0!==e.length&&this.render({searchVal:e})},onClearSearchClick:function(){this.$el.find(".js-search-input").val(""),this.render({searchVal:""})},show:function(){this.$el.show()},hide:function(){this.$el.hide()}})}),define("text!wap/components/address/templates/addressSearch.html",[],function(){return'<div class="search-bar">\n    <div class="search-form">\n        <input class="js-search-input search-input" placeholder="输入区域/商圈/地址">\n        <a href="javascript:void(0)" class="js-search-btn search-cancel">搜索</a>\n        <span class="search-icon"></span>\n        <span class="close-icon js-clear-search" style="display: none;"></span>\n    </div>\n    <% if (historySearch.length !== 0) { %>\n        <div class="search-history">\n            <h3 class="c-gray">历史搜索</h3>\n            <ul class="block border-top-0 block-list">\n                <% for (var i = historySearch.length - 1; i >= 0; i--) { %>\n                    <li><a href="javascript:void(0)" class="block-item js-city-item"><%= historySearch[i] %></a></li>\n                <% } %>\n            </ul>\n        </div>\n    <% } %>\n</div>\n'}),define("wap/components/address/views/logistics_search",["require","underscore","backbone","text!wap/components/address/templates/addressSearch.html","zenjs/util/local_storage"],function(e){var t=e("underscore"),s=e("backbone"),i=e("text!wap/components/address/templates/addressSearch.html"),n=function(){},o=e("zenjs/util/local_storage");return s.View.extend({className:"address-search-container",initialize:function(e){this.searchAddress=e.searchAddress||n,this.template=t.template(i)},events:{"click .js-search-btn":"onSearchAddressBtnClick","click .js-clear-search":"onClearSearchClick","click .js-city-item":"onCityItemClick","keyup .js-search-input":"onSearchInputKeyup"},render:function(){return this.historySearch=JSON.parse(o.getItem("selffetch_history_search"))||[],this.$el.html(""),this.$el.html(this.template({historySearch:this.historySearch||[]})),this},onSearchAddressBtnClick:function(){var e=$.trim(this.$el.find(".js-search-input").val()),t=this.historySearch;this.hide(),this.searchAddress(e),-1===t.indexOf(e)&&(t.push(e),o.setItem("selffetch_history_search",JSON.stringify(t)))},onClearSearchClick:function(){this.$el.find(".js-search-input").val("")},onCityItemClick:function(e){this.hide(),this.searchAddress($(e.target).text())},onSearchInputKeyup:function(e){var t=$(e.target);0!==$.trim(t.val()).length?this.$(".js-clear-search").show():this.$(".js-clear-search").hide()},show:function(){this.$el.show()},hide:function(){this.$el.hide()}})}),define("wap/components/address/views/logistics_address_selffetch_list",["require","jquery","underscore","backbone","wap/components/address/views/logistics_address_list","wap/components/address/views/logistics_selffetch_list_header","text!wap/components/address/templates/selffetchAddressList.html","text!wap/components/address/templates/cityList.html","wap/components/address/views/logistics_city_list","wap/components/address/views/logistics_search"],function(e){var t=e("jquery"),s=e("underscore"),i=e("backbone"),n=e("wap/components/address/views/logistics_address_list"),o=e("wap/components/address/views/logistics_selffetch_list_header"),a=e("text!wap/components/address/templates/selffetchAddressList.html"),r=e("text!wap/components/address/templates/cityList.html"),d=e("wap/components/address/views/logistics_city_list"),c=e("wap/components/address/views/logistics_search"),l=window.motify,h=function(){};return i.View.extend({initialize:function(e){e=e||{},this.onHide=e.onHide||h,this.onAddressChange=e.onAddressChange||h,this.selectedAddress=e.selectedAddress,this.collection=e.collection,this.currCity=e.currCity||{},this.locationCity=e.locationCity||{},this.positionData={},this.onCityNameChange=e.onCityNameChange||h,this.onLocationChange=e.onLocationChange||h,"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(s(this.onGetLocationSuccess).bind(this),s(this.renderList).bind(this),{enableHighAccuracy:!0,timeout:3e3,maximumAge:3e5})},render:function(){0===this.collection.length?this.$el.html('<p class="loading-more"><span></span></p>'):this.renderList()},renderList:function(){this.$el.html(""),this.renderAddressHeaderView(),this.renderAddressListView()},renderAddressHeaderView:function(){this.addressHeaderView=new o({cityName:this.currCity.cityName||this.collection.cityName,onHide:this.onHide}).render(),this.listenTo(this.addressHeaderView,"city:click",s(this.onCityClick).bind(this)),this.listenTo(this.addressHeaderView,"search:click",s(this.onSearchClick).bind(this)),this.$el.append(this.addressHeaderView.el)},renderAddressListView:function(){var e=s.extend(this.positionData,{city_code:this.currCity.cityCode});this.collection.fetch({data:e}),this.addressListView=new n({templateHtml:a,collection:this.collection,onAddressChange:s(this.onAddressChange).bind(this),onListChange:s(this.onListChange).bind(this),selectedAddress:this.selectedAddress,positionData:this.positionData,cityData:this.currCity,emptyText:"暂无相关的自提点哟",onHide:this.onHide,comparator:function(e,t){var s=e.get("distance"),i=t.get("distance");return-1==s?1:-1==i?-1:s>i?1:i>s?-1:0}}).render(),this.$el.append(this.addressListView.el)},onListChange:function(){this.collection.cityName&&this.$el.find(".js-city-btn").html(this.collection.cityName)},onGetLocationSuccess:function(e){var s=this;this.positionData.lat=e.coords.latitude,this.positionData.lng=e.coords.longitude,t.ajax({url:"/v2/trade/selffetch/city.json",data:this.positionData,type:"GET",dataType:"json",timeout:2e3}).done(function(e){var t=e.data||{};s.locationCity={cityName:t.cityName,cityCode:t.cityCode,lat:s.positionData.lat,lng:s.positionData.lng},s.currCity={cityName:t.cityName,cityCode:t.cityCode},s.onLocationChange(s.locationCity),s.onCityNameChange(s.currCity),s.renderList()}).fail(function(e,t){l.log(t||"网络错误")})},toggleListShowOrHide:function(){this.addressHeaderView.$el.find(".js-address-header").toggle(),this.addressListView.$el.toggle()},onCityClick:function(){var e=this;return this.$el.find(".js-header-title").html("更换所在城市"),this.toggleListShowOrHide(),this.cityListView?void this.cityListView.render().show():void t.ajax({url:"/v2/trade/selffetch/cityMap.json",type:"GET",dataType:"json",timeout:2e3}).done(function(t){t=t||{},e.cityMapData=t.data,e.cityListView=new d({locationCity:{cityName:e.locationCity.cityName,cityCode:e.locationCity.cityCode},onCityChange:s(e.onCityChange).bind(e),onLocationChange:s(e.onLocationChange).bind(e),cityMap:e.cityMapData,templateHtml:r}).render(),e.$el.append(e.cityListView.el)}).fail(function(e){l.log(e||"网络错误")})},onCityChange:function(e){if(this.$el.find(".js-header-title").html("更换提货地址"),this.toggleListShowOrHide(),this.currCity=e,this.onCityNameChange(e),e.cityName!==this.collection.cityName){this.$el.find(".js-city-btn").html(e.cityName);var t=this.currCity.cityName||this.collection.cityName;this.collection.fetch({data:{lat:this.locationCity.cityName===t?this.locationCity.lat:"",lng:this.locationCity.cityName===t?this.locationCity.lng:"",city_code:e.cityCode}})}},onSearchClick:function(e){return this.toggleListShowOrHide(),this.searchView?void this.searchView.render().show():(this.searchView=new c({searchAddress:s(this.searchAddress).bind(this)}).render(),void this.$el.append(this.searchView.el))},searchAddress:function(e){var t=this.currCity.cityName||this.collection.cityName,s=this.currCity.cityCode||this.collection.cityCode;this.toggleListShowOrHide(),this.collection.fetch({data:{lat:this.locationCity.cityName===t?this.locationCity.lat:"",lng:this.locationCity.cityName===t?this.locationCity.lng:"",city_code:s,keyword:e}})}})}),define("text!wap/components/address/templates/selfFetchAddressPanel.html",[],function(){return'<div class="selffetch-panel block form no-user-select border-top-0 border-bottom-0">\n    <% if (orderState < 3) { %>\n        <p class="font-size-14 c-gray-dark self-fetch-tip">\n            您选择的是到店自提，商户不负责商品配送。请仔细填写提货相关信息，订单免运费。\n        </p>\n    <% } %>\n    <div class="clearfix block-item">\n        <label>提货人：</label>\n        <input class="txt txt-black ellipsis js-name" value="<%= addressName %>" placeholder="请填写提货人姓名" <%= orderState >= 3 ? \'disabled\' : \'\' %>>\n    </div>\n    <div class="clearfix block-item">\n        <label>手机号码：</label>\n        <input type="text" class="txt txt-black ellipsis js-tel" value="<%= addressTel %>" placeholder="请填写提货人手机号码" <%= orderState >= 3 ? \'disabled\' : \'\' %>>\n    </div>\n    <div class="clearfix block-item <%= orderState >= 3 ? \'\' : \'arrow\' %>">\n        <label>提货地址：</label>\n        <% if (address.name) { %>\n            <span class="js-address address-detail">\n                <b class="address-name"><%= address.name %></b>\n                <b class="">\n                    <%= address.province + address.city + address.county + address.address_detail %>\n                    <%= (address.distance == -1 || address.distance == undefined) ? \'\' : \' | 约\' + (address.distance > 1000 ? (address.distance / 1000).toFixed(2) + \'km\' : address.distance + \'m\') %>\n                </b>\n            </span>\n        <% } else { %>\n            <span class="js-address c-gray-dark">\n                请选择商户提货地址\n            </span>\n        <% } %>\n    </div>\n    <div class="clearfix block-item <%= orderState >= 3 ? \'\' : \'arrow\' %>">\n        <label>提货时间：</label>\n        <input type="text" class="txt txt-black ellipsis js-datetime" placeholder="请选择提货时间" readonly="readonly" value="<%= address.user_time %>">\n    </div>\n</div>\n'}),define("wap/components/address/views/logistics_selffetch",["require","underscore","backbone","bower_components/pop/pop_page","wap/components/address/collection/selffetch_address_collection","wap/components/datetime_picker/main","wap/components/address/views/logistics_address_selffetch_list","text!wap/components/address/templates/selfFetchAddressPanel.html","zenjs/util/local_storage"],function(e){var t=e("underscore"),s=e("backbone"),i=e("bower_components/pop/pop_page"),n=window.motify,o=e("wap/components/address/collection/selffetch_address_collection"),a=e("wap/components/datetime_picker/main"),r=e("wap/components/address/views/logistics_address_selffetch_list"),d=e("text!wap/components/address/templates/selfFetchAddressPanel.html"),c=function(){},l=e("zenjs/util/local_storage");return s.View.extend({template:t.template(d),initialize:function(e){e=e||{};var s=(e.defaultAddress||{}).self_fetch,i=t.isEmpty(e.currentAddress)?null:e.currentAddress;this.address=i||s||window._global.selffetchAddress,this.order_state=window._global.order_state,this.not_saveToSever=e.not_saveToSever,this.onAddressChanged=e.onAddressChanged||c,this.onChangeAddressClick=e.onChangeAddressClick||c,this.selffetchCollection=new o},events:{"click .js-datetime":"onDateTimeClicked","click .js-address":"onAddressClicked","click .js-tel":"onInputClicked","click .js-name":"onInputClicked"},render:function(){return this.show(),this},show:function(e){e=e||{},e.order_state&&(this.order_state=e.order_state,this.address.user_time=this.address.user_time||e.user_time,this.address.user_tel=this.address.user_tel||e.user_tel,this.address.user_name=this.address.user_name||e.user_name),this.$el.removeClass("hide"),this.address&&0!==this.address.length?this.onAddressChange({address:this.address,not_saveToSever:e.not_saveToSever}):this.renderPanel(),this.order_state>=3&&(this.$(".js-edit-address").removeClass("express-panel-edit").removeClass("js-edit-address"),this.$("input").attr("disabled","disabled"))},renderPanel:function(){var e=this.address||{},t=JSON.parse(l.getItem("last_selffetch_user_info"))||{};this.$el.html(this.template({address:e,addressName:this.$el.find(".js-name").val()||e.user_name||t.user_name,addressTel:this.$el.find(".js-tel").val()||e.user_tel||t.user_tel,orderState:this.order_state}))},getAddress:function(){return this.address},onInputClicked:function(e){this.order_state>=3&&n.log("该订单已生成，不再支持修改提货信息")},onDateTimeClicked:function(){if(this.order_state>=3)return void n.log("该订单已生成，不再支持修改提货信息");if(!this.address)return void n.log("请先选择提货地址再选择提货时间～");var e=this.currDateTime&&this.currDateTime.split(" "),s=this.address.business_hours_advanced||[];0===s.length&&(s=[{open_time:"00:00",close_time:"23:59",weekdays:["周日","周一","周二","周三","周四","周五","周六"]}]),this.datetimePickerPopPage=new i({nPageContents:[$("#js-page-content")],el:$("#js-datetime-picker-poppage"),contentViewClass:a,contentViewOptions:{business_hours:s,onDateTimeChange:t(this.onDateTimeChange).bind(this),currDateStr:e&&e[0],currTimeStr:e&&e[1].split("-")[0]}}).render().show()},onDateTimeChange:function(e){this.currDateTime=e,this.$el.find(".js-datetime").val(e)},onAddressClicked:function(e){return this.order_state>=3?void n.log("该订单已生成，不再支持修改提货信息"):(this.onChangeAddressClick("self-fetch",e),void(this.addressListView=new i({nPageContents:[$("#js-page-content")],el:$("#js-address-poppage"),contentViewClass:r,contentViewOptions:{onAddressChange:t(this.onAddressChange).bind(this),onLocationChange:t(this.onLocationChange).bind(this),
selectedAddress:this.address,collection:this.selffetchCollection,currCity:this.currCity,locationCity:this.locationCity,onCityNameChange:t(this.onCityNameChange).bind(this)}}).render().show()))},onLocationChange:function(e){this.locationCity=e},onAddressChange:function(e){e=e||{};var t=e.address;this.address=t||{},this.currDateTime="",this.renderPanel();var s=$.extend({},t);delete s.business_hours_advanced,delete s.image,this.syncAddress(window._global.order_no,e.address.id,s,e.not_saveToSever)},syncAddress:function(e,t,i,o){var a=this,r={order_no:e,express_type:t,address:i},d={address:r};return s.EventCenter.trigger("address:beforeExpressSend",d),o||this.not_saveToSever?void s.EventCenter.trigger("address:change"):void $._ajax({url:"/v2/trade/selffetch/book.json",type:"POST",dataType:"json",timeout:5e3,data:d,beforeSend:function(){},success:function(e){var t=e.code;e&&0==e.code?(s.EventCenter.trigger("address:change"),a.onAddressChanged({logisticsWay:"self-fetch",isResetPriceData:!0,data:e.data}),a.$(".js-datetime").val("尽快到店提货")):3e4===t?s.EventCenter.trigger("address:book:error",e.data||{}):31004===t?(a.selffetchCollection.fetch({city_code:a.selffetchCollection.cityCode}),n.log(e.msg||"自提点不存在,请重新选择")):31001===t?(n.log("该订单已生成，不再支持修改提货信息"),setTimeout(function(){window.location.reload()},1e3)):n.log("地址切换失败，重试一下~"+e.msg)},error:function(e,t,s){},complete:function(e,t){}})},onCityNameChange:function(e){this.currCity=e}})}),define("wap/trade/new_order/components/address/logistics_selffetch_kdt",["wap/components/address/views/logistics_selffetch"],function(e){return e.extend({show:function(e){if(e=e||{},e.order_state&&(this.order_state=e.order_state,this.address.user_time=this.address.user_time||e.user_time,this.address.user_tel=this.address.user_tel||e.user_tel,this.address.user_name=this.address.user_name||e.user_name),this.$el.removeClass("hide"),this.renderPanel(),this.order_state>=3)Backbone.EventCenter.trigger("address:has"),this.$(".js-edit-address").removeClass("express-panel-edit").removeClass("js-edit-address"),this.$("input").attr("disabled","disabled");else if(this.address){var t=$.extend({},this.address);delete t.business_hours_advanced,delete t.image,this.syncAddress(window._global.order_no,this.address.id,t,e.not_saveToSever)}},syncAddress:function(e,t,s,i){var n=this,o={express_type:"self-fetch",address:s};return Backbone.EventCenter.trigger("address:beforeExpressSend",o),i||this.not_saveToSever?(Backbone.EventCenter.trigger("address:change"),void n.onAddressChanged({logisticsWay:"self-fetch",address:s,isResetPriceData:!1})):void $.ajax({url:"/v2/trade/bill/show.json",type:"POST",dataType:"json",timeout:5e3,data:{book_key:window._global.book_key,bill_cart:window._global.bill_cart,bill_data:window._global.bill_data,address:o},success:function(e){e=e||{};var t=+e.code;0==t?(Backbone.EventCenter.trigger("address:change"),n.onAddressChanged({logisticsWay:"self-fetch",address:s,isResetPriceData:!0,data:e.data}),n.$(".js-datetime").val("尽快到店提货")):31004===t?(n.selffetchCollection.fetch({city_code:n.selffetchCollection.cityCode}),motify.log(e.msg||"自提点不存在,请重新选择")):31001===t?(motify.log("该订单已生成，不再支持修改提货信息"),setTimeout(function(){window.location.reload()},1e3)):101900001===t?(motify.log("订单信息已更新，页面刷新中~"),window.location.reload()):motify.log("地址切换失败，重试一下~"+e.msg)},fail:function(){motify.log("地址切换出了点问题，请重试一下~")},complete:function(){Backbone.EventCenter.trigger("address:sync:complete")}})}})}),define("wap/components/address/config",[],function(){var e=window._global;return{permissions:{wxAddress:e.wxaddress_env,wxPay:e.wxpay_env}}}),define("wap/components/address/views/logistics_express_wx",["wap/components/address/views/logistics_express","wap/components/util/address"],function(e,t){return e.extend({onEditExpressClicked:function(e){!wxReady||window._global.order_state>=3||(this.onChangeAddressClick("express",e),wxReady(_(function(){wxBridge.openAddress&&wxBridge.openAddress(_(function(e){var t=e.err_msg||e.errMsg;if("edit_address:ok"===t||"openAddress:ok"===t){var s=Utils.getPureKdtAddressData(e);s?(s.is_weixin=!0,this.onAddressChange({address:s})):motify.log("地址数据错误")}}).bind(this),_(function(e){var t=e.err_msg||e.errMsg,s=e.err_desc||"";if("openAddress:fail"!=t&&("edit_address:fail"!==t||s)){if("edit_address:cancel"===t)return;var i="err_msg:"+t+".";return s&&(i+="err_desc:"+s+"."),void motify.log(i)}}).bind(this))}).bind(this)))}})}),define("zenjs/util/event",["require","jquery"],function(e){var t=e("jquery"),s={getTargetByDataKey:function(e,s){for(var i=t(e.target);!i.data(s)&&0!==i.data(s)&&"BODY"!=(i[0]||{}).nodeName;)i=i.parent();return i},getEventHandler:function(){var e=function(){};return t.extend(!0,e.prototype,s.methods),new e},methods:{events:{},on:function(e,t){return"string"!=typeof e||"[object Function]"!==Object.prototype.toString.call(t)?!1:(this.events[e]||(this.events[e]=[]),this.events[e].push(t))},trigger:function(e){if("string"!=typeof e)return!1;if(!this.events[e])return this.events[e]=[],!1;for(var t=this.events[e],s=Array.prototype.slice.apply(arguments,[1]),i=0,n=t.length;n>i;i++)t[i](s)},off:function(e,t){if(!e&&!t)return void(this.events={});if(!t)return void(this.events[e]=[]);var s=this.events[e],i=s.indexOf(t);s.splice(i,1)}}};return s}),define("zenjs/backbone/tabber",["require","../util/event","backbone"],function(e){var t=e("../util/event"),s=e("backbone"),i=function(){},n=s.View.extend({initialize:function(e){this.activeKey=e.activeKey||"type",this.activeClass=e.activeClass||"active",this.hashAsDefaultData=e.hashAsDefaultData?!0:!1,this.cbOnClicked=e.onClicked||i,this.cbOnDisabledClicked=e.onDisabledClicked||i,this.initDefault(e)},events:{click:"onClicked"},initDefault:function(e){var t=s.history.getHash();e.hashAsDefaultData&&t?this.active(t):e.defaultData&&e.defaultData.length>0&&this.active(e.defaultData)},onClicked:function(e){if(e.target&&0!==e.target.length){var s=t.getTargetByDataKey(e,this.activeKey),i=""+s.data(this.activeKey);if(void 0===this.firstClick?this.firstClick=!0:this.firstClick=!1,s.blur(),i&&"undefined"!==i&&this.activeData!==i&&i&&i.length>0){if(this.disabled===!0)return void(this.activeData!==i&&this.cbOnDisabledClicked());if(this.hashAsDefaultData){var n=location.href.replace(/(javascript:|#).*$/,"");location.replace(n+"#"+i)}this.$("."+this.activeClass).removeClass(this.activeClass),s.addClass(this.activeClass),this.activeData=i,this.cbOnClicked(_.extend(e||{},{value:i,nTarget:s}))}}},active:function(e,t){this.onClicked(_.extend({target:this.$el.find("[data-"+this.activeKey+'="'+e+'"]:first')},t||{}))},setDisable:function(e){this.disabled=e},setData:function(e){this.activeData=e,this.$("."+this.activeClass).removeClass(this.activeClass),this.$el.find("[data-"+this.activeKey+'="'+this.activeData+'"]:first').addClass(this.activeClass)},getData:function(){return this.activeData}});return n}),define("text!wap/components/address/templates/index.html",[],function(){return'<div class="logistics">\n	<div class="js-logistics-select tabber tabber-n2 tabber-ios tabber-ios-gray-darker">\n		<a href="javascript:void(0);" class="active" data-type="express">快递配送</a>\n		<a href="javascript:void(0);" class="js-tabber-self-fetch hide" data-type="self-fetch">到店自提</a>\n	</div>\n</div>\n<div class="js-logistics-content logistics-content js-express"></div>\n<div class="js-logistics-content logistics-content js-self-fetch hide"></div>\n<div class=\'js-logistics-tips logistics-tips font-size-12 c-orange hide\'>很抱歉，该地区暂不支持配送。</div>'}),define("wap/components/address/main",["wap/components/address/config","wap/components/address/views/logistics_express","wap/components/address/views/logistics_express_wx","wap/components/address/views/logistics_selffetch","zenjs/backbone/tabber","text!wap/components/address/templates/index.html"],function(e,t,s,i,n,o){return Backbone.View.extend({initialize:function(n){this.$el.html(o),n=n||{},this.onAddressChanged=n.onAddressChanged||function(){},this.onChangeAddressClick=n.onChangeAddressClick||function(){},this.onWxAddressFailed=n.onWxAddressFailed||function(){},this.not_saveToSever=n.not_saveToSever,"undefined"!=typeof n.isSelfFetch?this.defaultLogistics=n.isSelfFetch?"self-fetch":"express":this.defaultLogistics=window._global.expressType>0?"self-fetch":"express",this.currentAddress=n.currentAddress,this.defaultAddress=n.defaultAddress,this.expressOptions=n.expressOptions;var a=n.logisticsExpressKdtView||t,r=n.logisticsExpressWxView||s;this.LogisticsSelfFetchKdtView=n.logisticsSelfFetchKdtView||i;var d=window.navigator.userAgent,c=d.match(/MicroMessenger\/(\d+(\.\d+)*)/),l=null!==c&&c.length,h=l?parseFloat(c[1]):0;!l||5>h||!e.permissions.wxAddress?this.LogisticsExpressView=a:this.LogisticsExpressView=r,this.logisticsExpressKdtView=a,this.logisticsViews={express:null,"self-fetch":null},this.tabberContainer=this.$(".js-logistics-select"),window._global.allow_self_fetch&&"self-fetch"!==this.defaultLogistics?this.tabberContainer.find(".js-tabber-self-fetch").removeClass("hide"):this.tabberContainer.parent().addClass("hide")},render:function(){return this.tabberContainer.hasClass("hide")||(this.tabber=new n({el:this.tabberContainer,activeClass:"active",activeKey:"type",defaultData:this.defaultLogistics,onClicked:_(this.onTabberClicked).bind(this),onDisabledClicked:_(this.onDisabledTabberClicked).bind(this)}),this.tabber.setDisable(window._global.order_state>2)),this},onTabberClicked:function(e){var t=e.value;if(this.logisticsWay=t,Backbone.EventCenter.trigger("address:beforeSwitchType"),this.$(".js-logistics-content").addClass("hide"),this.hideErrorTips(),this.logisticsViews[t])this.logisticsViews[t].show(e),this.$(".js-"+t).removeClass("hide");else{var s="express"==t?this.LogisticsExpressView:this.LogisticsSelfFetchKdtView,i=null;t===this.defaultLogistics&&(i=this.currentAddress);var n=new s({onAddressChanged:this.onAddressChanged,onChangeAddressClick:this.onChangeAddressClick,not_saveToSever:this.not_saveToSever,expressOptions:this.expressOptions,allow_self_fetch:window._global.allow_self_fetch,currentAddress:i,defaultAddress:this.defaultAddress,showErrorTips:_(this.showErrorTips).bind(this),hideErrorTips:_(this.hideErrorTips).bind(this)});"express"===t&&this.listenTo(n,"wx-address:error",_(this.onWxAddressError).bind(this)),this.logisticsViews[t]=n,this.$(".js-"+t).html(n.render().el).removeClass("hide")}},onDisabledTabberClicked:function(){motify.log("您不能再修改配送方式")},onPayOrderCreated:function(e){e=e||{},this.$(".js-edit-address").hide();var t=window._global.order_state>2?window._global.order_state:3,s=_.extend(e,{order_state:t,not_saveToSever:!0});this.tabber.setDisable(!0),this.logisticsViews[this.logisticsWay].show(s)},getAddress:function(){return this.logisticsViews[this.logisticsWay].getAddress()},onWxAddressError:function(e){this.logisticsViews.express&&this.logisticsViews.express.remove();var t=new this.logisticsExpressKdtView({onAddressChanged:this.onAddressChanged,onChangeAddressClick:this.onChangeAddressClick,not_saveToSever:this.not_saveToSever,expressOptions:this.expressOptions,allow_self_fetch:window._global.allow_self_fetch});this.logisticsViews.express=t,this.$(".js-express").html(t.render().el).removeClass("hide"),this.logisticsViews.express.onEditExpressClicked(),this.onWxAddressFailed(e)},hideErrorTips:function(){this.$(".js-logistics-tips").addClass("hide")},showErrorTips:function(e){this.$(".js-logistics-tips").html(e).removeClass("hide")}})}),define("wap/trade/new_order/containers/address/index",["require","../../components/address/logistics_express_kdt","../../components/address/logistics_express_wx","../../components/address/logistics_selffetch_kdt","wap/components/address/main","../../models/address"],function(e){var t=e("../../components/address/logistics_express_kdt"),s=e("../../components/address/logistics_express_wx"),i=e("../../components/address/logistics_selffetch_kdt"),n=e("wap/components/address/main");e("../../models/address");return Backbone.View.extend({initialize:function(e){this.orderModel=e.orderModel,this.initData(),this.initComponentsView(),this.initListener()},initData:function(){this.model=this.orderModel.get("address")},initComponentsView:function(){var e=this.$el,o=this.orderModel.get("order_no"),a=this.model.get("address"),r=this.model.get("defaultAddress"),d=this.model.get("extra"),c=this.model.get("express_type");a="self-fetch"==c?$.extend({},a,d):$.extend({},a);var l={el:e,onAddressChanged:_(this.onAddressChanged).bind(this),onChangeAddressClick:function(e){window.Logger.log({fm:"click",title:"address_change",address:e})},logisticsExpressKdtView:t,logisticsExpressWxView:s,logisticsSelfFetchKdtView:i,onWxAddressFailed:_(this.onWxAddressFailed).bind(this),not_saveToSever:!!o,isSelfFetch:window._global.is_self_fetch,currentAddress:a,defaultAddress:r,expressOptions:{notAutoPopAddress:!0,saveAddressToServer:!0,saveAddressUrl:window._global.url.trade+"/trade/order/address.json"}};e.length>0&&(this.expressWaysView=new n($.extend({},l)))},initListener:function(){this.listenTo(this.orderModel,"change:order_no",_(this.onOrderCreateSuccess).bind(this)),Backbone.EventCenter.on("address:beforeExpressSend",_(this.beforeAddressChange).bind(this)),Backbone.EventCenter.on("address:beforeSwitchType",_(this.beforeAddressSwitch).bind(this)),Backbone.EventCenter.on("address:sync:complete",_(this.afterAddressSync).bind(this)),Backbone.EventCenter.on("address:change",_(this.afterAddressChange).bind(this)),Backbone.EventCenter.on("address:has",_(this.alreadyHasAddress).bind(this))},render:function(){this.expressWaysView?this.expressWaysView.render():Backbone.EventCenter.trigger("address:has");var e=this.orderModel.get("order_no");e&&this.onOrderCreateSuccess()},onAddressChanged:function(e){if(Backbone.EventCenter.trigger("order_change",{type:"change_address",data:{logisticsWay:e.logisticsWay,address:e.address,extra:{}}}),e.isResetPriceData){var t=e.data||{},s=t.shop_result_list[0]||{},i=s.order_payment||{};Backbone.EventCenter.trigger("order_change",{type:"reset_goods_list",data:{goods_list:s.order_item_list||[],all_postage_info:s.postage_result||{},shop_name:s.shop_name||"",store_name:s.store_name||"",postage:i.postage,decrease:i.decrease||0,item_pay:i.item_pay}}),Backbone.EventCenter.trigger("order_change",{type:"reset_coupons_list",data:{coupons:s.charge_coupon}}),Backbone.EventCenter.trigger("order_change",{type:"reset_unavailable_goods_list",data:{goods_list:s.unavailable_item_list||[]}});var n=t.show_pay_result||{};Backbone.EventCenter.trigger("order_change",{type:"set_pay_status",data:{forbid_pay:n.forbid_pay||!1,msg_data:{pay_msg:n.pay_msg||"",show_msg:n.show_msg||""}}}),Backbone.EventCenter.trigger("order_change",{type:"reset_order_data"}),Backbone.EventCenter.trigger("order_change",{type:"reset_ecard_data",data:{order_price:this.orderModel.getFinalPriceWithoutEcard()}});var o=t.pay_ways_list||{};Backbone.EventCenter.trigger("order_change",{type:"reset_pay_ways",data:{payWays:o.pay_ways,innerPayWays:o.inner_pay_ways}}),Backbone.EventCenter.trigger("order_change",{type:"reset_order_data"})}Backbone.EventCenter.trigger("order_render","address")},onWxAddressFailed:function(e){$._ajax({url:window._global.url.trade+"/trade/common/log.json",type:"POST",dataType:"json",data:$.extend({},e,{error_type:"wx_address"},window._global.address_token_log||{})})},prepareOrderData:function(){var e=this.model.get("express_type");if("self-fetch"===e){var t=$(".js-self-fetch .js-name").val().trim(),s=$(".js-self-fetch .js-tel").val().trim(),i=$(".js-self-fetch .js-datetime").val().trim();Backbone.EventCenter.trigger("order_change",{type:"reset_address_extra_data",data:{extra:{user_name:t,user_time:i,user_tel:s}}})}},onOrderCreateSuccess:function(){this.expressWaysView&&this.expressWaysView.onPayOrderCreated($.extend({},this.model.get("extra")))},beforeAddressChange:function(){Backbone.EventCenter.trigger("order_change",{type:"before_address_change"}),Backbone.EventCenter.trigger("order_change",{type:"after_address_set"})},beforeAddressSwitch:function(){Backbone.EventCenter.trigger("order_change",{type:"clear_address_info"}),Backbone.EventCenter.trigger("order_change",{type:"before_address_change"})},afterAddressSync:function(){Backbone.EventCenter.trigger("order_change",{type:"complete_address_sync"})},afterAddressChange:function(){Backbone.EventCenter.trigger("order_change",{type:"after_address_change"}),Backbone.EventCenter.trigger("order_change",{type:"complete_address_sync"})},alreadyHasAddress:function(){Backbone.EventCenter.trigger("order_change",{type:"after_address_set"}),Backbone.EventCenter.trigger("order_change",{type:"after_address_change"}),Backbone.EventCenter.trigger("order_change",{type:"complete_address_sync"})}})}),define("zenjs/util/url_helper",[],function(){var e={site:function(e,t){var s=window._global.env,i=window._global.url;"static"===t&&"online"===s&&(t="cdn_static");var n=e;return t=t?i[t]||"":"",-1==e.search(/^http[s]?\:\/\//)&&("/"!==e[0]&&(e="/"+e),n=t+e),n},getCdnImageUrl:function(e,t){if(!e)return window._global.url.cdn_static+"/image/wap/no_pic.png";if(t=e.match(/.+\!\d+x\d+.+/)?"":t&&t.length>0?t:"!100x100.jpg",e.match(/^(https?:)?\/\//i)){for(var s=[/^(https?:)?\/\/imgqn.koudaitong.com/,/^(https?:)?\/\/kdt-img.koudaitong.com/,/^(https?:)?\/\/img.yzcdn.cn/,/^(https?:)?\/\/dn-kdt-img.qbox.me/],i=0;i<s.length;i++)e=e.replace(s[i],window._global.url.imgqn);return e+t}return window._global.url.imgqn+"/"+e+t}};return e}),define("wap/trade/message_view",[],function(){return Backbone.View.extend({initialize:function(e){this.onHide=e.onHide||function(){},this.nTarget=e.nTarget},render:function(){var e=this.nTarget.parents(".js-goods-item").find(".js-message");e.length>0?this.$(".js-message-container").html(e.clone().html()):(this.$(".js-message-container").hide(),this.$("h2").hide()),$(".js-cancel").on("click",this.hide.bind(this))},hide:function(){$(".js-cancel").off("click",this.hide),this.onHide()}})}),define("text!wap/trade/new_order/components/goods_list/templates/item.html",[],function(){return'<a href="javascript:;" class="thumb">\n    <img class="js-view-image" src="<%= URLHelper.getCdnImageUrl(data.img_url, \'!100x100.jpg\') %>" alt="<%= data.title %>">\n    <% if (data.is_present) { %><h2 class="goods-list-present-title"></h2><% } %>\n</a>\n<div class="detail">\n    <div class="clearfix detail-row">\n        <div class="right-col">\n            <% if (is_points){ %>\n                <div class="price font-size-12"><span><%= data.points_price %></span>积分</div>\n            <% } else { %>\n                <div class="price">￥<span><%= parseFloat(data.pay_price/100, 10).toFixed(2) %></span></div>\n            <% } %>\n        </div>\n        <div class="left-col">\n            <a href="javascript:;">\n                <h3 class="l2-ellipsis"><%= data.title %></h3>\n            </a>\n        </div>\n    </div>\n\n    <div class="clearfix detail-row">\n        <div class="right-col">\n            <div class="num c-gray-darker">×<span class="num-txt"><%= data.num %></span></div>\n        </div>\n        <div class="left-col">\n            <p class="c-gray-darker ellipsis">\n                <%= getSkuStr(data.sku) %>\n            </p>\n        </div>\n    </div>\n\n    <div class="clearfix detail-row">\n        <div class="right-col">\n            <div class="goods-action">\n                <% if (data.message){ %>\n                    <a class="tag tag-white tag-opt js-show-message" href="javascript:;">查看留言</a>\n                <% } %>\n            </div>\n        </div>\n    </div>\n    \n</div>\n\n<% if (data.message){ %>\n    <ul class="js-message hide">\n        <% _.each(data.message, function(value, title) { %>\n            <li class="block-item">\n                <label style="vertical-align:top;" class="c-gray"><%= title %>：</label>\n                <% if (/^\\s*http(s)*:\\/\\/.+/.test(value)) { %>\n                    <a style="margin-left:0;height:70px;" href="<%= value %>">\n                    <img style="width:70px;height:70px;" width="70" height="70" src="<%= value %>!100x100.jpg" />\n                    </a>\n                <% } else { %>\n                    <span><%= value %></span>\n                <% } %>\n            </li>\n        <% }) %>\n    </ul>\n<% } %>'}),define("wap/trade/new_order/components/goods_list/views/item",["require","zenjs/util/url_helper","bower_components/pop/pop_page","wap/trade/message_view","text!../templates/item.html"],function(e){var t=e("zenjs/util/url_helper"),s=e("bower_components/pop/pop_page"),i=e("wap/trade/message_view"),n=e("text!../templates/item.html");return Backbone.View.extend({initialize:function(e){this.is_points=e.is_points},template:_.template(n),className:function(){return"js-goods-item name-card name-card-goods clearfix"},events:{"click .js-show-message":"onShowMessageClicked"},render:function(){this.$el.html(this.template({data:this.model.toJSON(),is_points:this.is_points,getSkuStr:this.getSkuStr,URLHelper:t}))},getSkuStr:function(e){var t="";if(e){var s=[];_.each(e,function(e){e.v&&s.push(e.v)}),t=s.join(", ")}return t},onShowMessageClicked:function(e){this.messagePopPage=new s({nPageContents:[$("#js-page-content")],el:$("#sku-message-poppage"),contentViewClass:i,contentViewOptions:{nTarget:$(e.target)}}).render().show()}})}),define("text!wap/trade/new_order/components/goods_list/templates/message.html",[],function(){return'<% if (stopEditing) { %>\n    <span class="">买家留言：</span><p class="message-content"><%= msg ? msg : \'无\' %></p>\n<% } else { %>\n    <span class="">买家留言：</span>\n    <div class="input-wrapper">\n    	<textarea class="js-msg-container" placeholder="点击给商家留言"><%= msg %></textarea>\n    </div>\n<% } %>\n'}),define("wap/trade/new_order/components/goods_list/views/message",["require","wap/components/util/valid","text!../templates/message.html"],function(e){e("wap/components/util/valid");var t=e("text!../templates/message.html"),s=_.template(t);return Backbone.View.extend({initialize:function(e){this.el=e.el,this.initMsg=e.msg||"",this.msg=this.initMsg},events:{"focus .js-msg-container":"onMsgFocus","blur .js-msg-container":"onMsgBlur"},render:function(){return this.$el.html(s({stopEditing:this.stopEditing,msg:this.msg})),this},onMsgFocus:function(){this.stopEditing||(window.Logger.log({fm:"click",title:"order_message"}),this.$(".js-msg-container").addClass("two-rows"))},onMsgBlur:function(){this.$(".js-msg-container").removeClass("two-rows")},disableChange:function(){var e=this.getMsg();e.msg||this.$el.addClass("hide"),this.stopEditing=!0,this.render()},getMsg:function(){var e={};return this.stopEditing?e.msg=this.msg:(e.msg=this.$(".js-msg-container").val()||"",this.msg=e.msg),e},hideContainer:function(){this.$el.addClass("hide")},showContainer:function(){this.$el.removeClass("hide")}})}),define("text!wap/trade/new_order/components/goods_list/templates/header.html",[],function(){return'<a class="font-size-14" href="<%= getShopUrl() %>"><%= data.store_name ? data.store_name : data.shop_name %></a>\n<% if (data.team_certificate_gf >= 6) { %> \n    <img src="//su.yzcdn.cn/v2/image/account/icon_guan_160421.png">\n<% } %> \n'}),define("wap/trade/new_order/components/goods_list/views/header",["require","zenjs/util/url_helper","text!../templates/header.html"],function(e){var t=e("zenjs/util/url_helper"),s=e("text!../templates/header.html"),i=_.template(s);return Backbone.View.extend({initialize:function(e){this.team_certificate_gf=e.team_certificate_gf,this.kdt_id=e.kdt_id,this.setData({shop_name:e.shop_name,store_name:e.store_name})},render:function(e){this.$el.html(i({data:{shop_name:this.shop_name,store_name:this.store_name,team_certificate_gf:this.team_certificate_gf},getShopUrl:_(this.getShopUrl).bind(this)}))},getShopUrl:function(){return t.site("/showcase/homepage?kdt_id="+this.kdt_id,"wap")},setData:function(e){this.shop_name=e.shop_name||"",this.store_name=e.store_name||""},doEmptyGoods:function(){this.$el.addClass("empty-goods-header")},doHaveGoods:function(){this.$el.removeClass("empty-goods-header")}})}),define("text!wap/trade/components/postage_info/templates/info.html",[],function(){return'<div class="postage-info">\n    <div class="header">\n        了解配送方式\n        <span class="js-close close"></span>\n    </div>\n\n    <div class="block block-list border-0">\n        <% _.each(data, function(item){ %>\n            <div class="block-item">\n                <ul class="goods-pics">\n                    <% _.each(item.goods, function(goods){ %>\n                        <li class="goods-pic">\n                            <img  class="" src="<%= utils.getCdnImageUrl(goods.image_url || goods.img_url, \'!200x200.jpg\') %>">\n                        </li>\n                    <% }) %>\n                </ul>\n                <p class="desc">\n                    <%= item.postage_desc || getDefaultDesc(item.postage) %>\n                </p>\n            </div>\n        <% }) %>\n    </div>\n</div>\n'}),define("wap/trade/components/postage_info/views/utils",["require"],function(e){return{getCdnImageUrl:function(e,t){if(!e)return window._global.url.cdn_static+"/image/wap/no_pic.png";if(t=e.match(/.+\!\d+x\d+.+/)?"":t&&t.length>0?t:"!100x100.jpg",e.match(/^(https?:)?\/\//i)){for(var s=[/^(https?:)?\/\/imgqn.koudaitong.com/,/^(https?:)?\/\/kdt-img.koudaitong.com/,/^(https?:)?\/\/img.yzcdn.cn/,/^(https?:)?\/\/dn-kdt-img.qbox.me/],i=0;i<s.length;i++)e=e.replace(s[i],window._global.url.imgqn);return e+t}return window._global.url.imgqn+"/"+e+t}}}),define("wap/trade/components/postage_info/views/info",["require","text!../templates/info.html","./utils"],function(e){var t=e("text!../templates/info.html"),s=e("./utils");return Backbone.View.extend({initialize:function(e){e=e||{},this.data=e.data||{}},render:function(e){this.$el.html(_.template(t)({data:this.data,utils:s,getDefaultDesc:this.getDefaultDesc}))},getDefaultDesc:function(e){var t="";return t=0==e?"由商家选择合作快递为您服务，免运费":"由商家选择合作快递为您服务，运费"+parseFloat(e/100).toFixed(2)+"元"}})}),define("wap/trade/components/postage_info/index",["require","bower_components/pop/popup","./views/info"],function(e){var t=e("bower_components/pop/popup"),s=e("./views/info");return{popView:null,show:function(e,i){this.popView=new t({contentViewClass:s,contentViewOptions:{data:e}}).render().show()},hide:function(){this.popView&&this.popView.hide()}}}),define("text!wap/trade/new_order/components/goods_list/templates/express.html",[],function(){return"<span class=\"left-part\">配送方式</span>\n<div class=\"js-express-info right-part c-gray-darker \n			<%= data.express_way == 'self-fetch' ? '' : 'arrow' %>\">\n	<p>\n		<%= data.express_fee %>\n	</p>\n	<p class=\"font-size-12\">\n		<%= data.express_way_text %>\n	</p>\n</div>"}),define("wap/trade/new_order/components/goods_list/views/express",["require","wap/trade/components/postage_info/index","text!../templates/express.html"],function(e){var t=e("wap/trade/components/postage_info/index"),s=e("text!../templates/express.html"),i=_.template(s);return Backbone.View.extend({initialize:function(e){this.setData(e)},render:function(e){this.$el.html(i({data:{express_way:this.express_way,express_way_text:this.getExpressText(),express_fee:0==this.express_fee?"免运费":"￥"+(this.express_fee/100).toFixed(2)}})),this.express_way?this.$el.removeClass("hide"):this.$el.addClass("hide")},events:{"click .js-express-info":"onExpressInfoClicked"},onExpressInfoClicked:function(e){"self-fetch"!=this.express_way&&t.show(this.postage_info||[])},setData:function(e){this.express_way=e.express_way||"",this.express_fee=e.express_fee||0,this.postage_info=e.postage_info||[],this.delivery_desc=e.delivery_desc||[]},getExpressText:function(){var e=this.delivery_desc||[];return e.join(" + ")},hideContainer:function(){this.$el.addClass("hide")},showContainer:function(){this.$el.removeClass("hide")}})}),define("text!wap/trade/new_order/components/goods_list/templates/total.html",[],function(){return'合计\n<span class="c-orange pull-right js-sum-price">\n    ￥<%= (total/100).toFixed(2) %>\n</span>'}),define("wap/trade/new_order/components/goods_list/views/total",["require","text!../templates/total.html"],function(e){var t=e("text!../templates/total.html"),s=_.template(t);return Backbone.View.extend({initialize:function(e){this.setData(e)},render:function(e){this.$el.html(s({total:parseInt(this.item_pay,10)+parseInt(this.postage,10)}))},setData:function(e){this.is_points=e.is_points,this.postage=e.postage||0,this.item_pay=e.item_pay||0,this.is_points&&(this.item_pay=0)},hideContainer:function(){this.$el.addClass("hide")},showContainer:function(){this.$el.removeClass("hide")}})}),define("text!wap/trade/new_order/components/goods_list/templates/empty_goods.html",[],function(){return'<div class="empty-icon"></div>\n<p class="empty-info center c-gray-dark">哎呀，当前没有可购买的商品，请重新选择～</p>\n<div class="empty-action center">\n	<a class="btn btn-white font-size-14 c-gray-darker" href="javascript:history.back();">返回重新选择</a>\n</div>'}),define("wap/trade/new_order/components/goods_list/views/empty_goods",["require","text!../templates/empty_goods.html"],function(e){var t=e("text!../templates/empty_goods.html"),s=_.template(t);return Backbone.View.extend({initialize:function(e){},render:function(e){this.$el.html(s())},hideContainer:function(){this.$el.addClass("hide")},showContainer:function(){this.$el.removeClass("hide")}})}),define("wap/trade/new_order/components/goods_list/index",["require","bower_components/zenlist/list","./views/item","./views/message","./views/header","./views/express","./views/total","./views/empty_goods"],function(e){var t=e("bower_components/zenlist/list"),s=e("./views/item"),i=e("./views/message"),n=e("./views/header"),o=e("./views/express"),a=e("./views/total"),r=e("./views/empty_goods");return Backbone.View.extend({expressInfoTpl:_.template('<p><%=data.express_fee %></p><p class="font-size-12"><%=data.express_way %></p>'),initialize:function(e){e=e||{},this.itemsCollection=e.items,this.is_points=e.is_points,this.postage=e.postage||0,this.item_pay=e.item_pay||0,this.nPostageInfo=this.$(".js-express-block"),this.headerView=new n({el:this.$(".js-header"),shop_name:e.shop_name||"",store_name:e.store_name||"",kdt_id:e.kdt_id,team_certificate_gf:e.team_certificate_gf});var d={el:this.$(".js-goods-list"),itemView:s,finishedHTML:" ",emptyHTML:" ",collection:this.itemsCollection,itemOptions:{is_points:this.is_points}};this.goodListView=new t(d),this.expressView=new o({el:this.$(".js-express-block"),express_way:e.expressWay,express_fee:this.postage,postage_info:e.postage_info||[],delivery_desc:e.delivery_desc||[]}),this.orderMessageView=new i({el:this.$(".js-order-message"),msg:e.msg}),this.totalPriceView=new a({el:this.$(".js-total"),item_pay:this.item_pay,is_points:this.is_points,postage:this.postage}),this.$el.append('<div class="js-empty-goods empty-goods hide"></div>'),this.emptyGoodsView=new r({el:this.$(".js-empty-goods")})},render:function(){this.headerView.render(),this.goodListView.render(),this.expressView.render(),this.orderMessageView.render(),this.totalPriceView.render(),this.emptyGoodsView.render()},renderPrice:function(){this.expressView.render(),this.totalPriceView.render(),this.headerView.render(),this.resolveEmptyGoodsList()},resetPriceData:function(e){this.postage=e.postage||0,this.item_pay=e.item_pay||0,this.expressView.setData({express_way:e.expressWay,express_fee:this.postage,postage_info:e.postage_info||[],delivery_desc:e.delivery_desc||[]}),this.totalPriceView.setData({item_pay:this.item_pay,postage:this.postage,is_points:this.is_points}),this.headerView.setData({shop_name:e.shop_name,store_name:e.store_name})},getOrderMsg:function(){var e=this.orderMessageView.getMsg();return e},disableChange:function(){this.orderMessageView.disableChange()},showMessageError:function(e){"phone"===e&&this.orderMessageView.showPhoneError()},hidePostageInfo:function(){this.nPostageInfo.addClass("hide")},resolveEmptyGoodsList:function(){0===this.itemsCollection.length?(this.headerView.doEmptyGoods(),
this.expressView.hideContainer(),this.orderMessageView.hideContainer(),this.totalPriceView.hideContainer(),this.emptyGoodsView.showContainer()):(this.headerView.doHaveGoods(),this.orderMessageView.showContainer(),this.totalPriceView.showContainer(),this.emptyGoodsView.hideContainer())}})}),define("wap/trade/new_order/containers/goods_list/index",["require","../../components/goods_list/index","../../models/goods_list"],function(e){var t=e("../../components/goods_list/index");e("../../models/goods_list");return Backbone.View.extend({initialize:function(e){this.orderModel=e.orderModel,this.team_certificate_gf=e.team_certificate_gf,this.initData(),this.initComponentsView(),this.initListener()},initData:function(){this.model=this.orderModel.get("goods_list")},initComponentsView:function(){var e=this.orderModel.get("address");this.goodsListView=new t({el:this.$el,shop_name:this.model.get("shop_name"),store_name:this.model.get("store_name"),expressWay:e.get("express_type"),kdt_id:this.orderModel.get("kdt_id"),items:this.model.get("items"),is_points:this.orderModel.get("is_points"),msg:this.model.get("msg"),delivery_desc:this.model.get("delivery_desc"),postage_info:this.model.get("postage_info"),team_certificate_gf:this.team_certificate_gf})},initListener:function(){this.listenTo(this.orderModel,"change:order_no",_(this.onOrderCreateSuccess).bind(this))},render:function(){this.goodsListView.render(),this.resetComponentPriceDataAndRender(),this.orderModel.get("order_no")&&this.onOrderCreateSuccess()},queueWalk:function(){var e=new $.Deferred;return this.resetComponentPriceDataAndRender(),0===this.model.getGoodsNum()?Backbone.EventCenter.trigger("order:hidePayContainer"):Backbone.EventCenter.trigger("order:shopPayContainer"),e.resolve(),e.promise()},resetComponentPriceDataAndRender:function(){var e=this.orderModel.get("address");this.goodsListView.resetPriceData({expressWay:e.get("express_type"),postage:this.model.get("postage"),decrease:this.model.get("decrease"),item_pay:this.model.get("item_pay"),postage_info:this.model.get("postage_info"),delivery_desc:this.model.get("delivery_desc"),shop_name:this.model.get("shop_name"),store_name:this.model.get("store_name")}),this.goodsListView.renderPrice()},prepareOrderData:function(){var e=this.goodsListView.getOrderMsg();Backbone.EventCenter.trigger("order_change",{type:"reset_goodslist_msg",data:{msg:e.msg}})},onOrderCreateSuccess:function(){this.goodsListView.disableChange()},showErrorTips:function(e){var t=e.type;"phone"==t&&this.goodsListView.showMessageError(t)},hidePostageInfo:function(){this.goodsListView.hidePostageInfo()}})}),define("wap/trade/components/coupon/model",[],function(){var e=Backbone.Model.extend({idAttribute:"m_id",defaults:{},initialize:function(e,t){}});return e}),define("wap/trade/components/coupon/collection",["./model"],function(e){var t=Backbone.Collection.extend({model:e,comparator:function(e,t){var s=(e.toJSON()||{}).value,i=(t.toJSON()||{}).value;return s>i?-1:1},findCoupon:function(e){return e&&e.id?this.find(function(t){var s=t.toJSON(),i=e||{};return s.id==i.id?!0:!1}):!1},findCouponByData:function(e){return this.find(function(t){var s=t.toJSON(),i=e||{};return s.id==i.id?!0:!1})}});return t}),define("text!wap/trade/components/coupon/templates/useCoupon.html",[],function(){return'<div class="info-panel info-panel-big clearfix">\n    <h4 class="left-part">优惠</h4>\n    <div class="js-right-part right-part <%= stopShowCouponSelector ? \'\' : \'arrow\' %>">\n	    <div class="js-normal-coupon detail c-gray-darker js-change-coupon" style="line-height: 1.6;">\n	        <span><%=couponData.name %></span>\n	        <p><%=couponData.condition %></p>\n	    </div>\n	</div>\n</div>'}),define("text!wap/trade/components/coupon/templates/availableCoupon.html",[],function(){return'<div class="info-panel info-panel-big clearfix">\n    <h4 class="left-part">优惠</h4>\n    <div class="js-right-part right-part <%= stopShowCouponSelector ? \'\' : \'arrow\' %>">\n	    <div class="js-normal-coupon detail c-gray-darker js-change-coupon">\n	    	<span>您有 <%=available %> 个可用优惠</span>\n	    </div>\n	</div>\n</div>'}),define("text!wap/trade/components/coupon/templates/emptyCoupon.html",[],function(){return'<div class="info-panel info-panel-big clearfix">\n    <h4 class="left-part">优惠</h4>\n    <div class="js-right-part right-part <%= stopShowCouponSelector ? \'\' : \'arrow\' %>">\n    	<div class="js-normal-coupon detail c-gray-darker js-change-coupon">\n    	    <span>使用优惠</span>\n    	</div>\n    </div>\n</div>\n'}),define("wap/trade/components/coupon/view/input_view",["require"],function(e){var t=function(){},s=Backbone.View.extend({events:{"click .js-valid-code":"onCodeSubmit","focus .js-code-txt":"hideTips"},initialize:function(e){e=e||{},this.useCoupon=e.useCoupon,this.couponCollection=e.collection,this.nCodeTxt=this.$(".js-code-txt"),this.nValidBtn=this.$(".js-valid-code"),this.nErrorTips=this.$(".js-error-tips"),this.getExtraCouponValidData=e.getExtraCouponValidData||t},getCode:function(){var e=this.nCodeTxt.val();return e=$.trim(e),e=e.replace(/\s/g,"")},onCodeSubmit:function(e){var t=this;e.preventDefault();var s=t.getCode();if(!s)return motify.log("请输入优惠码"),t.nCodeTxt.focus(),!1;var i=this.getExtraCouponValidData();$._ajax({url:"/v2/trade/bill/coupon.json",type:"POST",dataType:"json",timeout:8e3,cache:!1,data:$.extend({},i,{code:s}),beforeSend:function(){t.nValidBtn.text("验证中..."),t.nValidBtn.prop("disabled",!0)},success:function(e){if(0===e.code){var s=e.data||{};t.showCouponInfo(s)}else t.showTips(),t.nErrorTips.html(e.msg)},error:function(e,t,s){},complete:function(e,s){t.nValidBtn.text("兑换"),t.nValidBtn.prop("disabled",!1)}})},showTips:function(){this.nErrorTips.removeClass("hide")},hideTips:function(){this.nErrorTips.addClass("hide")},showCouponInfo:function(e){var t=this.collection.findCouponByData(e);if(t)motify.log("该优惠码您已经拥有，<br />已为您自动选中～");else{var s=this.collection.toJSON();this.collection.reset(s.concat([e])),t=this.collection.findCouponByData(e)}this.useCoupon(t)}});return s}),define("text!wap/trade/components/coupon/templates/couponItem.html",[],function(){return'<div class="label-check-img"></div>\n<div class="coupon-info">\n	<p class="font-size-12"><%=coupon.name %><em class="pull-right">-<%=(coupon.value/100).toFixed(2) %></em></p>\n	<p class="font-size-12 c-gray-darker">\n		<%=coupon.condition %>\n		<% if( coupon.end_at && coupon.end_at < 10 ){ %>\n			<em class="pull-right c-gray">即将过期</em>\n		<% } %>\n	</p>\n</div>\n\n'}),define("wap/trade/components/coupon/view/item_view",["text!../templates/couponItem.html"],function(e){var t=function(){},s=Backbone.View.extend({tagName:"li",className:"block-item coupon-item",template:_.template(e),events:{click:"onClick"},initialize:function(e){e=e||{},this.onItemClick=e.onItemClick||t},render:function(){var e=this.model.toJSON(),t=this.template({coupon:e});return this.$el.html(t),this},onClick:function(e){e.preventDefault();this.model.toJSON();this.onItemClick(this.model)}});return s}),define("bower_components/zenlist/sort_list",["require","exports","module","./list"],function(e,t,s){var i=e("./list");s.exports=i.extend({doSort:function(e){this.collection.sortConfig=e,this.collection.comparator=this._multiFieldComparator,this.collection.sort()},_multiFieldComparator:function(e,t){var s="asc"==this.sortConfig.order?1:-1;return e=e.get(this.sortConfig.field),t=t.get(this.sortConfig.field),e?t?e>t?1*s:t>e?-1*s:0:-1*s:1*s}})}),define("text!wap/trade/components/coupon/templates/selectorView.html",[],function(){return'<div class="js-scene-coupon-list">\n    <div class="header">\n        选择优惠\n        <span class="js-close close"></span>\n    </div>\n    \n    <div class="block block-list border-0">\n        <div class="js-code-inputer coupon-input-container block-item">\n            <input class="js-code-txt txt txt-coupon font-size-14" type="text" placeholder="请输入优惠码" autocapitalize="off" maxlength="20" />\n            <button class="js-valid-code coupon-valid btn btn-white font-size-14" type="button">兑换</button>\n            <p class="js-error-tips error-tips c-red ellipsis hide"></p>\n        </div>\n        <ul class="js-coupon-list coupon-list">\n    \n        </ul>\n    </div>\n    \n\n    \n\n</div>\n<div class="action-container coupon-action-container">\n    <button class="js-confirm-use-coupon btn btn-block btn-green" style="margin: 0px;">确定</button>\n</div>'}),define("wap/trade/components/coupon/view/selector_view",["./input_view","./item_view","bower_components/zenlist/sort_list","text!../templates/selectorView.html"],function(e,t,s,i){var n=function(){},o=Backbone.View.extend({initialize:function(e){e=e||{},this.onCouponChanged=e.onCouponChanged||n,this.getExtraCouponValidData=e.getExtraCouponValidData,this.selectedCoupon=null,this.none_coupon=e.none_coupon,this.default_coupon=e.none_coupon,this.currentCoupon=e.current_coupon,this.couponCollection=e.couponCollection},render:function(){return this.$el.append(i),this.couponInput=new e({el:this.$(".js-code-inputer"),collection:this.couponCollection,useCoupon:_(function(e){this.selectedCoupon=this.none_coupon,this.useCoupon(e)}).bind(this),getExtraCouponValidData:this.getExtraCouponValidData}),this.nCouponList=this.$(".js-coupon-list"),this.isEmptyList=!1,this.listOpt={el:this.$(".js-coupon-list"),itemView:t,finishedHTML:" ",emptyHTML:" ",collection:this.couponCollection,itemOptions:{onItemClick:_(this.useCoupon).bind(this)||n},onListEmpty:$.proxy(function(){this.isEmptyList=!0,this.nCouponList.addClass("border-top-0")},this),onViewItemAdded:$.proxy(function(){this.isEmptyList&&this.nCouponList.removeClass("border-top-0"),this.isEmptyList=!1},this)},this.couponList=new s(this.listOpt),this.couponList.render(),this.switchCoupon(this.currentCoupon),this.$(".js-confirm-use-coupon").click(_(this.confirmUseCoupon).bind(this)),this},notUse:function(){var e=this,t=e.none_coupon;this.useCoupon(t)},useCoupon:function(e){return this.selectedCoupon&&this.selectedCoupon==e&&e!=this.none_coupon?void this.notUse():(this.selectedCoupon=e,void this.show())},switchCoupon:function(e){this.selectedCoupon=this.none_coupon,this.useCoupon(e||this.none_coupon)},confirmUseCoupon:function(e){e.preventDefault(),e.stopPropagation(),this.onCouponChanged(this.selectedCoupon),this.onHide()},show:function(){var e=this.selectedCoupon;if(!e)return!1;this.$el.find(".coupon-item.active").removeClass("active");var t=this.couponList.getViewByModel(e);t&&t.$el.addClass("active")},setCoupons:function(e){e=e||{},e.default_coupon&&(this.default_coupon=e.default_coupon),e.current_coupon&&(this.current_coupon=e.current_coupon)}});return o}),define("wap/trade/components/coupon/main",["./model","./collection","text!./templates/useCoupon.html","text!./templates/availableCoupon.html","text!./templates/emptyCoupon.html","./view/selector_view","bower_components/pop/popup"],function(e,t,s,i,n,o,a){var r=function(){},d=Backbone.View.extend({events:{"click .js-change-coupon":"showCouponSelector"},useCouponTemplate:_.template(s),availableCouponTemplate:_.template(i),emptyCouponTemplate:_.template(n),initialize:function(t){t=t||{},this.coupons=t.couponList||{},this.currentCouponData=t.currentCouponData||{},this.currentCoupon=new e(this.currentCouponData),this.getExtraCouponValidData=t.getExtraCouponValidData;var s={id:"",value:0,type:""};this.none_coupon=new e(s),this.onCouponChanged=t.onCouponChanged||r},render:function(e){return e=e||{},this.couponCollection=new t,this.setCoupons(this.coupons),this},setCoupons:function(e){this.couponCollection.reset(e),this.default_coupon=this.couponCollection.at(0);var t=this.couponCollection.findCoupon(this.currentCouponData)||this.none_coupon;this.autoUseCoupon(),this.couponSelectorView&&this.couponSelectorView.setCoupons({default_coupon:this.default_coupon,current_coupon:t})},resetCoupons:function(){this.setCoupons()},showCouponSelector:function(){this.stopShowCouponSelector||this.queueWalking||(window.Logger.log({fm:"click",title:"coupon"}),this.popView||(this.popView=new a({contentViewClass:o,contentViewOptions:{none_coupon:this.none_coupon,current_coupon:this.usedCoupon||this.none_coupon,couponCollection:this.couponCollection,onCouponChanged:_(function(e){var t=e.toJSON(),s={};this.couponData=t,this.usedCoupon=e,this.updateCouponPanel(t),this.queueWalking||(s.couponData=this.couponData,s.isResetCoupon=!0,this.onCouponChanged(s))}).bind(this),getExtraCouponValidData:this.getExtraCouponValidData},containerCss:{bottom:0,left:0,right:0},transparent:".6",doNotRemoveOnHide:!0,className:"popup coupon-popup"}).render(),this.couponSelectorView=this.popView.contentView),this.popView.show())},autoUseCoupon:function(){var e=null;if(0===this.couponCollection.length&&!this.none_coupon&&!this.default_coupon)return!1;e=this.default_coupon?this.default_coupon:this.none_coupon;var t=e.toJSON(),s={};this.couponData=t,this.usedCoupon=e,this.updateCouponPanel(t),this.queueWalking||this.stopShowCouponSelector||(s.couponData=this.couponData,s.isResetCoupon=!0,this.onCouponChanged(s)),this.couponSelectorView&&this.couponSelectorView.switchCoupon(e)},updateCouponPanel:function(e){var t=this,s="";if(!e)return!1;if(e.id)s=t.useCouponTemplate({couponData:e,stopShowCouponSelector:this.stopShowCouponSelector});else{var i=this.couponCollection.length;s=i>0?t.availableCouponTemplate({available:i,stopShowCouponSelector:this.stopShowCouponSelector}):t.emptyCouponTemplate({stopShowCouponSelector:this.stopShowCouponSelector})}t.$el.html(s),t.show(),this.stopShowCouponSelector&&this.disablePanel()},hide:function(){this.$el.addClass("hide")},show:function(){this.$el.removeClass("hide")},hideCoupon:function(){this.cannotUseCoupon=!0,this.$el.addClass("hide")},showCoupon:function(){this.cannotUseCoupon=!1,this.$el.removeClass("hide")},disableSelector:function(){this.stopShowCouponSelector=!0,this.disablePanel()},disablePanel:function(){this.$(".js-right-part").removeClass("arrow"),this.couponData&&this.couponData.id||this.hide()},getCouponData:function(){return this.cannotUseCoupon&&!this.usedCoupon?"":this.usedCoupon.toJSON()}});return d}),define("wap/trade/new_order/containers/coupons/index",["require","wap/trade/components/coupon/main","../../models/coupons"],function(e){var t=e("wap/trade/components/coupon/main");e("../../models/coupons");return Backbone.View.extend({initialize:function(e){this.orderModel=e.orderModel,this.shopItem=e.shopItem||[],this.initData(),this.initComponentsView(),this.initListener()},initData:function(){this.model=this.orderModel.get("coupon")},initComponentsView:function(){var e=this;0==this.model.get("is_forbid_coupon")&&(this.couponView=new t({el:this.$el,couponList:this.model.get("coupons"),currentCouponData:this.model.get("current_coupon"),onCouponChanged:_(this.onCouponChanged).bind(this),getExtraCouponValidData:function(){var t=e.orderModel.get("goods_list"),s=t.get("items");return{kdt_id:e.orderModel.get("kdt_id"),book_key:e.orderModel.get("book_key"),item_list:s.toJSON(),pay_data:{item_pay:t.get("item_pay"),decrease:t.get("decrease"),postage:t.get("postage")},bill_data:e.orderModel.get("bill_data")}}}))},initListener:function(){this.listenTo(this.orderModel,"change:order_no",_(this.onOrderCreateSuccess).bind(this))},render:function(){this.couponView&&this.couponView.render(),this.orderModel.get("order_no")&&this.onOrderCreateSuccess()},queueWalk:function(){var e=new $.Deferred,t=this.model.get("coupons");this.couponView&&this.couponView.setCoupons(t);var s=this.orderModel.get("goods_list");return 0===s.getGoodsNum()&&this.couponView&&this.couponView.hide(),e.resolve(),e.promise()},onCouponChanged:function(e){Backbone.EventCenter.trigger("order_change",{type:"change_current_coupon",data:{current_coupon:e.couponData}}),Backbone.EventCenter.trigger("order_change",{type:"reset_order_data"}),Backbone.EventCenter.trigger("order_change",{type:"reset_ecard_data",data:{order_price:this.orderModel.getFinalPriceWithoutEcard()}}),Backbone.EventCenter.trigger("order_change",{type:"reset_order_data"}),Backbone.EventCenter.trigger("order_render","coupons")},onOrderCreateSuccess:function(){this.couponView&&this.couponView.disableSelector()}})}),define("text!wap/trade/components/point/templates/selector.html",[],function(){return'<div class="js-scene-coupon-list">\n    <div class="header">\n        抵用积分\n        <span class="js-close close"></span>\n    </div>\n\n    <div class="block block-item top-0">\n        积分余额：<span class="c-orange"><%= points %></span>\n    </div>\n</div>\n\n<div class="action-container">\n    <button class="js-close btn btn-block btn-green" style="margin: 0px;">确定</button>\n</div>'}),define("wap/trade/components/point/views/selector",["require","text!../templates/selector.html"],function(e){var t=function(){},s=e("text!../templates/selector.html");return Backbone.View.extend({initialize:function(e){this.isUsedPoint=e.isUsedPoint,this.pointPrice=e.pointPrice,this.points=e.points,this.hidePop=e.onHide||t,this.onChange=e.onChange||t},events:{"click .js-change-points":"onChangePointsClick","click .js-confirm":"onConfirm"},render:function(e){this.$el.html(_.template(s)({points:this.points})),this.nUse=this.$(".js-use"),this.nUnuse=this.$(".js-unuse"),this.switchItem()},onChangePointsClick:function(){this.isUsedPoint=!this.isUsedPoint,this.switchItem()},onConfirm:function(){this.onChange({isUsedPoint:this.isUsedPoint}),this.hidePop()},switchItem:function(){this.isUsedPoint?(this.nUse.addClass("active"),this.nUnuse.removeClass("active")):(this.nUse.removeClass("active"),this.nUnuse.addClass("active"))}})}),define("bower_components/pop/popout_box",["require","./popout"],function(e){var t=function(){},s=e("./popout"),i=s.extend({init:function(e){this._super(e),this._onOKClicked=e.onOKClicked||t,this._onCancelClicked=e.onCancelClicked||t,this.preventHideOnOkClicked=e.preventHideOnOkClicked||!1,this.width=e.width,this.setEventListener()},setEventListener:function(){this.nPopContainer.on("click",".js-ok",$.proxy(this.onOKClicked,this)),this.nPopContainer.on("click",".js-cancel",$.proxy(this.onCancelClicked,this))},_doShow:function(){this.boxCss={"border-radius":"4px",background:"white",width:this.width||"270px",padding:"15px"},this.nPopContainer.css(this.boxCss).addClass("popout-box"),this._super()},_doHide:function(e){this._super()},onOKClicked:function(e){this._onOKClicked(e),!this.preventHideOnOkClicked&&this.hide()},onCancelClicked:function(e){this._onCancelClicked(e),this.hide()}});return i}),define("text!wap/trade/components/point/templates/insufficient_pop.html",[],function(){return'<div>\n	<div class="container center block border-0" style="line-height: 1.5;">\n		<p class="font-size-18">积分不足</p>\n		<p class="c-orange font-size-16">当前余额: <%= user_points %></p>\n	</div>\n	<div class="action-container">\n		<div class="btn-2-1">\n			<button class="js-back btn btn-white btn-l">返回</button>\n		</div>\n		<div class="btn-2-1">\n			<button class="js-cancel btn btn-green btn-l">原价购买</button>\n		</div>\n	</div>\n</div>'}),define("wap/trade/components/point/views/insufficient_point",["require","text!../templates/insufficient_pop.html"],function(e){var t=e("text!../templates/insufficient_pop.html");return Backbone.View.extend({initialize:function(e){this.user_points=e.user_points||0},events:{"click .js-back":"onBackClick"},render:function(){var e=_.template(t);this.$el.html(e({user_points:this.user_points}))},onBackClick:function(){window.history.back()}})}),define("text!wap/trade/components/point/templates/used.html",[],function(){return'<div class="order-coupon clearfix">\n    <h4 class="block-item-title">抵用积分</h4>\n    <div class="coupon-info-container">\n	    <div class="js-normal-coupon coupon-info c-gray-dark">\n	        <span class="c-orange"><%= pointPrice %>积分</span>\n	    </div>\n	    <span class="arrow"></span>\n	</div>\n</div>'}),define("wap/trade/components/point/index",["require","./views/selector","bower_components/pop/popup","bower_components/pop/popout_box","./views/insufficient_point","text!./templates/used.html"],function(e){var t=e("./views/selector"),s=e("bower_components/pop/popup"),i=e("bower_components/pop/popout_box"),n=e("./views/insufficient_point"),o=e("text!./templates/used.html"),a=_.template(o);return Backbone.View.extend({initialize:function(e){var t=e.point||{};this.isShowPoint=t.is_points,this.user_points=t.user_points||0,this.pointPrice=t.total_points||0,this.isAvailable=t.available,this.isUsedPoint=!1,this.render()},events:{click:"onClick"},render:function(){return this.isShowPoint?this.isAvailable?(this.renderPointPanel(),this.$el.removeClass("hide"),this):void new i({contentViewClass:n,contentViewOptions:{user_points:this.user_points}}).render().show():void 0},onClick:function(e){e.preventDefault();this.popView||(this.popView=new s({contentViewClass:t,contentViewOptions:{pointPrice:this.pointPrice,points:this.user_points},containerCss:{bottom:0,left:0,right:0,background:"#f9f9f9"},doNotRemoveOnHide:!0}).render()),this.popView.show()},renderPointPanel:function(){this.$el.html(a({pointPrice:this.pointPrice,points:this.user_points}))}})}),define("wap/trade/new_order/containers/point/index",["require","wap/trade/components/point/index","../../models/point"],function(e){var t=e("wap/trade/components/point/index");e("../../models/point");return Backbone.View.extend({initialize:function(e){this.orderModel=e.orderModel,this.points=e.points,this.initData(),this.initComponentsView(),this.initListener()},initData:function(){this.model=this.orderModel.get("point")},initComponentsView:function(){this.pointView=new t({el:this.$el,point:this.model.get("points")})},render:function(){},queueWalk:function(){var e=new $.Deferred;return e.resolve(),e.promise()},initListener:function(){}})}),define("text!wap/trade/components/ecard/templates/selector.html",[],function(){return'<div class="js-scene-coupon-list ecard-popup">\n    <div class="header">\n        有赞E卡\n        <span class="js-close close"></span>\n    </div>\n\n    <div class="js-change-ecard js-use select-block" data-status="use">\n        <p class="c-gray-darker">\n            余额 \n            <span class="c-orange">￥</span><span class="c-orange font-size-24"><%= getAvailableMoney() %></span>\n        </p>\n        <p class="c-gray-darker">\n            可在所有店铺使用，支持找零和退款\n        </p>\n    </div>\n\n    <div class="js-change-ecard js-unuse select-block" data-status="unuse">\n        不使用有赞E卡支付\n    </div>\n</div>\n\n<div class="action-container coupon-action-container">\n    <button class="js-confirm btn btn-block btn-green" style="margin: 0px;">确定</button>\n</div>'}),define("wap/trade/components/ecard/views/selector",["require","text!../templates/selector.html"],function(e){var t=function(){},s=e("text!../templates/selector.html");return Backbone.View.extend({initialize:function(e){this.isUseEcard=e.isUseEcard||!1,this.availableMoney=e.availableMoney||0,this.orderPrice=e.orderPrice||0,this.hidePop=e.onHide||t,this.onChange=e.onChange||t},events:{"click .js-change-ecard":"onChangeEcardClicked","click .js-link":"onLinkClicked","click .js-confirm":"onConfirmClicked"},render:function(e){this.$el.html(_.template(s)({getAvailableMoney:_(function(){var e=parseInt(this.availableMoney,10)||0;return(e/100).toFixed(2)}).bind(this)})),this.switchItem()},onChangeEcardClicked:function(e){var t=$(e.target);t.hasClass("js-change-ecard")||(t=t.parents(".js-change-ecard")),t.hasClass("disable")||(t.addClass("active"),this.$(".js-change-ecard").not(t).removeClass("active"),this.isUseEcard="use"===t.data("status"))},onConfirmClicked:function(e){this.hidePop(),this.onChange({isUseEcard:this.isUseEcard})},onLinkClicked:function(e){e.stopPropagation()},setData:function(e){this.isUseEcard=e.isUseEcard,this.orderPrice=e.orderPrice,this.switchItem()},switchItem:function(){this.isUseEcard?(this.$(".js-change-ecard.js-use").addClass("active"),this.$(".js-change-ecard.js-unuse").removeClass("active")):(this.$(".js-change-ecard.js-unuse").addClass("active"),this.$(".js-change-ecard.js-use").removeClass("active")),this.orderPrice>this.availableMoney?this.$(".js-change-ecard.js-use").addClass("disable"):this.$(".js-change-ecard.js-use").removeClass("disable")}})}),define("text!wap/trade/components/ecard/templates/available.html",[],function(){return'<div class="info-panel info-panel-big clearfix">\n    <h4 class="left-part">有赞E卡</h4>\n    <div class="js-right-part right-part arrow">\n        <div class="js-normal-coupon detail c-gray-darker">\n            <span>未使用</span>\n        </div>\n    </div>\n</div>'}),define("text!wap/trade/components/ecard/templates/used.html",[],function(){return'<div class="info-panel info-panel-big clearfix">\n    <h4 class="left-part">有赞E卡</h4>\n    <div class="js-right-part right-part arrow">\n	    <div class="js-normal-coupon detail c-orange">\n	        抵用￥<%= (orderPrice/100).toFixed(2) %>\n	    </div>\n	</div>\n</div>'}),define("wap/trade/components/ecard/index",["require","./views/selector","bower_components/pop/popup","text!./templates/available.html","text!./templates/used.html"],function(e){var t=e("./views/selector"),s=e("bower_components/pop/popup"),i=e("text!./templates/available.html"),n=e("text!./templates/used.html"),o=function(){},a=Backbone.View.extend({initialize:function(e){this.ecardData=e.ecard||{},this.availableMoney=this.ecardData.available||0,this.isUseEcard=!1,this.setOrderPrice(e.price),this.onEcardChange=e.onEcardChange||o},events:{click:"onClick"},render:function(){return this.$el.removeClass("hide"),this.refreshEcard(),this.renderPanel(),this},onClick:function(e){var i=this;this.isDisabledChange||(this.popView?this.ecardSelectorView.setData({isUseEcard:this.isUseEcard,orderPrice:this.orderPrice}):(this.popView=new s({contentViewClass:t,contentViewOptions:{isUseEcard:this.isUseEcard,availableMoney:this.availableMoney,orderPrice:this.orderPrice,onChange:function(e){i.isUseEcard=e.isUseEcard,i.renderPanel(),i.onEcardChange({isUseEcard:i.isUseEcard,value:i.isUseEcard?i.orderPrice:0,finalPrice:i.isUseEcard?0:this.orderPrice})}},containerCss:{bottom:0,left:0,right:0,background:"#f9f9f9"},transparent:".6",doNotRemoveOnHide:!0}).render(),this.ecardSelectorView=this.popView.contentView),this.popView.show())},renderPanel:function(){var e;return 0==this.availableMoney?void this.$el.addClass("hide"):this.orderPrice<=0&&0==this.isUseEcard?void this.$el.addClass("hide"):(this.$el.removeClass("hide"),e=this.isUseEcard?_.template(n):_.template(i),void this.$el.html(e({data:this.ecardData,orderPrice:this.orderPrice})))},refreshEcard:function(){this.orderPrice>this.availableMoney?this.isUseEcard=!1:this.orderPrice<=0?(this.isUseEcard=!1,this.$el.addClass("hide")):(this.isUseEcard=!0,this.$el.removeClass("hide"))},queueWalk:function(e){var e=e||{},t=new $.Deferred;return this.setOrderPrice(e.finalPrice),this.refreshEcard(),this.renderPanel(),e.ecard={isUseEcard:this.isUseEcard,value:0},this.onEcardChange({isUseEcard:this.isUseEcard,value:this.isUseEcard?this.orderPrice:0,finalPrice:this.isUseEcard?0:this.orderPrice}),this.isUseEcard&&(e.ecard.value=this.orderPrice,e.finalPrice=0),t.resolve(e),t.promise()},setOrderPrice:function(e){this.orderPrice=e||0},resetEcardData:function(e){this.isUseEcard=e.isUseEcard,this.value=e.value,this.orderPrice=e.orderPrice},disableChange:function(){this.$(".js-right-part").removeClass("arrow"),this.isDisabledChange=!0}});return a}),define("wap/trade/new_order/containers/ecard/index",["require","wap/trade/components/ecard/index","../../models/ecard"],function(e){var t=e("wap/trade/components/ecard/index");e("../../models/ecard");return Backbone.View.extend({initialize:function(e){this.orderModel=e.orderModel,this.ecard=e.ecard||{},this.initData(),this.initComponentsView(),this.initListener()},initData:function(){this.model=this.orderModel.get("ecard")},initComponentsView:function(){this.ecardView=new t({el:this.$el,ecard:this.ecard,onEcardChange:_(this.onEcardChange).bind(this)})},initListener:function(){},render:function(){var e=this.orderModel.getFinalPriceWithoutEcard();Backbone.EventCenter.trigger("order_change",{type:"reset_ecard_data",data:{order_price:e}}),Backbone.EventCenter.trigger("order_change",{type:"reset_order_data"}),this.resetEcardDataAndRender()},onEcardChange:function(e){Backbone.EventCenter.trigger("order_change",{type:"change_current_ecard",data:{isUseEcard:e.isUseEcard,value:e.value}}),Backbone.EventCenter.trigger("order_change",{type:"reset_order_data"}),Backbone.EventCenter.trigger("order_render","ecard")},queueWalk:function(){var e=new $.Deferred;return this.resetEcardDataAndRender(),e.resolve(),e.promise()},resetEcardDataAndRender:function(){this.ecardView.resetEcardData({isUseEcard:this.model.get("isUseEcard"),value:this.model.get("value"),orderPrice:this.orderModel.getFinalPriceWithoutEcard()}),this.ecardView.renderPanel()}})}),define("text!wap/trade/components/send_message/templates/panel.html",[],function(){return'<div class="info-panel info-panel-big clearfix">\n    <h4 class="left-part">短信通知收件人</h4>\n    <div class="right-part">\n    	<button class="js-msg-switcher send-message-switcher ui-switcher \n    		<%= sms_switch ? \'ui-switcher-on\' : \'ui-switcher-off\' %>\n    	"></button>\n	</div>\n</div>'}),define("wap/trade/components/send_message/index",["require","text!./templates/panel.html"],function(e){var t=e("text!./templates/panel.html"),s=function(){};return Backbone.View.extend({initialize:function(e){"undefined"!=typeof e.sms_switch?this.sms_switch=e.sms_switch:this.sms_switch=1,this.onSmsSwitch=e.onSmsSwitch||s,this.render()},events:{"click .js-msg-switcher":"onSwitchClick"},render:function(){var e=_.template(t);return this.$el.html(e({sms_switch:this.sms_switch})).removeClass("hide"),this.nSwitcherBtn=this.$(".js-msg-switcher"),this},queueWalk:function(e){var t=new $.Deferred;return e=e||{},e.sms_switch=this.sms_switch,t.resolve(e),t.promise()},onSwitchClick:function(e){if(this.isDisableChange)return void motify.log("订单已生成, 无法修改");var t=this.nSwitcherBtn.hasClass("ui-switcher-on");t?(this.nSwitcherBtn.removeClass("ui-switcher-on").addClass("ui-switcher-off"),this.sms_switch=0):(this.nSwitcherBtn.removeClass("ui-switcher-off").addClass("ui-switcher-on"),this.sms_switch=1),this.onSmsSwitch({sms_switch:this.sms_switch})},getSmsSwitchStatus:function(){return this.sms_switch},disableChange:function(){this.isDisableChange=!0}})}),define("wap/trade/new_order/containers/send_message/index",["require","wap/trade/components/send_message/index","../../models/send_message"],function(e){var t=e("wap/trade/components/send_message/index");e("../../models/send_message");return Backbone.View.extend({initialize:function(e){this.orderModel=e.orderModel,this.initData(),this.initComponentsView(),this.initListener()},initData:function(){this.model=this.orderModel.get("send_message")},initComponentsView:function(){this.sendMessageView=new t({el:this.$el,sms_switch:this.model.get("sms_switch"),onSmsSwitch:_(this.onSmsSwitch).bind(this)})},initListener:function(){this.listenTo(this.orderModel,"change:order_no",_(this.onOrderCreateSuccess).bind(this))},render:function(){var e=this.orderModel.get("order_no");e&&this.onOrderCreateSuccess()},queueWalk:function(){var e=new $.Deferred,t=this.orderModel.get("goods_list");return 0===t.getGoodsNum()?this.$el.addClass("hide"):this.$el.removeClass("hide"),e.resolve(),e.promise()},onSmsSwitch:function(e){Backbone.EventCenter.trigger("order_change",{type:"change_sms_switch",data:{sms_switch:e.sms_switch}})},onOrderCreateSuccess:function(){this.sendMessageView.disableChange()}})}),define("text!wap/trade/new_order/components/price_area/templates/price_area.html",[],function(){return'\n<p>\n    <span>商品金额</span>\n    <span class="pull-right c-gray-darker">\n        <% if (data.pointPrice) { %>\n            <%= (data.pointPrice) %>积分\n        <% } else { %>\n            ￥<%= (data.goodsPrice/100).toFixed(2) %> \n        <% } %>\n    </span>\n</p>\n<p>\n    <span>运费</span>\n    <span class="pull-right c-gray-darker">\n        + ￥<%= (data.postage/100).toFixed(2) %>\n    </span>\n</p>\n<% if (data.decrease != 0) { %>\n    <p>\n        <span>活动优惠</span>\n        <span class="pull-right c-gray-darker">\n            - ￥<%= (data.decrease/100).toFixed(2) %>\n        </span>\n    </p>\n<% } %>\n<% if (data.operationPrice) { %>\n    <p>\n        <span>商家改价</span>\n        <span class="pull-right c-gray-darker">\n            <%= data.operationPrice > 0 ? \'+\' : \'-\' %>\n            ￥<%= (Math.abs(data.operationPrice)/100).toFixed(2) %>\n        </span>\n    </p>\n<% } %>\n<% if (data.couponDecrease != 0) { %>\n    <p>\n        <span>优惠</span>\n        <span class="pull-right c-gray-darker">\n            - ￥<%= (data.couponDecrease/100).toFixed(2) %>\n        </span>\n    </p>\n<% } %>\n<% if (data.ecard && data.ecard.isUseEcard) { %>\n    <p>\n        <span>有赞E卡支付</span>\n        <span class="pull-right c-gray-darker">\n            - ￥<%= (data.ecard.ecardValue/100).toFixed(2) %>\n        </span>\n    </p>\n<% } %>';
}),define("wap/trade/new_order/components/price_area/index",["require","text!./templates/price_area.html"],function(e){var t=e("text!./templates/price_area.html");return Backbone.View.extend({initialize:function(e){this.showData=e.showData||{}},template:_.template(t),render:function(){this.$el.html(this.template({data:this.showData}))},resetShowData:function(e){this.showData=e,this.render()}})}),define("wap/trade/new_order/containers/price_area/index",["require","../../components/price_area/index"],function(e){var t=e("../../components/price_area/index");return Backbone.View.extend({initialize:function(e){this.orderModel=e.orderModel,this.initData(),this.initComponentsView(),this.initListener()},initData:function(){},initComponentsView:function(){var e=this.orderModel.getShowData();this.priceAreaView=new t({el:this.$el,showData:e})},initListener:function(){},render:function(){this.priceAreaView.render()},queueWalk:function(){var e=new $.Deferred,t=this.orderModel.getShowData();this.priceAreaView.resetShowData(t);var s=this.orderModel.get("goods_list");return 0===s.getGoodsNum()?this.$el.addClass("hide"):this.$el.removeClass("hide"),e.resolve(),e.promise()}})}),define("wap/components/loading",["bower_components/pop/pop"],function(e){var t,s=e.extend({init:function(e){e=e||{},this._super(e),this.css=$.extend({position:"fixed",opacity:1,top:"50%",left:"50%","-webkit-transform":"translate3d(-50%, -50%, 0)",transform:"translateY(-50%, -50%, 0)"}),this.nPopContainer.css(this.css)}});return{show:function(){t&&this.hide(),t=new s({html:'<div class="loader-container"><div class="loader center">处理中</div></div>',isCanNotHide:!0,transparent:".6"}).render().show()},hide:function(){t&&t.hide(),t=null}}}),define("text!wap/components/pay/templates/pay_item.html",[],function(){return'<button type="button" data-pay-type="<%= data.code %>" class="btn-pay btn btn-block btn-large btn-<%= data.code %> <%= getBtnClass(data.code) %>">\n	<%= data.name %>\n</button>\n'}),define("wap/components/pay/views/pay_item",["require","jquery","underscore","backbone","text!../templates/pay_item.html"],function(e){var t=(e("jquery"),e("underscore")),s=e("backbone"),i=e("text!../templates/pay_item.html"),n=function(){},o=s.View.extend({template:t.template(i),initialize:function(e){this.model.on("change",t(this.render).bind(this)),this.payAction=e.payAction||n,this.onPayBtnClicked=e.onPayBtnClicked||n,this.onOtherPayClicked=e.onOtherPayClicked||n},events:{"click button":"onButtonClick"},onButtonClick:function(){var e=this.$("button"),s=e.data("pay-type");if(this.onPayBtnClicked(s,e),"other"===s)return void this.onOtherPayClicked();var i=this.model.get("name");this.payAction.doPayAction({payType:s,payName:i,doBeforeSync:t(function(){this.$("button").addClass("btn-pay-loading")}).bind(this),doAfterSync:t(function(){this.$("button").removeClass("btn-pay-loading"),this.render()}).bind(this)})},render:function(){var e=this,s=this.model.toJSON();return this.$el.html(this.template(t.extend({data:s},{getBtnClass:function(t){return window.parseInt(e.model.get("order"))>0?" btn-white":" btn-green"}}))),this.$el.css("margin-bottom","10px"),this}});return o}),window.Zepto&&function(e){e.fn.serializeArray=function(){var t,s,i=[],n=function(e){return e.forEach?e.forEach(n):void i.push({name:t,value:e})};return this[0]&&e.each(this[0].elements,function(i,o){s=o.type,t=o.name,t&&"fieldset"!=o.nodeName.toLowerCase()&&!o.disabled&&"submit"!=s&&"reset"!=s&&"button"!=s&&"file"!=s&&("radio"!=s&&"checkbox"!=s||o.checked)&&n(e(o).val())}),i},e.fn.serialize=function(){var e=[];return this.serializeArray().forEach(function(t){e.push(encodeURIComponent(t.name)+"="+encodeURIComponent(t.value))}),e.join("&")},e.fn.submit=function(t){if(0 in arguments)this.bind("submit",t);else if(this.length){var s=e.Event("submit");this.eq(0).trigger(s),s.isDefaultPrevented()||this.get(0).submit()}return this}}(Zepto),define("vendor/zepto/form",function(){}),define("text!wap/components/pay/templates/password.html",[],function(){return'<div class="header">\n	安全验证\n</div>\n<span class="js-cancel close"></span>\n<div class="popout-content content">\n	<p class="font-size-12">为保证支付账户安全，请输入手机账户<%= account %>的登录密码</p>\n	<p>\n		<input type="password" class="js-password password" placeholder="请输入账户密码"/>\n	</p>\n</div>\n<div class="action-container">\n	<button class="js-ok btn btn-green btn-block">付款</button>\n</div>\n<!--\n<p class="tips clearfix">\n	<a class="font-size-12 c-blue pull-right" href="<%- changePwdUrl %>">忘记登录密码</a>\n</p>\n-->'}),define("wap/components/pay/views/password",["require","text!wap/components/pay/templates/password.html"],function(e){var t=function(){},s=e("text!wap/components/pay/templates/password.html"),i=_.template(s);return Backbone.View.extend({initialize:function(e){this.account=e.account||"",this.onConfirm=e.onConfirm||t},events:{"click .js-ok":"onOKClicked"},render:function(){function e(e){return e=e.toString(),e.slice(0,3)+"****"+e.slice(-3)}return this.$el.html(i({account:e(this.account),changePwdUrl:window._global.url.wap+"/buyer/auth/changePassword?redirect_uri="+encodeURIComponent(window.location.href)})),this.nPassword=this.$(".js-password"),this},onOKClicked:function(e){var t=this.nPassword.val();return t?void this.onConfirm({password:t}):void motify.log("请输入密码")}})}),define("text!wap/components/pay/templates/wapwxpay.html",[],function(){return'<div class="header center">微信支付确认</div>\n<div class="content font-size-12">如您已使用微信支付完成付款，请点击“我已支付成功”查看订单；如付款遇到问题，请尝试使用其他方式付款。</div>\n<div class="action-container">\n    <div class="btn-2-1"><button class="btn btn-l btn-green js-ok">我已支付成功</button></div>\n    <div class="btn-2-1"><button class="btn btn-l btn-white js-cancel">使用其他支付方式</button></div>\n</div>\n'}),define("wap/components/pay/views/need_confirm",[],function(){return{needConfirm:function(e,t,s){var i=window.confirm(e);i?t&&"function"==typeof t&&t.apply():s&&"function"==typeof s&&s.apply()}}}),define("wap/components/pay/views/pay_action",["require","jquery","underscore","backbone","vendor/zepto/form","zenjs/util/ua","bower_components/pop/popout_box","wap/components/pay/views/password","text!../templates/wapwxpay.html","./need_confirm"],function(e){var t=e("jquery"),s=e("underscore"),i=e("backbone");e("vendor/zepto/form");var n=e("zenjs/util/ua"),o=e("bower_components/pop/popout_box"),a=e("wap/components/pay/views/password"),r=e("text!../templates/wapwxpay.html"),d=e("./need_confirm"),c=function(){};return i.View.extend({initialize:function(e){this.payUrl=e.payUrl,this.kdt_id=e.kdt_id,this.order_no=e.order_no,this.account=e.account||"",this.wxPayResultUrl=e.wxPayResultUrl,this.getPayDataExtr=e.getPayDataExtr,this.onPayOrderCreated=e.onPayOrderCreated,this.beforeWxPayRender=e.beforeWxPayRender||c,this.onPayError=e.onPayError||c,this.onWxPayError=e.onWxPayError||c,this.wxWapPaySuccess=e.wxWapPaySuccess},initFuncs:function(e){this.doBeforeSync=e.doBeforeSync||c,this.doAfterSync=e.doAfterSync||c},doPayAction:function(e){if(this.isPayProcessing)return void motify.log("支付处理中，请稍候再试");this.isPayProcessing=!0,this.initFuncs(e);var t=e.payType||"",i=e.payName||"",n="";return"codpay"===t?(n="下单提醒：您正在选择货到付款，下单后由商家发货，送货上门并收款。","到店付款"===i&&(n="下单提醒：您正在选择到店付款，下单后请自行到店领取并付款。"),d.needConfirm(n,s(function(){this.doPay(t)}).bind(this)),void(this.isPayProcessing=!1)):"ecard"===t?void this.getPasswordBeforePay(t):void this.doPay(t)},getPasswordBeforePay:function(e){new o({contentViewClass:a,contentViewOptions:{account:this.account,onConfirm:s(function(t){this.doPay(e,t.password)}).bind(this)},isCanNotHide:!0,className:"pay-popout",transparent:".6",preventHideOnOkClicked:!0}).render().show(),this.isPayProcessing=!1},doPay:function(e,t){var i=this.getPayDataExtr(e);if(!i)return void(this.isPayProcessing=!1);var n={order_no:this.order_no,kdt_id:this.kdt_id,buy_way:e};t&&(n.password=t),this.submitPay(s.extend(i,n),e)},submitPay:function(e,i){var n=this;t._ajax({url:this.payUrl,type:"POST",dataType:"json",timeout:15e3,data:e,cache:!1,beforeSend:function(){n.doBeforeSync()},success:function(t){var a=t.code;switch(n.isPayProcessing=!1,a){case 0:n.onPayOrderCreated(e);var c=t.data.pay_data,l=t.data.redirect_url,h=t.data.pay_return_url,p=t.data.pay_return_data;switch(i){case"wxapppay":n.doFinishWxAppPay(i,c,p);break;case"wxpay":n.doFinishWxPay(i,c,l,h,p);break;case"couponpay":case"presentpay":window.location=c.submit_url;break;case"ecard":n.doFinishECardPay(i,c,l);break;case"wxwappay":return n.wapPayPopout=new o({html:r,width:"290px",className:"pay-popout",onOKClicked:function(){n.wxWapPaySuccess(t,n),location.reload()},onCancelClicked:function(){location.reload()}}).render().show(),void(window.location=c.deeplink);default:if(!c||!c.submit_url)return void motify.log("支付过程出错，请联系客服！");n.doFinishOtherPay(i,c)}break;case 11022:case 11023:window.wxReady&&window.wxReady(function(){window.WeixinJSBridge&&window.WeixinJSBridge.invoke("closeWindow",{})});break;case 11010:d.needConfirm(t.msg,function(){e.accept_price=1,n.submitPay(e,i)},function(){motify.log("支付已取消",0),window.location.reload()});break;case 11012:case 11024:case 11026:case 11027:motify.log("正在跳转...");var u="wxpay"!=i?window._global.url.trade+"/trade/order/result?order_no="+n.order_no+"&kdt_id="+n.kdt_id+"#wechat_webview_type=1":n.wxPayResultUrl;window.location.href=u;break;case 21e3:window.location.reload();break;case 90001:var m=t.data.item_url,f=s.template(['<div class="content">矮油，动作太慢了，已被抢光了</div>','<div class="action-container">','<div class="btn-2-1"><button class="btn btn-l btn-white js-ok">放弃</button></div>','<div class="btn-2-1"><a href="<%= data.buyUrl %>" class="btn btn-l btn-orange-dark">我要买</a></div>',"</div>"].join(""));n.errorPopout||(n.errorPopout=new o({doNotRemoveOnHide:!0,className:"pay-popout",html:f({data:{buyUrl:m}})}).render()),n.errorPopout.show();break;default:motify.log(t.msg)}0!==a&&n.onPayError(a,t.msg||"",t)},error:function(e,t,s){n.isPayProcessing=!1,motify.log("生成支付单失败。")},complete:function(e,t){n.isPayProcessing=!1,n.doAfterSync()}})},doFinishOtherPay:function(e,i){if(!this.isSubmitting){this.isSubmitting=!0;var n='<form method="post" action="'+i.submit_url+'">';delete i.submit_url,s(i).map(function(e,t){n+='<input type="hidden" name="'+t+'" value="'+e+'" />'}),n+="</form>";var o=t(n);o.submit(),this.isSubmitting=!1}},doFinishWxPay:function(e,i,o,a,r){return this.wxpayed?void motify.log("支付数据处理中，请勿重复操作"):(this.wxpayed=!0,"string"==typeof i&&(i=t.parseJSON(i)),window.WeixinJSBridge?(this.beforeWxPayRender(),void window.WeixinJSBridge.invoke("getBrandWCPayRequest",i,s(function(e){var s=e.err_msg;this.wxpayed=!1,"get_brand_wcpay_request:ok"===s?(motify.log("支付成功，正在处理订单...",0),t._ajax({url:a,type:"POST",dataType:"json",timeout:15e3,data:r,cache:!1,success:function(e){window.location.href=o}})):"get_brand_wcpay_request:cancel"===s?n.isIOS()||this.onWxPayError({payReturnData:r,model:this.model}):(this.onWxPayError({payReturnData:r,model:this.model}),t._ajax({url:"/v2/pay/api/recordwxjsfailmsg.json",type:"POST",dataType:"json",data:t.extend({wxpay_fail_order_url:o},e)}))}).bind(this))):void(this.wxpayed=!1))},doFinishWxAppPay:function(){function e(e,t){t||(t="weixin"),n.isIOS()?(e=encodeURIComponent(e),document.location.hash="#func=appWXPay&params="+e):n.isAndroid()&&window.android&&window.android.appWXPay(e)}return function(t,s,i){n.isWxd()&&n.getPlatformVersion()>="1.5.0"?window.YouzanJSBridge&&window.YouzanJSBridge.doCall("doAction",{action:"appWXPay",kdt_id:s.kdt_id,order_no:i.order_no,inner_order_no:s.order_no}):(window.Logger&&window.Logger.log({fm:"click",title:"app_wx_pay"}),e("kdt_id="+s.kdt_id+"&order_no="+s.order_no),window.YouzanJSBridge&&window.YouzanJSBridge.doCall("appWXPay",{kdt_id:s.kdt_id,order_no:s.order_no}))}}(),doFinishECardPay:function(e,s,i){s=s||{};var n=s.pay_return_url,o=s.pay_return_data;t._ajax({url:n,type:"POST",dataType:"json",timeout:15e3,data:o,cache:!1,complete:function(){window.location.href=i}})}})}),define("wap/components/pay/pay",["require","backbone","underscore","bower_components/zenlist/list","bower_components/pop/popup","wap/components/loading","./views/pay_item","./views/pay_action"],function(e){var t=function(){},s=e("backbone"),i=e("underscore"),n=e("bower_components/zenlist/list"),o=e("bower_components/pop/popup"),a=e("wap/components/loading"),r=e("./views/pay_item"),d=e("./views/pay_action");return s.View.extend({initialize:function(e){this.collection=new s.Collection,this.nPayTips=e.nPayTips,this.itemOptions=e.itemOptions||{},this.pagePayWaySize=e.pagePayWaySize||2,this.payUrl=e.payUrl||window._global.url.trade+"/trade/order/pay.json",this.order_no=e.order_no||window._global.order_no,this.kdt_id=e.kdt_id||window._global.kdt_id,this.account=e.account||"",this.getPayDataExtr=e.getPayDataExtr||function(){return{}},this.wxPayResultUrl=e.wxPayResultUrl,this.onPayOrderCreated=e.onPayOrderCreated||t,this.otherPayText=e.otherPayText,this.beforeWxPayRender=e.beforeWxPayRender||t,this.wxWapPaySuccess=e.wxWapPaySuccess||t,this.onPayError=e.onPayError||t,this.onWxPayError=e.onWxPayError||t,this.autoPayWhileSingleBtn=e.autoPayWhileSingleBtn||!1,this.showAllPayWaysWithoutPop=e.showAllPayWaysWithoutPop||!1,this.payAction=new d({payUrl:this.payUrl,kdt_id:this.kdt_id,order_no:this.order_no,account:this.account||"",wxPayResultUrl:this.wxPayResultUrl,getPayDataExtr:this.getPayDataExtr,onPayOrderCreated:this.onPayOrderCreated,beforeWxPayRender:this.beforeWxPayRender||t,onPayError:this.onPayError||t,onWxPayError:this.onWxPayError||t,wxWapPaySuccess:this.wxWapPaySuccess});var n=e.payWays,o=new s.Collection;i.each(n,function(e,t){e.id=t,e.order=t,o.add(new s.Model(e))}),this.listOpt={el:this.$el,itemView:r,collection:this.collection,itemOptions:i.extend({},this.itemOptions,{onOtherPayClicked:i(this.onOtherPayClicked).bind(this),payAction:this.payAction}),emptyHTML:e.emptyHTML||" "},this.allPayWayCollection=o,this.initPagePayWay()},render:function(){return this.autoPayWhileSingleBtn&&1==this.allPayWayCollection.length?void this.doAutoPay():(this.payWayListView=new n(this.listOpt).render(),this)},doAutoPay:function(){var e=this.allPayWayCollection.at(0);this.payAction.doPayAction({payType:e.get("code"),payName:e.get("name"),doBeforeSync:i(function(){a.show()}).bind(this),doAfterSync:i(function(){a.hide()}).bind(this)})},initPagePayWay:function(){if(0===this.allPayWayCollection.length)return this.nPayTips&&this.nPayTips.html("无可用的支付方式"),this;if(this.allPayWayCollection.length<=this.pagePayWaySize)for(var e=0;e<this.allPayWayCollection.length;e++)this.collection.add(this.allPayWayCollection.get(e));else{for(var e=0;e<this.pagePayWaySize;e++)this.collection.add(this.allPayWayCollection.get(e));var t=this.allPayWayCollection.findWhere({code:"aliwap"});t&&this.collection.add(t),this.collection.add(new s.Model({code:"other",name:this.otherPayText||"其他支付方式",order:e}))}},addHotIcon:function(e){var t=this.allPayWayCollection.findWhere({code:e});if(t){var s=t.get("name")+'<span class="hot"></span>';t.set("name",s);var i=this.collection.findWhere({code:e});if(i)return void i.set("name",s);var n=this.collection.findWhere({code:"other"});n&&n.set("name",n.get("name")+'<span class="hot"></span>')}},initPopPayWayListView:function(){var e=i.clone(this.listOpt);delete e.el,e.collection=new s.Collection(this.allPayWayCollection.filter(function(e){return e.get("hide")!==!0})),this.popPayWayListView=new o({contentViewClass:n,className:"confirm-pay-way-opts-popup",contentViewOptions:e,containerCss:{padding:"10px"},doNotRemoveOnHide:!0}).render().show()},onOtherPayClicked:function(){this.showAllPayWaysWithoutPop?(this.collection.reset(this.allPayWayCollection.filter(function(e){return e.get("hide")!==!0})),$._ajax({url:"/v2/trade/common/log.json",type:"POST",dataType:"json",data:$.extend({error_type:"other_pay_clicked"})})):this.initPopPayWayListView()},updatePayWay:function(e,t){var s=this.allPayWayCollection.find(function(e){return e.get("code")==t.code});if(s)for(var i in t)t.hasOwnProperty(i)&&s.set(i,t[i])},updatePayWaySelffetch:function(e){this.isSelffetch=e},updateValue:function(e){if(e){var t=this,s=["payUrl","order_no","kdt_id"];i.each(e,function(e,n,o){t[n]=e,s.indexOf(n)>-1&&(t.listOpt.itemOptions[n]=e,t.payWayListView&&i.each(t.payWayListView.items,function(t){t[n]=e}),t.popPayWayListView&&i.each(t.popPayWayListView.items,function(t){t[n]=e}))})}}})}),define("wap/trade/new_order/components/pay/index",["require","bower_components/pop/popup","wap/components/pay/pay"],function(e){var t=e("bower_components/pop/popup"),s=e("wap/components/pay/pay");return Backbone.View.extend({initialize:function(e){this.payData=e.data||{},this.express_type=e.express_type||""},render:function(){var e=this.payData.payWays||[];return 1==e.length?void this.initSinglePayWays():void this.initPayView()},initPayView:function(){this.payPopView=new t({contentViewClass:s,contentViewOptions:$.extend({},this.payData),className:"pay-btn-popup",transparent:".6",containerCss:{bottom:0,left:0,right:0,background:"#f9f9f9"}}),this.payPopView.render().show();var e=this.payPopView.contentView;e.updatePayWay("codpay",{code:"codpay",name:"self-fetch"==this.express_type?"到店付款":"货到付款"})},initSinglePayWays:function(){new s($.extend({},this.payData,{autoPayWhileSingleBtn:!0})).render()}})}),define("wap/trade/new_order/containers/pay/index",["require","../../components/pay/index","bower_components/pop/popout_box"],function(e){var t=e("../../components/pay/index"),s=e("bower_components/pop/popout_box");return Backbone.View.extend({initialize:function(e){this.initData(),this.initComponentsView(),this.initListener()},initData:function(){},initComponentsView:function(){},initListener:function(){},doShowPayWays:function(e,s){this.order_no=e.order_no,this.kdt_id=e.kdt_id,e.onWxPayError=_(this.showWxScanPay).bind(this),e=this.resolvePayWays(e,s),new t({data:e,express_type:s.express_type}).render()},resolvePayWays:function(e,t){var s=t.payWays||[],i=t.innerPayWays||[],n=[],o=e.pagePayWaySize||0,a=t.is_use_ecard,r=t.final_price,d=t.orderType;if(r){n=s,o=n.length;var c=_.some(n,function(e){return"codpay"==e.code});c&&(o-=1)}else n=a?[i.ecard]:4==d?[i.present]:[i.coupon],o=n.length;return e.payWays=n,e.pagePayWaySize=o,e},showWxScanPay:function(e){e=e||{};var t=e.model;t&&t.trigger("destroy",t,t.collection),$._ajax({url:"/v2/trade/native/qrCode.json",type:"GET",dataType:"json",data:{order_no:this.order_no,kdt_id:this.kdt_id},success:function(e){e&&0===+e.code||alert("数据错误，请刷新"),new s({html:(e.data||{}).tpl,className:"wx-scan-popout",isCanNotHide:!0}).render().show(),$("body").one("click touchstart",".js-qrcode",function(){$(".js-scan-pay-finish").removeClass("hide")})}})}})}),define("bower_components/pop/popout_box_ios",["require","./popout_box"],function(e){var t=e("./popout_box"),s=t.extend({_doShow:function(){this.boxCss={"border-radius":"4px",background:"white",width:this.width||"290px",padding:"15px 0 0"},this.nPopContainer.css(this.boxCss).addClass("popout-box-ios"),$(".js-popout-close").click($.proxy(function(e){this.hide()},this)),this.nPopContainer.css("opacity",1),this.nPopContainer.show()}});return s}),define("text!wap/trade/new_order/components/pay_total/templates/wait_popout.html",[],function(){return'<div class="order-wait-box">\n	<h3 class="font-size-14 center">\n		系统繁忙\n	</h3>\n	<p class="font-size-14 order-wait-tip">非常抱歉，当前下单用户较多，请耐心等待后再继续下单！</p>\n	<a href="javascript:void(0);" class="btn btn-block btn-green font-size-14 js-ok"></a>\n</div>'}),define("text!wap/trade/new_order/components/pay_total/templates/price.html",[],function(){return'<% if (payTips) { %>\n    <p class="tips text-left"><%= payTips %></p>\n<% } %>\n<div class="pay-container clearfix">\n    <div class="pull-right">\n        <span class="c-gray-darker font-size-16">合计：</span>\n        <span class="js-price c-orange font-size-16">￥<%= Math.floor(total/100) %>.</span>\n        <span class="js-price-sub c-orange font-size-12"><%= numberFormat(total%100) %></span>\n        <% if (!order_no) { %>\n            <button class="js-confirm btn btn-orange">提交订单</button>\n        <% } else { %>\n            <button class="js-confirm btn btn-orange">去支付</button>\n        <% } %>\n    </div>\n</div>'}),define("text!wap/trade/new_order/components/pay_total/templates/error_tips.html",[],function(){return'<div class="content cancel-order">\n	<%= msg %>\n</div>\n<div class="action-container">\n    <a class="btn c-green js-ok btn-block" href="<%= URLHelper.site(\'/showcase/homepage?kdt_id=\' + window._global.kdt_id, \'wap\') %>">再去逛逛</a>\n</div>\n'}),define("wap/trade/new_order/components/pay_total/index",["require","bower_components/pop/popout_box","bower_components/pop/popout_box_ios","zenjs/util/url_helper","text!./templates/wait_popout.html","text!./templates/price.html","text!./templates/error_tips.html"],function(e){var t=e("bower_components/pop/popout_box"),s=e("bower_components/pop/popout_box_ios"),i=e("zenjs/util/url_helper"),n=e("text!./templates/wait_popout.html"),o=e("text!./templates/price.html"),a=e("text!./templates/error_tips.html"),r=_.template(o);return Backbone.View.extend({initialize:function(e){this.doCreateOrder=e.doCreateOrder,this.doShowPayWays=e.doShowPayWays,this.resetData(e)},events:{"click .js-confirm":"onConfirmClick"},render:function(){this.$el.html(r({order_no:this.order_no,total:+this.total,payTips:this.payTips,numberFormat:function(e){return 10>e?"0"+e:""+e}}))},onConfirmClick:function(){this.doCreateOrder().done(_(function(e){this.doShowPayWays(e)}).bind(this)).fail(_(this.onCreateOrderFailed).bind(this))},resetData:function(e){this.payTips=e.payTips,this.order_no=e.order_no,this.total=e.total},onCreateOrderFailed:function(e){var s=+e.code,i=e.data||{};0>s||(12500===s?(this.waitPopoutBox=new t({isCanNotHide:!0,html:_.template(n),transparent:".8",className:"no-padding",width:"280px",preventHideOnOkClicked:!0,onOKClicked:_(function(e){var t=$(e.target);t.attr("disabled")||(this.waitPopoutBox.hide(),this.onConfirmClick())}).bind(this)}).render().show(),this.doConfirmBtn=$(".order-wait-box .js-ok"),this.doWait(i.wait)):31001===s?(motify.log("订单状态确认中..."),setTimeout(function(){window.location.reload()},800)):motify.log(e.msg))},doWait:function(e){e>0?(this.doConfirmBtn.attr("disabled",!0),this.doConfirmBtn.text("请等待 "+e+" 秒"),this.waitId=setTimeout(_(this.doWait).bind(this,e-1),1e3)):(this.doConfirmBtn.removeAttr("disabled"),this.doConfirmBtn.text("立即下单"),this.waitId=!1)},show:function(){this.$el.removeClass("hide")},showErrorTips:function(e){new s({html:_.template(a)({msg:e,URLHelper:i})}).render().show()}})}),define("wap/trade/new_order/containers/pay_total/index",["require","../../components/pay_total/index","../pay/index","bower_components/youzanjsbridge/api","zenjs/util/args","wap/components/loading"],function(e){var t=e("../../components/pay_total/index"),s=e("../pay/index"),i=e("bower_components/youzanjsbridge/api"),n=e("zenjs/util/args"),o=e("wap/components/loading");return Backbone.View.extend({initialize:function(e){this.orderModel=e.orderModel,this.onValidOrderDataError=e.onValidOrderDataError||[],this.initData(),this.initComponentsView(),this.initListener()},initData:function(){this.model=this.orderModel.get("pay_total")},initComponentsView:function(){var e=this.orderModel,s=e.get("msg_data");this.payTotalView=new t({el:this.$el,order_no:e.get("order_no"),total:e.getFinalPrice(),payTips:s.show_msg||"",doCreateOrder:_(this.doCreateOrder).bind(this),doShowPayWays:_(this.doShowPayWays).bind(this)})},initListener:function(){},render:function(){this.payTotalView.render(),this.payTotalView.show(),this.payView=new s},queueWalk:function(){var e=new $.Deferred;return this.resetDataAndRender(),e.resolve(),e.promise()},resetDataAndRender:function(){var e=this.orderModel,t=e.get("msg_data");this.payTotalView.resetData({total:e.getFinalPrice(),order_no:e.get("order_no"),payTips:t.show_msg||""}),this.payTotalView.render()},doCreateOrder:function(){var e=new $.Deferred,t=this;Backbone.EventCenter.trigger("order:prepare_order_data");var s=this.orderModel.getOrderData();if(this.orderModel.get("order_no"))e.resolve(s);else{try{this.orderModel.isValidOrderData()}catch(i){return this.onValidOrderDataError(i),e.reject({code:-1}),e.promise()}o.show(),$._ajax({url:"/v2/trade/bill/bill.json",type:"POST",dataType:"json",timeout:15e3,data:s,success:function(i){var n=i.data||{},a=+i.code;o.hide(),0==a?(t.onCreateOrderSuccess(n),t.resetDataAndRender(),e.resolve(s)):e.reject({code:a,msg:i.msg||""})},fail:function(){o.hide(),e.reject({code:-1,msg:"订单生成失败"})}})}return e.promise()},doShowPayWays:function(e){var t=window._global.url.trade,s=this.orderModel.get("order_no"),i=this.orderModel.get("kdt_id"),n={payUrl:t+"/trade/bill/pay.json",wxPayResultUrl:t+"/trade/order/result?order_no="+s+"&kdt_id="+i+"&order_paid=1#wechat_webview_type=1&refresh",order_no:s,kdt_id:i,pagePayWaySize:10,getPayDataExtr:_(this.orderModel.getPayData).bind(this.orderModel),showAllPayWaysWithoutPop:!0,account:this.orderModel.get("account"),itemOptions:{onPayBtnClicked:function(e){window.Logger.log({fm:"click",title:"pay_item",pay_type:e})}}},o={payWays:this.model.get("payWays"),innerPayWays:this.model.get("innerPayWays"),orderType:this.orderModel.get("order_type")},a=this.orderModel.get("ecard");o.is_use_ecard=+a.get("isUseEcard");var r=e.address.express_type||"";o.express_type=r;var d=this.orderModel.getFinalPrice();o.final_price=d,this.payView.doShowPayWays(n,o)},onCreateOrderSuccess:function(e){Backbone.EventCenter.trigger("order_change",{type:"change_order_no",data:{order_no:e.order_no}}),Logger.log({fm:"auto",act_name:n.get("page_type")||"unknown",act_ver:n.get("page_version")||"unknown",order_no:e.order_no}),i.doAction({action:"cart_delete"})},hideContainer:function(){this.$el.addClass("hide")},showContainer:function(){this.$el.removeClass("hide")},showErrorTips:function(e){var t=e.msg||"";this.payTotalView.showErrorTips(t)}})}),define("text!wap/trade/new_order/components/invalid_goods_list/templates/panel.html",[],function(){return'<p class="center font-size-12 c-gray-dark">\n    以下商品无法一起购买\n</p>\n<div class="goods-photo-block block">\n    <div>\n        <% _.each(items, function(item) { %>\n            <div class="photo">\n                <img src="<%= URLHelper.getCdnImageUrl(item.img_url, \'!100x100.jpg\') %>">\n            </div>\n        <% }) %>\n    </div>\n    <div class="js-detail goods-tips c-gray-darker font-size-14">\n        共<%= items.length %>件\n    </div>\n</div>'}),define("text!wap/trade/new_order/components/invalid_goods_list/templates/pop_detail.html",[],function(){return'<div class="header">\n    以下商品无法一起下单\n    <span class="js-close close"></span>\n</div>\n\n<div class="invalid-goods-list block-order">\n    <% _.each(items, function(item) { %>\n    <div class="invalid-goods-card name-card block border-0" style="margin-left: 0; margin-top: 10px;">\n        <div class="thumb">\n            <img src="<%= item.img_url %>">\n            <p class="center tips">失效</p>\n        </div>\n        <div class="detail">\n            <div class="clearfix detail-row">\n                <div class="right-col price c-gray-dark">\n                    ￥<span><%= parseFloat(item.price/100, 10).toFixed(2) %></span>\n                </div>\n                <div class="left-col">\n                    <a href="<%= _global.url.wap + \'/showcase/goods?alias=\' + item.alias %>">\n                        <h3 class="l2-ellipsis c-gray-dark"><%= item.title %></h3>\n                    </a>\n                </div>\n            </div>\n\n            <div class="clearfix detail-row">\n                <div class="right-col">\n                    <p class="num c-gray-dark">×<span class="num-txt"><%= item.num %></span></p>\n                </div>\n                <div class="left-col">\n                    <p class="c-gray-dark ellipsis">\n                        <%= getSkuStr(item.sku) %>\n                    </p>\n                </div>\n            </div>\n\n            <div class="clearfix detail-row">\n                <div class="left-col">\n                    <p class="c-orange"><%= item.unavailable_desc %></p>\n                </div>\n            </div>\n        </div>\n    </div>\n    <% }) %>\n</div>\n'}),define("wap/trade/new_order/components/invalid_goods_list/views/pop_detail",["require","text!../templates/pop_detail.html"],function(e){var t=e("text!../templates/pop_detail.html"),s=_.template(t);return Backbone.View.extend({initialize:function(e){e=e||{},this.items=e.items||[]},render:function(){return this.$el.html(s({items:this.items||[],getSkuStr:this.getSkuStr})),this},getSkuStr:function(e){var t="";if(e){var s=[];_.each(e,function(e){e.v&&s.push(e.v)}),t=s.join(", ")}return t}})}),define("wap/trade/new_order/components/invalid_goods_list/index",["require","zenjs/util/url_helper","text!./templates/panel.html","bower_components/pop/popup","./views/pop_detail"],function(e){var t=e("zenjs/util/url_helper"),s=e("text!./templates/panel.html"),i=_.template(s),n=e("bower_components/pop/popup"),o=e("./views/pop_detail");return Backbone.View.extend({initialize:function(e){this.itemsCollection=e.items},events:{"click .js-detail":"onDetailClick"},render:function(){return 0==this.itemsCollection.length?void this.$el.addClass("hide"):(this.$el.removeClass("hide"),void this.$el.html(i({items:this.itemsCollection.toJSON()||[],URLHelper:t})))},onDetailClick:function(e){var t=this.itemsCollection.toJSON();new n({contentViewClass:o,contentViewOptions:{items:t}}).render().show()}})}),define("wap/trade/new_order/containers/invalid_goods_list/index",["require","../../models/invalid_goods_list","../../components/invalid_goods_list/index"],function(e){var t=(e("../../models/invalid_goods_list"),e("../../components/invalid_goods_list/index"));return Backbone.View.extend({initialize:function(e){this.orderModel=e.orderModel,this.initData(),this.initComponentsView(),this.initListener()},initData:function(){this.model=this.orderModel.get("invalid_goods_list")},initComponentsView:function(){this.invalidGoodsListView=new t({el:this.$el,items:this.model.get("items")})},initListener:function(){},render:function(){this.invalidGoodsListView.render()},queueWalk:function(){var e=new $.Deferred;return this.invalidGoodsListView.render(),e.resolve(),e.promise()}})}),define("wap/trade/new_order/reducers/address",["require"],function(e){return function(e,t,s){switch(e){case"change_address":s.set("express_type",t.logisticsWay),s.set("address",t.address),s.set("extra",t.extra);break;case"reset_address_extra_data":s.set("extra",t.extra);break;case"after_address_set":s.set("is_has_address",!0);break;case"clear_address_info":s.set("is_has_address",!1);break;case"before_address_change":s.set("is_complete_sync",!1),s.set("is_address_valid",!1);break;case"after_address_change":s.set("is_address_valid",!0);break;case"complete_address_sync":s.set("is_complete_sync",!0)}}}),define("wap/trade/new_order/reducers/goods_list",["require"],function(e){var t=function(e,t){var s=e.get("items");s.reset(t)},s=function(e,s){t(e,s.goods_list);var i=s.all_postage_info||{};e.set({postage_info:i.postage_items||[],delivery_desc:i.delivery_desc||[],shop_name:s.shop_name||"",store_name:s.store_name||"",postage:s.postage||0,item_pay:s.item_pay||0,decrease:s.decrease||0})};return function(e,t,i){switch(e){case"reset_goods_list":s(i,t);break;case"reset_goodslist_msg":i.set("msg",t.msg)}}}),define("wap/trade/new_order/reducers/coupon",["require"],function(e){return function(e,t,s){switch(e){case"reset_coupons_list":s.set("coupons",t.coupons);break;case"change_current_coupon":s.set("current_coupon",t.current_coupon||{})}}}),define("wap/trade/new_order/reducers/ecard",["require"],function(e){return function(e,t,s){switch(e){case"change_current_ecard":s.set({isUseEcard:t.isUseEcard,value:t.value});break;case"reset_ecard_data":s.refreshEcardData(t.order_price)}}}),define("wap/trade/new_order/reducers/invalid_goods_list",["require"],function(e){return function(e,t,s){
switch(e){case"reset_unavailable_goods_list":var i=s.get("items");i.reset(t.goods_list)}}}),define("wap/trade/new_order/reducers/pay_total",["require"],function(e){return function(e,t,s){switch(e){case"reset_pay_ways":s.set({payWays:t.payWays,innerPayWays:t.innerPayWays})}}}),define("wap/trade/new_order/reducers/send_message",["require"],function(e){return function(e,t,s){switch(e){case"change_sms_switch":s.set({sms_switch:t.sms_switch})}}}),define("wap/trade/new_order/reducers/order",["require"],function(e){return function(e,t,s){switch(e){case"set_pay_status":s.set({forbid_pay:t.forbid_pay,msg_data:t.msg_data||{}});break;case"reset_order_data":s.resetShowData();break;case"change_order_no":s.set("order_no",t.order_no)}}}),define("wap/trade/new_order/reducers/index",["require","./address","./goods_list","./coupon","./ecard","./invalid_goods_list","./pay_total","./send_message","./order"],function(e){var t=e("./address"),s=e("./goods_list"),i=e("./coupon"),n=e("./ecard"),o=e("./invalid_goods_list"),a=e("./pay_total"),r=e("./send_message"),d=e("./order"),c={address:t,goods_list:s,coupon:i,ecard:n,invalid_goods_list:o,pay_total:a,send_message:r};return function(e,t,s){_.each(c,function(i,n){try{i(e,t,s.get(n))}catch(o){}});try{d(e,t,s)}catch(i){}}}),define("zenjs/util/count_down",[],function(){function e(e){return 10>e?"0"+e:""+e}function t(t,s,i,n,o){var a=0,r=0,d=0,c=0,l=0,h="",p=new Date,u=t.getTime()-p.getTime();return 0>=u?(o.stop(),s({seconds:0,text:"00:00:000",hour:0,min:0,sec:0,msec:0,day:0},{day:e(0),hour:e(0),min:e(0),sec:e(0),msec:e(0)}),void i()):(u>=864e5&&(a=Math.floor(u/864e5),u-=864e5*a,h+=a+"天"),u>=36e5&&(r=Math.floor(u/36e5),u-=36e5*r,h+=r+"小时"),u>=6e4?(d=Math.floor(u/6e4)%60,c=Math.floor(u/1e3)%60,l=u%1e3):(d=0,c=Math.floor(u/1e3),l=u%1e3),10>d&&(h+="0"),h+=d+"分",10>c&&(h+="0"),h+=c+"秒",10>l?h+="00":100>l&&(h+="0"),"second"!=n&&(h+=l),void s({text:h,hour:r,min:d,sec:c,msec:l,day:a},{day:e(a),hour:e(r),min:e(d),sec:e(c),msec:e(l)}))}function s(){this.tid=null,this.startTime=null}var i=function(){};return s.prototype={run:function(e){function s(){d.tid=setTimeout(s,"second"==e.step?1e3:50),t(r,o,a,e.step,d)}this.startTime||(this.startTime=Date.now());var n=e.seconds||0,o=e.onTimeChange||i,a=e.onTimeChangeEnd||i;this.startTime+=1e3*n;var r=new Date(this.startTime),d=this;s()},stop:function(){clearTimeout(this.tid)}},s}),define("text!wap/trade/new_order/templates/time_count.html",[],function(){return"<% if (data.day) { %>\n    <%= dataStr.day %>天\n<% } %>\n<% if (data.hour) { %>\n    <%= dataStr.hour %>时\n<% } %>\n<%= dataStr.min %>分\n<%= dataStr.sec %>秒"}),require(["zenjs/util/args","wap/trade/new_order/models/order","wap/trade/new_order/queue","wap/trade/new_order/containers/address/index","wap/trade/new_order/containers/goods_list/index","wap/trade/new_order/containers/coupons/index","wap/trade/new_order/containers/point/index","wap/trade/new_order/containers/ecard/index","wap/trade/new_order/containers/send_message/index","wap/trade/new_order/containers/price_area/index","wap/trade/new_order/containers/pay/index","wap/trade/new_order/containers/pay_total/index","wap/trade/new_order/containers/invalid_goods_list/index","wap/trade/new_order/reducers/index","zenjs/util/count_down","text!wap/trade/new_order/templates/time_count.html"],function(e,t,s,i,n,o,a,r,d,c,l,h,p,u,m,f){Backbone.EventCenter=_.extend({},Backbone.Events);var g=window._global,w=Backbone.View.extend({initialize:function(e){this.queue=s;var l=window._global.kdt_id,w=window._global.ecard||{},v=window._global.points_data||{},y=1;"undefined"!=typeof window._global.sms_switch&&(y=window._global.sms_switch),this.model=new t({order_no:window._global.order_no,kdt_id:l,is_points:v.is_points&&v.available,order_state:window._global.order_state,order_type:window._global.order_type,account:(g.buyer||{}).phone||"",book_key:window._global.book_key||"",bill_cart:window._global.bill_cart||{},bill_data:window._global.bill_data||{}},{address:{isSelfFetch:window._global.is_self_fetch,isAddressRequired:window._global.address_required,currentAddress:window._global.express_address||{},defaultAddress:window._global.default_address||{}},goods_list:{shop_name:window._global.shop_item[0].shop_name||"",store_name:window._global.shop_item[0].store_name||"",items:window._global.shop_item[0].order_item_list||[],paymentData:window._global.shop_item[0].order_payment,all_postage_info:window._global.shop_item[0].postage_result,charge_price_change_result:window._global.shop_item[0].charge_price_change_result||{},msg:window._global.buyer_msg},coupons:{coupons:window._global.shop_item[0].charge_coupon,is_forbid_coupon:window._global.shop_item[0].forbid_coupon,current_coupon:{}},ecard:{availableMoney:w.available||0},send_message:{sms_switch:y},point:{points:window._global.points_data},invalid_goods_list:{items:window._global.shop_item[0].unavailable_item_list||[]},pay_total:{payWays:window._global.payWays,innerPayWays:window._global.innerPayWays}});var C=$("#js-logistics-container");this.expressWaysView=new i({orderModel:this.model,el:C}),this.queue.add("address",this.expressWaysView),this.goodsListView=new n({orderModel:this.model,el:this.$(".js-goods-list-container"),team_certificate_gf:window._global.team_certificate_gf}),this.queue.add("goods_list",this.goodsListView),this.couponView=new o({orderModel:this.model,shopItem:window._global.shop_item,el:$(".js-used-coupon")}),this.queue.add("coupons",this.couponView),this.pointView=new a({orderModel:this.model,el:$(".js-point-panel"),points:window._global.points_data}),this.ecardView=new r({orderModel:this.model,el:$(".js-ecard-panel"),ecard:g.ecard||{}}),this.queue.add("ecard",this.ecardView),this.sendMessageView=new d({orderModel:this.model,el:$(".js-send-message")}),this.queue.add("send_message",this.sendMessageView),this.priceAreaView=new c({orderModel:this.model,el:$(".js-order-total")}),this.queue.add("price_area",this.priceAreaView),this.payTotalView=new h({orderModel:this.model,el:$(".js-order-total-pay"),onValidOrderDataError:_(this.onValidOrderDataError).bind(this)}),this.queue.add("pay",this.payTotalView),this.invalidGoodsListView=new p({el:this.$(".js-invalid-goods"),orderModel:this.model}),this.queue.add("invalid_goods_list",this.invalidGoodsListView);var b=this.$(".js-time");if(b.length>0){var x=b.data("seconds"),k=_.template(f);b.removeClass("hide"),(new m).run({seconds:x,step:"second",onTimeChange:function(e,t){b.html(k({data:e,dataStr:t}))},onTimeChangeEnd:function(){window.location.reload()}})}Backbone.EventCenter.on("order_render",_(function(e){this.queue.trigger(e)}).bind(this)),Backbone.EventCenter.on("order_change",_(function(e){u(e.type,e.data,this.model)}).bind(this)),Backbone.EventCenter.on("order:hidePayContainer",_(this.hideContainer).bind(this)),Backbone.EventCenter.on("order:shopPayContainer",_(this.showContainer).bind(this)),Backbone.EventCenter.on("order:prepare_order_data",_(function(){this.expressWaysView.prepareOrderData(),this.goodsListView.prepareOrderData()}).bind(this)),Backbone.EventCenter.on("order:prepare_pay_data",_(function(){}).bind(this))},render:function(){return this.expressWaysView.render(),this.goodsListView.render(),this.couponView.render(),this.pointView.render(),this.ecardView.render(),this.sendMessageView.render(),this.priceAreaView.render(),this.payTotalView.render(),this.invalidGoodsListView.render(),this.queue.trigger(),this},onValidOrderDataError:function(e){"goods_list"==e.type&&this.goodsListView.showErrorTips(e.data),"pay_total"==e.type&&this.payTotalView.showErrorTips(e.data)},hideContainer:function(){$("body").removeClass("body-fixed-bottom"),this.goodsListView.hidePostageInfo(),this.payTotalView.hideContainer()},showContainer:function(){$("body").addClass("body-fixed-bottom"),this.payTotalView.showContainer()}});window.confirmView=new w({el:$("body")}).render()}),define("main",function(){});